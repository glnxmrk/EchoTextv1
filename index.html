<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EchoText: Where TEXT is ECHOED as Voice</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3498db',
            secondary: '#2c3e50',
            success: '#2ecc71',
            warning: '#f39c12',
            danger: '#e74c3c',
            light: '#ecf0f1',
          },
        },
      },
    }
  </script>
  <!-- React Libraries -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel Compiler -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* All previous styles remain the same */
    /* Simple animation for modal */
    @keyframes fade-in-down {
      0% {
        opacity: 0;
        transform: translateY(-20px);
      }

      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in-down {
      animation: fade-in-down 0.3s ease-out;
    }

    /* Highlight current word being spoken */
    .current-word {
      background-color: #3498db;
      color: white;
      border-radius: 3px;
      padding: 1px 2px;
    }

    /* Clickable word styling */
    .passage-word {
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 3px;
      transition: all 0.2s ease;
    }

    .passage-word:hover {
      background-color: #e1f0fa;
      border-bottom: 2px solid #3498db;
    }

    /* Recording animation */
    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }

      100% {
        opacity: 1;
      }
    }

    .recording-pulse {
      animation: pulse 1.5s infinite;
    }

    /* Editable miscue styling */
    .editable-miscue {
      border: 1px dashed #ccc;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .editable-miscue:hover {
      border-color: #3498db;
      background-color: #f8f9fa;
    }

    .editable-miscue.editing {
      border: 2px solid #3498db;
      background-color: #f0f7ff;
    }

    /* Reading Drill specific styles */
    .drill-card {
      transition: all 0.3s ease;
    }

    .drill-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .sound-button {
      transition: all 0.2s ease;
    }

    .sound-button:hover {
      transform: scale(1.05);
    }

    .sound-button:active {
      transform: scale(0.95);
    }

    .letter-tile {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 80px;
      height: 80px;
      margin: 5px;
      font-size: 24px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .letter-tile:hover {
      transform: scale(1.1);
    }

    .word-tile {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 15px;
      margin: 5px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .word-tile:hover {
      transform: scale(1.05);
    }

    .blending-box {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 80px;
      height: 60px;
      margin: 5px;
      padding: 0 15px;
      font-size: 20px;
      font-weight: bold;
      border-radius: 8px;
      background-color: #f8f9fa;
      border: 2px dashed #dee2e6;
    }

    .active-drill {
      border-left: 4px solid #3498db;
      background-color: #f0f7ff;
    }

    /* Voice selection styles */
    .voice-option {
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .voice-option:hover {
      border-color: #3498db;
      background-color: #f0f7ff;
    }

    .voice-option.selected {
      border-color: #3498db;
      background-color: #e1f0fa;
    }

    .voice-preview {
      background-color: #f8f9fa;
      border-radius: 6px;
      padding: 8px 12px;
      margin-top: 8px;
      font-size: 0.875rem;
      color: #4a5568;
    }

    /* Letter case toggle */
    .case-toggle {
      display: inline-flex;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #d1d5db;
    }

    .case-toggle button {
      padding: 6px 12px;
      background-color: #f9fafb;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .case-toggle button.active {
      background-color: #3498db;
      color: white;
    }

    .case-toggle button:not(.active):hover {
      background-color: #e5e7eb;
    }

    /* Collapsible styles */
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .collapsible-content.open {
      max-height: 500px;
    }

    /* Enhanced Login Modal Styles */
    .login-gradient {
      background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
    }

    .login-logo {
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
    }

    .password-input-container {
      position: relative;
    }

    .password-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: #6b7280;
    }

    .password-toggle:hover {
      color: #374151;
    }

    /* NEW: Difficult words styling */
    .difficult-word {
      background-color: #fff3cd;
      border-bottom: 2px dashed #ffc107;
      cursor: help;
      position: relative;
    }

    .difficult-word:hover {
      background-color: #ffeaa7;
    }

    .word-definition {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #2c3e50;
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 0.875rem;
      white-space: nowrap;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 5px;
    }

    .word-definition::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 5px;
      border-style: solid;
      border-color: #2c3e50 transparent transparent transparent;
    }

    /* NEW: Teacher Name Button Gradient */
    .teacher-name-gradient {
      background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
      color: white;
      border: none;
      transition: all 0.3s ease;
    }

    .teacher-name-gradient:hover {
      background: linear-gradient(135deg, #2980b9 0%, #1a252f 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* NEW: Teacher Name Modal Gradient */
    .teacher-modal-gradient {
      background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
      color: white;
    }

    /* NEW: Bar graph styles */
    .bar-graph {
      display: flex;
      align-items: flex-end;
      height: 200px;
      padding: 10px;
      border-bottom: 1px solid #e2e8f0;
      border-left: 1px solid #e2e8f0;
    }

    .bar {
      flex: 1;
      margin: 0 2px;
      background: linear-gradient(to top, #3498db, #2c3e50);
      border-radius: 4px 4px 0 0;
      position: relative;
      transition: all 0.3s ease;
    }

    .bar:hover {
      opacity: 0.8;
      transform: scale(1.05);
    }

    .bar-label {
      position: absolute;
      bottom: -25px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 0.75rem;
      color: #4a5568;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .bar-value {
      position: absolute;
      top: -25px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 0.75rem;
      font-weight: bold;
      color: #2c3e50;
    }

    /* NEW: Fixed header and sidebar styles */
    .fixed-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .fixed-sidebar {
      position: fixed;
      top: 60px;
      /* Height of header */
      left: 0;
      bottom: 0;
      width: 16rem;
      /* w-64 */
      z-index: 900;
      overflow-y: auto;
    }

    .main-content {
      margin-left: 16rem;
      /* w-64 */
      margin-top: 60px;
      /* Height of header */
      min-height: calc(100vh - 60px);
    }

    /* NEW: Modal gradient styles */
    .modal-gradient-header {
      background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
      color: white;
    }

    /* NEW: Login Page Styles */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
      padding-top: 40px;
    }

    .login-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 500px;
      overflow: hidden;
    }

    .login-header {
      background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
      color: white;
      padding: 1rem;
      text-align: center;
    }

    .login-body {
      padding: 2rem;
    }

    .form-toggle {
      display: flex;
      margin-bottom: 1.5rem;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e2e8f0;
    }

    .form-toggle button {
      flex: 1;
      padding: 0.75rem;
      background: white;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .form-toggle button.active {
      background: #3498db;
      color: white;
    }

    .form-toggle button:not(.active):hover {
      background: #f8f9fa;
    }

    /* NEW: Vocabulary practice styles */
    .vocab-card {
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .vocab-card.selected {
      border-color: #3498db;
      transform: scale(1.02);
    }

    .vocab-card.correct {
      border-color: #2ecc71;
      background-color: #e8f8f1;
    }

    .vocab-card.incorrect {
      border-color: #e74c3c;
      background-color: #fdedec;
    }

    .vocab-card.reveal-correct {
      border-color: #2ecc71;
    }

    /* NEW: Prosody practice styles */
    .prosody-score-card {
      transition: all 0.3s ease;
    }

    .prosody-score-card:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .progress-ring {
      transform: rotate(-90deg);
    }

    .progress-ring__circle {
      transition: stroke-dashoffset 0.5s;
    }

    .recording-dot {
      width: 12px;
      height: 12px;
      background-color: #e74c3c;
      border-radius: 50%;
    }
  </style>
</head>

<body class="bg-gray-100 font-sans">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, useCallback, useContext, StrictMode } = React;

    // NEW: Storage Context for File System Access API
    const StorageContext = React.createContext(null);

    const StorageProvider = ({ children }) => {
      // "memory" database for file mode
      const [data, setData] = useState({});
      const [fileHandle, setFileHandle] = useState(null);
      const [isFileSystemMode, setIsFileSystemMode] = useState(false);
      const [isLoading, setIsLoading] = useState(false);
      const [lastSaved, setLastSaved] = useState(null);

      // Helper to read/write JSON
      const parseJson = (str) => {
        try { return JSON.parse(str); } catch (e) { return {}; }
      };

      const openFile = async () => {
        try {
          const [handle] = await window.showOpenFilePicker({
            types: [{ description: 'JSON Database', accept: { 'application/json': ['.json'] } }],
          });
          const file = await handle.getFile();
          const text = await file.text();
          const json = parseJson(text);
          setData(json);
          setFileHandle(handle);
          setIsFileSystemMode(true);
        } catch (err) {
          console.error("Error opening file:", err);
          // Don't change mode if cancelled or error
        }
      };

      const saveFile = async () => {
        if (!fileHandle) return saveFileAs();
        try {
          setIsLoading(true);
          const writable = await fileHandle.createWritable();
          await writable.write(JSON.stringify(data, null, 2));
          await writable.close();
          setLastSaved(new Date());
        } catch (err) {
          console.error("Error saving:", err);
        } finally {
          setIsLoading(false);
        }
      };

      const saveFileAs = async () => {
        try {
          const handle = await window.showSaveFilePicker({
            suggestedName: 'echotext_data.json',
            types: [{ description: 'JSON Database', accept: { 'application/json': ['.json'] } }],
          });
          setFileHandle(handle); // Set handle first
          setIsFileSystemMode(true);

          // Write current state immediately
          const writable = await handle.createWritable();
          await writable.write(JSON.stringify(data, null, 2));
          await writable.close();
          setLastSaved(new Date());
        } catch (err) {
          console.error("Error saving as:", err);
        }
      };

      const refreshData = (newData) => {
        setData(newData);
      };

      // Auto-save effect
      useEffect(() => {
        if (isFileSystemMode && fileHandle) {
          const timer = setTimeout(() => {
            // We need to capture the current 'data' here. 
            // Since 'data' is in dependency, this effect runs on every change.
            // We can't call 'saveFile' directly if it depends on closure?
            // Actually saveFile uses 'data' from state which is closed over in the function creation?
            // No, saveFile needs to use the latest data. 
            // Let's rely on the fact that this effect runs on data change, so we can just write 'data'.

            const write = async () => {
              try {
                // Simple write
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(data, null, 2));
                await writable.close();
                setLastSaved(new Date());
              } catch (e) { console.error("Auto-save failed", e); }
            };
            write();
          }, 2000); // 2 second debounce
          return () => clearTimeout(timer);
        }
      }, [data, isFileSystemMode, fileHandle]);

      const updateContextValue = (key, newValue) => {
        if (isFileSystemMode) {
          setData(prev => ({ ...prev, [key]: newValue }));
        } else {
          try {
            window.localStorage.setItem(key, JSON.stringify(newValue));
            // Force update for local storage? 
            // For now, simple localStorage updates don't sync across hooks via context, matching original behavior.
          } catch (e) { console.error(e); }
        }
      };

      return (
        <StorageContext.Provider value={{
          isFileSystemMode,
          openFile,
          saveFile,
          saveFileAs,
          data,
          updateContextValue,
          lastSaved,
          isLoading,
          refreshData
        }}>
          {children}
        </StorageContext.Provider>
      );
    };

    const useStorage = () => useContext(StorageContext);

    // NEW: Storage Controls Component
    const StorageControls = () => {
      const { isFileSystemMode, openFile, saveFileAs, lastSaved, isLoading, fileHandle } = useStorage();

      return (
        <div className="flex items-center gap-2 p-2 bg-gray-50 rounded-md border text-sm">
          <div className="flex items-center gap-2">
            <span className={`w-3 h-3 rounded-full ${isFileSystemMode ? 'bg-green-500' : 'bg-yellow-500'}`}></span>
            <span className="font-medium text-gray-700">
              {isFileSystemMode ? 'File Storage' : 'Browser Storage'}
            </span>
          </div>
          <div className="h-4 w-px bg-gray-300 mx-2"></div>
          <button onClick={openFile} className="px-2 py-1 bg-white border rounded hover:bg-gray-100 flex items-center gap-1">
            ðŸ“‚ Open
          </button>
          <button onClick={saveFileAs} className="px-2 py-1 bg-white border rounded hover:bg-gray-100 flex items-center gap-1">
            ðŸ’¾ Save As
          </button>
          {isFileSystemMode && (
            <span className="text-xs text-gray-500 ml-2">
              {isLoading ? 'Saving...' : lastSaved ? `Saved ${lastSaved.toLocaleTimeString()}` : ''}
            </span>
          )}
        </div>
      );
    };

    // NEW: Authentication hook
    const useAuth = () => {
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [currentUser, setCurrentUser] = useState(null);
      const [users, setUsers] = useLocalStorage('echoText-users', {});

      const login = (username, password) => {
        const user = users[username];
        if (user && user.password === password) {
          setIsLoggedIn(true);
          setCurrentUser(user);
          return true;
        }
        return false;
      };

      const createAccount = (username, password, secretCode) => {
        if (secretCode !== 'ADMIN-ET-2025!') {
          return { success: false, message: 'Invalid secret code. Account not created.' };
        }

        if (users[username]) {
          return { success: false, message: 'Username already exists.' };
        }

        const newUser = {
          username,
          password,
          createdAt: new Date().toISOString()
        };

        setUsers(prev => ({
          ...prev,
          [username]: newUser
        }));

        setIsLoggedIn(true);
        setCurrentUser(newUser);

        return { success: true, message: 'Account created successfully!' };
      };

      const logout = () => {
        setIsLoggedIn(false);
        setCurrentUser(null);
      };

      return {
        isLoggedIn,
        currentUser,
        login,
        createAccount,
        logout
      };
    };

    // From types.ts (converted to JS object)
    const Module = {
      Dashboard: 'dashboard',
      StudentManagement: 'student-management',
      Attendance: 'attendance',
      ReadingAssessment: 'reading-assessment',
      Comprehension: 'comprehension',
      Results: 'results',
      Guidelines: 'guidelines',
      Vocabulary: 'vocabulary', // NEW: Added Vocabulary module
      ReadingDrill: 'reading-drill', // NEW: Added Reading Drill module
      Prosody: 'prosody', // NEW: Added Prosody module
    };

    // From constants.ts
    const sampleStudents = [
      { id: 1, firstName: 'John', lastName: 'Doe', gradeLevel: '3', section: 'A' },
      { id: 2, firstName: 'Jane', lastName: 'Smith', gradeLevel: '4', section: 'B' },
      { id: 3, firstName: 'Michael', lastName: 'Johnson', gradeLevel: '5', section: 'A' }
    ];
    const sampleAttendance = {};
    const sampleAssessments = {};

    // REMOVED: Sample passages have been removed to allow teachers to add their own
    const samplePassages = {
      // Passages will be added by teachers through the interface
      // Passages can be added by teachers through the interface
      1: {
        title: 'The Helpful Ant',
        content: 'One hot day, an ant was searching for some water. After walking around for some time, she came to a spring. To reach the spring, she had to climb up a blade of grass. While making her way up, she slipped and fell into the water. A dove sitting on a nearby tree saw her. Seeing that the ant was in trouble, the dove quickly plucked off a leaf and dropped it into the water near the struggling ant. The ant moved towards the leaf and climbed up onto it. Soon, it carried her safely to dry ground. Just at that time, a hunter nearby was throwing out his net towards the dove, hoping to trap it. Guessing what he was about to do, the ant quickly bit him on the heel. Feeling the pain, the hunter dropped his net. The dove was quick to fly away to safety.',
        wordCount: 140,
        quiz: []
      }
    };

    // NEW: Default difficult words for each passage
    const defaultDifficultWords = {
      // Difficult words will be added by teachers for each passage
    };

    // UPDATED: Enhanced Reading Drill Data with lowercase letters and improved pronunciation
    const defaultDrillData = {
      letterSounds: {
        enabled: true,
        letters: [
          { letter: 'A', lowercase: 'a', sound: '/a/', example: 'apple', emphasis: 'short vowel sound', pronunciation: 'Pronounced as "ah" like in "apple"' },
          { letter: 'B', lowercase: 'b', sound: '/b/', example: 'ball', emphasis: 'voiced bilabial stop', pronunciation: 'Pronounced with lips together, voiced "buh" sound' },
          { letter: 'C', lowercase: 'c', sound: '/k/', example: 'cat', emphasis: 'hard c sound', pronunciation: 'Pronounced as "kuh" like in "cat"' },
          { letter: 'D', lowercase: 'd', sound: '/d/', example: 'dog', emphasis: 'voiced alveolar stop', pronunciation: 'Pronounced with tongue on ridge, voiced "duh" sound' },
          { letter: 'E', lowercase: 'e', sound: '/e/', example: 'egg', emphasis: 'short vowel sound', pronunciation: 'Pronounced as "eh" like in "egg"' },
          { letter: 'F', lowercase: 'f', sound: '/f/', example: 'fish', emphasis: 'voiceless labiodental fricative', pronunciation: 'Pronounced with top teeth on bottom lip, "fuh" sound' },
          { letter: 'G', lowercase: 'g', sound: '/g/', example: 'goat', emphasis: 'hard g sound', pronunciation: 'Pronounced as "guh" like in "goat"' },
          { letter: 'H', lowercase: 'h', sound: '/h/', example: 'hat', emphasis: 'voiceless glottal fricative', pronunciation: 'Pronounced with breath, "huh" sound' },
          { letter: 'I', lowercase: 'i', sound: '/i/', example: 'igloo', emphasis: 'short vowel sound', pronunciation: 'Pronounced as "ih" like in "igloo"' },
          { letter: 'J', lowercase: 'j', sound: '/j/', example: 'jam', emphasis: 'voiced palato-alveolar affricate', pronunciation: 'Pronounced as "juh" like in "jam"' },
          { letter: 'K', lowercase: 'k', sound: '/k/', example: 'kite', emphasis: 'voiceless velar stop', pronunciation: 'Pronounced as "kuh" like in "kite"' },
          { letter: 'L', lowercase: 'l', sound: '/l/', example: 'lion', emphasis: 'voiced alveolar lateral approximant', pronunciation: 'Pronounced with tongue up, "luh" sound' },
          { letter: 'M', lowercase: 'm', sound: '/m/', example: 'monkey', emphasis: 'voiced bilabial nasal', pronunciation: 'Pronounced with lips together, "muh" sound' },
          { letter: 'N', lowercase: 'n', sound: '/n/', example: 'nest', emphasis: 'voiced alveolar nasal', pronunciation: 'Pronounced with tongue on ridge, "nuh" sound' },
          { letter: 'O', lowercase: 'o', sound: '/o/', example: 'octopus', emphasis: 'short vowel sound', pronunciation: 'Pronounced as "ah" like in "octopus"' },
          { letter: 'P', lowercase: 'p', sound: '/p/', example: 'pig', emphasis: 'voiceless bilabial stop', pronunciation: 'Pronounced with lips together, "puh" sound' },
          { letter: 'Q', lowercase: 'q', sound: '/q/', example: 'queen', emphasis: 'voiceless labial-velar stop', pronunciation: 'Pronounced as "kwuh" like in "queen"' },
          { letter: 'R', lowercase: 'r', sound: '/r/', example: 'rabbit', emphasis: 'voiced alveolar approximant', pronunciation: 'Pronounced with tongue curled back, "ruh" sound' },
          { letter: 'S', lowercase: 's', sound: '/s/', example: 'sun', emphasis: 'voiceless alveolar fricative', pronunciation: 'Pronounced as "sss" like in "sun"' },
          { letter: 'T', lowercase: 't', sound: '/t/', example: 'tiger', emphasis: 'voiceless alveolar stop', pronunciation: 'Pronounced with tongue on ridge, "tuh" sound' },
          { letter: 'U', lowercase: 'u', sound: '/u/', example: 'umbrella', emphasis: 'short vowel sound', pronunciation: 'Pronounced as "uh" like in "umbrella"' },
          { letter: 'V', lowercase: 'v', sound: '/v/', example: 'violin', emphasis: 'voiced labiodental fricative', pronunciation: 'Pronounced with top teeth on bottom lip, "vuh" sound' },
          { letter: 'W', lowercase: 'w', sound: '/w/', example: 'water', emphasis: 'voiced labial-velar approximant', pronunciation: 'Pronounced with rounded lips, "wuh" sound' },
          { letter: 'X', lowercase: 'x', sound: '/x/', example: 'fox', emphasis: 'voiceless velar stop + voiceless alveolar fricative', pronunciation: 'Pronounced as "ks" like in "fox"' },
          { letter: 'Y', lowercase: 'y', sound: '/y/', example: 'yoyo', emphasis: 'voiced palatal approximant', pronunciation: 'Pronounced as "yuh" like in "yoyo"' },
          { letter: 'Z', lowercase: 'z', sound: '/z/', example: 'zebra', emphasis: 'voiced alveolar fricative', pronunciation: 'Pronounced as "zzz" like in "zebra"' }
        ]
      },
      cvcWords: {
        enabled: true,
        words: [
          { word: 'cat', pattern: 'CVC', sound: 'kÄƒt' },
          { word: 'dog', pattern: 'CVC', sound: 'dÅg' },
          { word: 'pig', pattern: 'CVC', sound: 'pÄ­g' },
          { word: 'hat', pattern: 'CVC', sound: 'hÄƒt' },
          { word: 'pen', pattern: 'CVC', sound: 'pÄ•n' },
          { word: 'sun', pattern: 'CVC', sound: 'sÅ­n' },
          { word: 'bed', pattern: 'CVC', sound: 'bÄ•d' },
          { word: 'cup', pattern: 'CVC', sound: 'kÅ­p' },
          { word: 'fan', pattern: 'CVC', sound: 'fÄƒn' },
          { word: 'leg', pattern: 'CVC', sound: 'lÄ•g' },
          { word: 'mop', pattern: 'CVC', sound: 'mÅp' },
          { word: 'rat', pattern: 'CVC', sound: 'rÄƒt' }
        ]
      },
      fullerMethod: {
        enabled: true,
        wordFamilies: [
          { family: '-at', words: ['cat', 'hat', 'bat', 'mat', 'rat'] },
          { family: '-an', words: ['can', 'fan', 'man', 'pan', 'van'] },
          { family: '-ap', words: ['cap', 'lap', 'map', 'nap', 'tap'] },
          { family: '-en', words: ['hen', 'men', 'pen', 'ten', 'den'] },
          { family: '-et', words: ['bet', 'get', 'jet', 'net', 'pet'] },
          { family: '-ig', words: ['big', 'dig', 'fig', 'pig', 'wig'] },
          { family: '-in', words: ['bin', 'fin', 'pin', 'tin', 'win'] },
          { family: '-op', words: ['cop', 'hop', 'mop', 'pop', 'top'] },
          { family: '-ot', words: ['cot', 'dot', 'hot', 'pot', 'rot'] },
          { family: '-ug', words: ['bug', 'dug', 'hug', 'jug', 'rug'] }
        ]
      },
      soundBlending: {
        enabled: true,
        exercises: [
          { sounds: ['c', 'a', 't'], word: 'cat' },
          { sounds: ['d', 'o', 'g'], word: 'dog' },
          { sounds: ['p', 'i', 'g'], word: 'pig' },
          { sounds: ['h', 'a', 't'], word: 'hat' },
          { sounds: ['b', 'e', 'd'], word: 'bed' },
          { sounds: ['s', 'u', 'n'], word: 'sun' },
          { sounds: ['m', 'o', 'p'], word: 'mop' },
          { sounds: ['r', 'a', 't'], word: 'rat' },
          { sounds: ['f', 'a', 'n'], word: 'fan' },
          { sounds: ['l', 'e', 'g'], word: 'leg' }
        ]
      }
    };

    // From hooks/useLocalStorage.ts
    const useLocalStorage = (key, initialValue) => {
      const { data, updateContextValue, isFileSystemMode } = useStorage();

      // Initialize state
      const [storedValue, setStoredValue] = useState(() => {
        if (isFileSystemMode) {
          return data[key] !== undefined ? data[key] : initialValue;
        }
        if (typeof window === "undefined") {
          return initialValue;
        }
        try {
          const item = window.localStorage.getItem(key);
          return item ? JSON.parse(item) : initialValue;
        } catch (error) {
          console.error(error);
          return initialValue;
        }
      });

      // Sync with context data when in FileSystem mode
      useEffect(() => {
        if (isFileSystemMode) {
          const val = data[key];
          if (val !== undefined && JSON.stringify(val) !== JSON.stringify(storedValue)) {
            setStoredValue(val);
          }
        }
      }, [data, key, isFileSystemMode]); // removed storedValue from dependency to avoid loop

      const setValue = (value) => {
        try {
          const valueToStore = value instanceof Function ? value(storedValue) : value;
          setStoredValue(valueToStore);
          updateContextValue(key, valueToStore);
        } catch (error) {
          console.error(error);
        }
      };

      return [storedValue, setValue];
    }

    // NEW: Custom hook to store teacher name
    const useTeacherName = () => {
      const [teacherName, setTeacherName] = useLocalStorage('echoText-teacherName', '');

      return [teacherName, setTeacherName];
    }

    // NEW: Custom hook to store difficult words
    const useDifficultWords = () => {
      const [difficultWords, setDifficultWords] = useLocalStorage('echoText-difficultWords', defaultDifficultWords);

      const addDifficultWord = (passageId, word, definition) => {
        setDifficultWords(prev => {
          const passageWords = prev[passageId] || [];
          // Check if word already exists
          const existingIndex = passageWords.findIndex(w => w.word.toLowerCase() === word.toLowerCase());

          if (existingIndex >= 0) {
            // Update existing word
            const updatedWords = [...passageWords];
            updatedWords[existingIndex] = { word, definition };
            return {
              ...prev,
              [passageId]: updatedWords
            };
          } else {
            // Add new word
            return {
              ...prev,
              [passageId]: [...passageWords, { word, definition }]
            };
          }
        });
      };

      const removeDifficultWord = (passageId, word) => {
        setDifficultWords(prev => {
          const passageWords = prev[passageId] || [];
          return {
            ...prev,
            [passageId]: passageWords.filter(w => w.word.toLowerCase() !== word.toLowerCase())
          };
        });
      };

      const getDifficultWordsForPassage = (passageId) => {
        return difficultWords[passageId] || [];
      };

      const updateDifficultWord = (passageId, oldWord, newWord, newDefinition) => {
        setDifficultWords(prev => {
          const passageWords = prev[passageId] || [];
          const updatedWords = passageWords.map(w =>
            w.word.toLowerCase() === oldWord.toLowerCase()
              ? { word: newWord, definition: newDefinition }
              : w
          );
          return {
            ...prev,
            [passageId]: updatedWords
          };
        });
      };

      return {
        difficultWords,
        addDifficultWord,
        removeDifficultWord,
        getDifficultWordsForPassage,
        updateDifficultWord
      };
    };

    // NEW: Custom hook for vocabulary list
    const useVocabularyList = () => {
      const [vocabulary, setVocabulary] = useLocalStorage('echoText-vocabulary', [
        { id: 1, word: 'diligent', definition: 'Showing care and conscientiousness in one\'s work or duties.' },
        { id: 2, word: 'ephemeral', definition: 'Lasting for a very short time.' },
        { id: 3, word: 'benevolent', definition: 'Well meaning and kindly.' },
        { id: 4, word: 'ubiquitous', definition: 'Present, appearing, or found everywhere.' }
      ]);

      const addWord = (word, definition) => {
        const newWord = { id: Date.now(), word, definition };
        setVocabulary(prev => [...prev, newWord]);
      };

      const updateWord = (id, updatedWord, updatedDefinition) => {
        setVocabulary(prev => prev.map(item =>
          item.id === id ? { ...item, word: updatedWord, definition: updatedDefinition } : item
        ));
      };

      const deleteWord = (id) => {
        setVocabulary(prev => prev.filter(item => item.id !== id));
      };

      return {
        vocabulary,
        addWord,
        updateWord,
        deleteWord
      };
    };

    // NEW: Custom hook for student vocabulary progress
    const useVocabularyProgress = () => {
      const [progress, setProgress] = useLocalStorage('echoText-vocabularyProgress', {});
      // In a real app, you'd add functions to save and retrieve progress per student.
      return [progress, setProgress];
    };

    // NEW: Custom hook for prosody results
    const useProsodyStorage = () => {
      const [prosodyData, setProsodyData] = useLocalStorage('echoText-prosodyData', {});

      const saveProsodyResult = (studentId, passageId, result) => {
        const newEntry = {
          id: Date.now(),
          studentId,
          passageId,
          timestamp: new Date().toISOString(),
          result,
        };

        setProsodyData(prev => {
          const studentData = prev[studentId] || [];
          return {
            ...prev,
            [studentId]: [...studentData, newEntry]
          };
        });
        return newEntry.id;
      };

      return {
        prosodyData,
        saveProsodyResult,
      };
    };

    // FIXED: Custom hook to store miscue analysis data with update functionality
    const useMiscueStorage = () => {
      const [miscueData, setMiscueData] = useLocalStorage('echoText-miscueData', {});

      const saveMiscueAnalysis = (studentId, passageId, analysisResult, studentReading, passageText) => {
        const timestamp = new Date().toISOString();
        const newEntry = {
          id: Date.now(),
          studentId,
          passageId,
          timestamp,
          analysisResult,
          studentReading,
          passageText
        };

        setMiscueData(prev => {
          const studentData = prev[studentId] || [];
          return {
            ...prev,
            [studentId]: [...studentData, newEntry]
          };
        });

        return newEntry.id;
      };

      // FIXED: Added function to update miscue analysis
      const updateMiscueAnalysis = (studentId, analysisId, updatedAnalysis) => {
        setMiscueData(prev => {
          const studentData = prev[studentId] || [];
          const updatedData = studentData.map(item =>
            item.id === analysisId
              ? { ...item, analysisResult: updatedAnalysis }
              : item
          );
          return {
            ...prev,
            [studentId]: updatedData
          };
        });
      };

      const getMiscueDataByStudent = (studentId) => {
        return miscueData[studentId] || [];
      };

      const deleteMiscueAnalysis = (studentId, analysisId) => {
        setMiscueData(prev => {
          const studentData = prev[studentId] || [];
          return {
            ...prev,
            [studentId]: studentData.filter(item => item.id !== analysisId)
          };
        });
      };

      return {
        miscueData,
        saveMiscueAnalysis,
        updateMiscueAnalysis, // FIXED: Added this function
        getMiscueDataByStudent,
        deleteMiscueAnalysis
      };
    };

    // NEW: Custom hook for progress report settings
    const useProgressReportSettings = () => {
      const [settings, setSettings] = useLocalStorage('echoText-progressReportSettings', {
        totalWeeks: 8,
        reportPeriod: 'weeks' // 'weeks' or 'days'
      });

      const updateSettings = (newSettings) => {
        setSettings(prev => ({ ...prev, ...newSettings }));
      };

      return [settings, updateSettings];
    };

    // NEW: Custom hook for assessment settings
    const useAssessmentSettings = () => {
      const [settings, setSettings] = useLocalStorage('echoText-assessmentSettings', {
        totalWeeks: 8,
        reportPeriod: 'weeks' // 'weeks' or 'days'
      });

      const updateSettings = (newSettings) => {
        setSettings(prev => ({ ...prev, ...newSettings }));
      };

      return [settings, updateSettings];
    };

    // NEW: Custom hook for comprehension quiz results
    const useComprehensionResults = () => {
      const [results, setResults] = useLocalStorage('echoText-comprehensionResults', {});

      const saveResult = (studentId, quizData, score, answers) => {
        const timestamp = new Date().toISOString();
        const newResult = {
          id: Date.now(),
          studentId,
          timestamp,
          quizData,
          score,
          answers
        };

        setResults(prev => {
          const studentResults = prev[studentId] || [];
          return {
            ...prev,
            [studentId]: [...studentResults, newResult]
          };
        });

        return newResult.id;
      };

      const getResultsByStudent = (studentId) => {
        return results[studentId] || [];
      };

      const deleteResult = (studentId, resultId) => {
        setResults(prev => {
          const studentResults = prev[studentId] || [];
          return {
            ...prev,
            [studentId]: studentResults.filter(item => item.id !== resultId)
          };
        });
      };

      return {
        results,
        saveResult,
        getResultsByStudent,
        deleteResult
      };
    };

    // Enhanced useSpeechSynthesis hook with better voice selection
    const useSpeechSynthesis = () => {
      const [voices, setVoices] = useState([]);
      const [selectedVoice, setSelectedVoice] = useState(null);
      const [isSpeaking, setIsSpeaking] = useState(false);
      const [isSupported, setIsSupported] = useState(false);
      const [currentWordIndex, setCurrentWordIndex] = useState(-1);
      const [rate, setRate] = useState(0.8);
      const [pitch, setPitch] = useState(1);
      const [volume, setVolume] = useState(1);

      // Enhanced voice selection with preference for human-like voices
      const getPreferredVoices = (availableVoices) => {
        if (!availableVoices || availableVoices.length === 0) return [];

        // Sort voices by quality indicators - include English and Filipino voices
        return availableVoices
          .filter(voice => {
            // Filter out obviously robotic voices
            const name = voice.name.toLowerCase();
            return !name.includes('robotic') &&
              !name.includes('zira') && // Often robotic
              !name.includes('desktop') &&
              (voice.lang.startsWith('en') || voice.lang.startsWith('fil') || voice.lang.startsWith('tl')); // English and Filipino voices
          })
          .sort((a, b) => {
            // Prefer voices that sound more natural
            const aScore = getVoiceQualityScore(a);
            const bScore = getVoiceQualityScore(b);
            return bScore - aScore;
          });
      };

      const getVoiceQualityScore = (voice) => {
        let score = 0;
        const name = voice.name.toLowerCase();

        // Premium voices known to be natural/human-like with emotion
        const premiumVoices = ['samantha', 'karen', 'moira', 'tessa', 'victoria', 'sara',
          'alex', 'daniel', 'fiona', 'fred', 'kate', 'oliver',
          'serena', 'tom', 'veena', 'yuri', 'zuzana', 'lee',
          'laura', 'amy', 'eva', 'ava', 'lucy', 'olivia', 'sophia',
          'bella', 'grace', 'iris', 'nova', 'rosie', 'zoe',
          'andrew', 'benjamin', 'charles', 'david', 'james', 'john',
          'michael', 'robert', 'william', 'caleb', 'henry', 'liam',
          'ryan', 'nathan', 'brian', 'matthew', 'joseph', 'christopher'];

        if (premiumVoices.some(v => name.includes(v))) {
          score += 15;
        }

        // Filipino voices - give extra points
        if (voice.lang.startsWith('fil') || voice.lang.startsWith('tl')) {
          score += 12; // Extra bonus for Filipino language support
          if (name.includes('female') || name.includes('woman') || name.includes('ms') || name.includes('maria')) {
            score += 5;
          }
        }

        // Prefer female voices (often perceived as more natural for reading)
        if (voice.name.includes('Female') || name.includes('woman') ||
          premiumVoices.some(v => name.includes(v) && ['samantha', 'karen', 'moira', 'tessa', 'victoria', 'sara', 'fiona', 'kate', 'serena', 'veena', 'yuri', 'zuzana', 'laura', 'amy', 'eva', 'ava', 'lucy', 'olivia', 'sophia', 'bella', 'grace', 'iris', 'nova', 'rosie', 'zoe'].includes(v))) {
          score += 8;
        }

        // Prefer default voices
        if (voice.default) score += 5;

        // Prefer local voices over remote ones (usually better quality)
        if (voice.localService) score += 4;
        else score -= 1;

        // Lower score for obviously synthetic names
        if (name.includes('synthetic') || name.includes('robot') || name.includes('computer')) {
          score -= 10;
        }

        return score;
      };

      useEffect(() => {
        if (typeof window !== 'undefined' && 'speechSynthesis' in window) {
          setIsSupported(true);
          const handleVoicesChanged = () => {
            const availableVoices = window.speechSynthesis.getVoices();
            const preferredVoices = getPreferredVoices(availableVoices);
            setVoices(preferredVoices.length > 0 ? preferredVoices : availableVoices);

            if (preferredVoices.length > 0 && !selectedVoice) {
              // Select the highest quality voice by default
              setSelectedVoice(preferredVoices[0]);
            } else if (availableVoices.length > 0 && !selectedVoice) {
              // Fallback to any available voice
              setSelectedVoice(availableVoices[0]);
            }
          };

          window.speechSynthesis.addEventListener('voiceschanged', handleVoicesChanged);
          handleVoicesChanged();

          return () => {
            window.speechSynthesis.removeEventListener('voiceschanged', handleVoicesChanged);
            window.speechSynthesis.cancel();
          };
        }
      }, [selectedVoice]);

      const speak = useCallback((text, options = {}) => {
        if (!isSupported || !selectedVoice || !text) return;

        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.voice = selectedVoice;
        utterance.rate = options.rate || rate;
        utterance.pitch = options.pitch || pitch;
        utterance.volume = options.volume || volume;

        const wordBoundaries = [];
        const regex = /\S+/g;
        let match;
        while ((match = regex.exec(text)) !== null) {
          wordBoundaries.push(match.index);
        }

        utterance.onstart = () => {
          setIsSpeaking(true);
          setCurrentWordIndex(0);
        };
        utterance.onend = () => {
          setIsSpeaking(false);
          setCurrentWordIndex(-1);
        };
        utterance.onerror = (e) => {
          console.error("Speech synthesis error", e);
          setIsSpeaking(false);
          setCurrentWordIndex(-1);
        };
        utterance.onboundary = (event) => {
          if (event.name === 'word') {
            const charIndex = event.charIndex;
            let wordIndex = -1;
            for (let i = wordBoundaries.length - 1; i >= 0; i--) {
              if (charIndex >= wordBoundaries[i]) {
                wordIndex = i;
                break;
              }
            }
            setCurrentWordIndex(wordIndex);
          }
        };

        window.speechSynthesis.speak(utterance);
      }, [isSupported, selectedVoice, rate, pitch, volume]);

      const cancel = useCallback(() => {
        if (!isSupported) return;
        window.speechSynthesis.cancel();
        setIsSpeaking(false);
        setCurrentWordIndex(-1);
      }, [isSupported]);

      const previewVoice = useCallback((voice, text = "Hello! I'm a natural sounding voice for reading.") => {
        if (!isSupported || !voice) return;

        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.voice = voice;
        utterance.rate = 0.9; // Slightly slower for preview
        utterance.pitch = 1;
        utterance.volume = 1;

        window.speechSynthesis.speak(utterance);
      }, [isSupported]);

      return {
        voices,
        selectedVoice,
        setSelectedVoice,
        speak,
        cancel,
        isSpeaking,
        isSupported,
        currentWordIndex,
        rate,
        setRate,
        pitch,
        setPitch,
        volume,
        setVolume,
        previewVoice
      };
    };

    // NEW: Login Component
    const LoginPage = ({ onLogin, onCreateAccount }) => {
      const [isLogin, setIsLogin] = useState(true);
      const [rememberedUsername, setRememberedUsername] = useLocalStorage('echoText-rememberedUsername', '');
      const [formData, setFormData] = useState({
        username: rememberedUsername || '',
        password: '',
        confirmPassword: '',
        secretCode: ''
      });
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [showPassword, setShowPassword] = useState(false);
      const [showConfirmPassword, setShowConfirmPassword] = useState(false);
      const [showSecretCode, setShowSecretCode] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          if (isLogin) {
            const success = onLogin(formData.username, formData.password);
            if (!success) {
              setError('Invalid username or password');
            } else {
              setRememberedUsername(formData.username);
            }
          } else {
            if (formData.password !== formData.confirmPassword) {
              setError('Passwords do not match');
              setLoading(false);
              return;
            }
            const result = onCreateAccount(formData.username, formData.password, formData.secretCode);
            if (!result.success) {
              setError(result.message);
            } else {
              setRememberedUsername(formData.username);
            }
          }
        } catch (err) {
          setError('An error occurred. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      const handleInputChange = (field, value) => {
        setFormData(prev => ({
          ...prev,
          [field]: value
        }));
        setError('');
      };

      const toggleForm = () => {
        setIsLogin(!isLogin);
        setError('');
        setFormData({
          username: '',
          password: '',
          confirmPassword: '',
          secretCode: ''
        });
      };

      return (
        <div className="login-container">
          <div className="login-card">
            <div className="login-header">
              <div className="flex items-center justify-center gap-4 mb-2">
                <BookReaderIcon className="w-15 h-20 login-logo" />
                <h1 className="text-5xl font-bold">EchoText</h1>
              </div>
              <p className="text-blue-100 mb-3">Where TEXT is ECHOED as Voice</p>

              {/* NEW: Attribution text */}
              <div className="text-xs text-blue-100 text-center mt-4  pt-4 border-t border-blue-300/30">
                <p className="mb-0.75">This app was made possible through the efforts of</p>
                <p className="font-semibold">Rosavelia O. Jimenez and Glenn Mark S. Presores</p>
                <p className="text-xs mt-0.75">of San Jose Integrated School, Quezon I District, Division of Bukidnon</p>
              </div>
            </div>

            <div className="login-body">
              <div className="form-toggle">
                <button
                  className={isLogin ? 'active' : ''}
                  onClick={() => setIsLogin(true)}
                >
                  Login
                </button>
                <button
                  className={!isLogin ? 'active' : ''}
                  onClick={() => setIsLogin(false)}
                >
                  Create Account
                </button>
              </div>

              {error && (
                <div className="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-md">
                  {error}
                </div>
              )}

              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Username
                  </label>
                  <input
                    type="text"
                    value={formData.username}
                    onChange={(e) => handleInputChange('username', e.target.value)}
                    className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="Enter your username"
                    required
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Password
                  </label>
                  <div className="password-input-container">
                    <input
                      type={showPassword ? "text" : "password"}
                      value={formData.password}
                      onChange={(e) => handleInputChange('password', e.target.value)}
                      className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent"
                      placeholder="Enter your password"
                      required
                    />
                    <button
                      type="button"
                      className="password-toggle"
                      onClick={() => setShowPassword(!showPassword)}
                    >
                      {showPassword ? <EyeOffIcon className="w-5 h-5" /> : <EyeIcon className="w-5 h-5" />}
                    </button>
                  </div>
                </div>

                {!isLogin && (
                  <>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Confirm Password
                      </label>
                      <div className="password-input-container">
                        <input
                          type={showConfirmPassword ? "text" : "password"}
                          value={formData.confirmPassword}
                          onChange={(e) => handleInputChange('confirmPassword', e.target.value)}
                          className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent"
                          placeholder="Confirm your password"
                          required
                        />
                        <button
                          type="button"
                          className="password-toggle"
                          onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                        >
                          {showConfirmPassword ? <EyeOffIcon className="w-5 h-5" /> : <EyeIcon className="w-5 h-5" />}
                        </button>
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Secret Code
                      </label>
                      <div className="password-input-container">
                        <input
                          type={showSecretCode ? "text" : "password"}
                          value={formData.secretCode}
                          onChange={(e) => handleInputChange('secretCode', e.target.value)}
                          className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent"
                          placeholder="Enter secret code"
                          required
                        />
                        <button
                          type="button"
                          className="password-toggle"
                          onClick={() => setShowSecretCode(!showSecretCode)}
                        >
                          {showSecretCode ? <EyeOffIcon className="w-5 h-5" /> : <EyeIcon className="w-5 h-5" />}
                        </button>
                      </div>
                      <p className="text-xs text-gray-500 mt-1">
                        You must enter the correct secret code to create an account.
                      </p>
                    </div>
                  </>
                )}

                <button
                  type="submit"
                  disabled={loading}
                  className="w-full p-3 bg-primary text-white rounded-md hover:bg-blue-600 focus:ring-2 focus:ring-primary focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed login-gradient transition-colors duration-100"
                >
                  {loading ? 'Please wait...' : (isLogin ? 'Login' : 'Create Account')}
                </button>
              </form>

              <div className="mt-6 text-center">
                <p className="text-sm text-gray-600">
                  {isLogin ? "Don't have an account? " : "Already have an account? "}
                  <button
                    type="button"
                    onClick={toggleForm}
                    className="text-primary hover:text-blue-600 font-medium"
                  >
                    {isLogin ? 'Create Account' : 'Login'}
                  </button>
                </p>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Voice Selection Modal Component
    const VoiceSelectionModal = ({ isOpen, onClose, voices, selectedVoice, setSelectedVoice, previewVoice }) => {
      const [previewText, setPreviewText] = useState("Hello! I'm a natural sounding voice perfect for reading stories and educational content of EchoText.");

      const handleVoiceSelect = (voice) => {
        setSelectedVoice(voice);
      };

      const handlePreview = (voice) => {
        previewVoice(voice, previewText);
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Select Voice">
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Preview Text
              </label>
              <textarea
                value={previewText}
                onChange={(e) => setPreviewText(e.target.value)}
                className="w-full p-2 border border-gray-300 rounded-md"
                rows="2"
              />
            </div>

            <div className="max-h-96 overflow-y-auto">
              {voices.length === 0 ? (
                <div className="text-center py-8 text-gray-500">
                  No voices available. Please check your browser's text-to-speech settings.
                </div>
              ) : (
                voices.map((voice) => (
                  <div
                    key={voice.name}
                    className={`voice-option ${selectedVoice?.name === voice.name ? 'selected' : ''}`}
                    onClick={() => handleVoiceSelect(voice)}
                  >
                    <div className="flex justify-between items-center">
                      <div>
                        <h4 className="font-medium text-gray-800">{voice.name}</h4>
                        <p className="text-sm text-gray-600">
                          {voice.lang} â€¢ {voice.localService ? 'Local' : 'Remote'}
                        </p>
                      </div>
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          handlePreview(voice);
                        }}
                        className="px-3 py-1 text-sm bg-primary text-white rounded-md hover:bg-blue-600"
                      >
                        Preview
                      </button>
                    </div>
                    <div className="voice-preview">
                      <p className="text-xs">Click to select this voice</p>
                    </div>
                  </div>
                ))
              )}
            </div>

            <div className="flex justify-end gap-2 pt-4">
              <button
                onClick={onClose}
                className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300"
              >
                Close
              </button>
            </div>
          </div>
        </Modal>
      );
    };

    // NEW: Collapsible TTS Controls Component
    const CollapsibleTTSControls = ({
      voices,
      selectedVoice,
      setSelectedVoice,
      rate,
      setRate,
      pitch,
      setPitch,
      volume,
      setVolume,
      previewVoice,
      isSpeaking
    }) => {
      const [isVoiceModalOpen, setIsVoiceModalOpen] = useState(false);
      const [isOpen, setIsOpen] = useState(false);

      return (
        <div className="bg-white p-4 rounded-lg border border-gray-200 space-y-4">
          <button
            onClick={() => setIsOpen(!isOpen)}
            className="flex justify-between items-center w-full text-left"
          >
            <h3 className="text-lg font-semibold text-gray-800">Voice Settings</h3>
            <svg
              className={`w-5 h-5 transform transition-transform ${isOpen ? 'rotate-180' : ''}`}
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <div className={`collapsible-content ${isOpen ? 'open' : ''}`}>
            <div className="space-y-4 pt-2">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Selected Voice
                  </label>
                  <div className="flex gap-2">
                    <select
                      value={selectedVoice?.name || ''}
                      onChange={(e) => {
                        const voice = voices.find(v => v.name === e.target.value);
                        if (voice) setSelectedVoice(voice);
                      }}
                      className="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm"
                      disabled={isSpeaking}
                    >
                      {voices.map(voice => (
                        <option key={voice.name} value={voice.name}>
                          {voice.name} ({voice.lang})
                        </option>
                      ))}
                    </select>
                    <button
                      onClick={() => setIsVoiceModalOpen(true)}
                      className="px-3 py-2 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300"
                      disabled={isSpeaking}
                    >
                      Browse
                    </button>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Speech Rate: {rate.toFixed(1)}x
                  </label>
                  <input
                    type="range"
                    min="0.5"
                    max="2"
                    step="0.1"
                    value={rate}
                    onChange={(e) => setRate(parseFloat(e.target.value))}
                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                    disabled={isSpeaking}
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Pitch: {pitch.toFixed(1)}
                  </label>
                  <input
                    type="range"
                    min="0.5"
                    max="2"
                    step="0.1"
                    value={pitch}
                    onChange={(e) => setPitch(parseFloat(e.target.value))}
                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                    disabled={isSpeaking}
                  />
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Volume: {Math.round(volume * 100)}%
                  </label>
                  <input
                    type="range"
                    min="0"
                    max="1"
                    step="0.1"
                    value={volume}
                    onChange={(e) => setVolume(parseFloat(e.target.value))}
                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                    disabled={isSpeaking}
                  />
                </div>

                <div className="flex items-end">
                  <button
                    onClick={() => previewVoice(selectedVoice, "This is how your current voice settings sound.")}
                    disabled={isSpeaking || !selectedVoice}
                    className="w-full px-4 py-2 text-sm bg-primary text-white rounded-md hover:bg-blue-600 disabled:opacity-50"
                  >
                    Test Voice
                  </button>
                </div>
              </div>

              <VoiceSelectionModal
                isOpen={isVoiceModalOpen}
                onClose={() => setIsVoiceModalOpen(false)}
                voices={voices}
                selectedVoice={selectedVoice}
                setSelectedVoice={setSelectedVoice}
                previewVoice={previewVoice}
              />
            </div>
          </div>
        </div>
      );
    };

    // FIXED: Improved miscue analysis to properly handle insertions and repetitions
    const analyzeMiscuesWithGemini = async (passage, studentReading) => {
      return new Promise((resolve) => {
        setTimeout(() => {
          // Split into words, keeping original case and punctuation for display purposes.
          const passageWords = passage.split(/\s+/).filter(word => word.length > 0);
          const studentWords = studentReading.split(/\s+/).filter(word => word.length > 0);

          // Helper function to normalize words for comparison by removing punctuation and making them lowercase.
          const normalizeWord = (word) =>
            word ? word.toLowerCase().replace(/[.,!?"â€œâ€:;]/g, '') : '';

          const miscues = [];

          // Track positions in both arrays
          let pIndex = 0; // passage index
          let sIndex = 0; // student reading index

          // Track repetitions
          // const repetitionTracker = {}; // Repetition logic will be re-evaluated post-alignment.

          // --- NEW: Word-level Sequence Alignment using Dynamic Programming ---
          // This implements the Wagner-Fischer algorithm to find the Levenshtein distance
          // between the two word sequences.

          const A = passageWords.map(normalizeWord);
          const B = studentWords.map(normalizeWord);
          const M = A.length;
          const N = B.length;

          // Costs for different operations. Making substitution more expensive than
          // an insertion + omission pair encourages the algorithm to prefer gaps.
          const costSub = 2;
          const costIns = 1;
          const costDel = 1;

          // --- Step 1: Build DP Matrix for Word-Level Alignment ---
          // This uses the Wagner-Fischer algorithm to find the minimum edit
          // distance between the two word sequences.

          // Initialize DP matrix
          const dp = Array(M + 1).fill(null).map(() => Array(N + 1).fill(0));

          for (let i = 0; i <= M; i++) dp[i][0] = i * costDel;
          for (let j = 0; j <= N; j++) dp[0][j] = j * costIns;

          // Fill DP matrix
          for (let i = 1; i <= M; i++) {
            for (let j = 1; j <= N; j++) {
              const cost = (A[i - 1] === B[j - 1]) ? 0 : costSub;
              dp[i][j] = Math.min(
                dp[i - 1][j] + costDel,       // Deletion (Omission)
                dp[i][j - 1] + costIns,       // Insertion
                dp[i - 1][j - 1] + cost      // Substitution or Match
              );
            }
          }

          // Backtrack to find the alignment path and generate miscues
          // --- Step 2: Backtrack to get the sequence of edit operations ---
          // This produces a clean list of operations (match, sub, ins, del)
          // before we classify them into pedagogical miscues.
          const alignmentOps = [];
          let i = M;
          let j = N;
          while (i > 0 || j > 0) {
            const normPassageWord = A[i - 1];
            const normStudentWord = B[j - 1];

            // Handle reaching the start of one sequence
            if (i === 0) {
              alignmentOps.unshift({ op: 'ins', p_idx: -1, s_idx: j - 1 });
              j--;
              continue;
            }
            if (j === 0) {
              alignmentOps.unshift({ op: 'del', p_idx: i - 1, s_idx: -1 });
              i--;
              continue;
            }

            const cost = (normPassageWord === normStudentWord) ? 0 : costSub;

            // Determine which operation led to the current cell
            if (dp[i][j] === dp[i - 1][j - 1] + cost) {
              alignmentOps.unshift({ op: (cost === 0 ? 'match' : 'sub'), p_idx: i - 1, s_idx: j - 1 });
              i--;
              j--;
            } else if (dp[i][j] === dp[i][j - 1] + costIns) {
              alignmentOps.unshift({ op: 'ins', p_idx: i - 1, s_idx: j - 1 });
              j--;
            } else { // Deletion
              alignmentOps.unshift({ op: 'del', p_idx: i - 1, s_idx: -1 });
              i--;
            }
          }

          // Post-processing for reversals could be added here by inspecting the miscues array
          // for adjacent insertion/omission pairs that are reversed. For now, this is omitted
          // for clarity and to focus on the core substitution/insertion/omission logic.
          // --- Step 3: Classify operations into miscues, handling repetitions ---
          // This loop iterates through the aligned operations and creates the final
          // list of pedagogical miscues.
          for (let k = 0; k < alignmentOps.length; k++) {
            const op = alignmentOps[k];
            const p_idx = op.p_idx;
            const s_idx = op.s_idx;

            // Check for Repetition: an insertion where the inserted word
            // is the same as the word that SHOULD have been read next
            if (op.op === 'ins' && k > 0) {
              // Look ahead to find what the next passage word should be
              let nextPassageOp = null;
              for (let nextK = k + 1; nextK < alignmentOps.length; nextK++) {
                const nextOp = alignmentOps[nextK];
                if (nextOp.op === 'match' || nextOp.op === 'sub' || nextOp.op === 'del') {
                  nextPassageOp = nextOp;
                  break;
                }
              }

              if (nextPassageOp && nextPassageOp.p_idx !== -1) {
                const insertedWord = normalizeWord(studentWords[op.s_idx]);
                const nextPassageWord = normalizeWord(passageWords[nextPassageOp.p_idx]);

                // Check if inserted word repeats the next expected passage word
                if (insertedWord === nextPassageWord) {
                  // Also check if this is NOT a simple insertion by seeing if the word appears again later
                  let isActualRepetition = false;
                  for (let checkK = k + 1; checkK < alignmentOps.length; checkK++) {
                    const checkOp = alignmentOps[checkK];
                    if ((checkOp.op === 'match' || checkOp.op === 'sub') &&
                      normalizeWord(studentWords[checkOp.s_idx]) === insertedWord) {
                      isActualRepetition = true;
                      break;
                    }
                  }

                  if (isActualRepetition) {
                    miscues.push({
                      type: 'Repetition',
                      originalWord: passageWords[nextPassageOp.p_idx],
                      studentWord: studentWords[op.s_idx],
                      context: getContext(passageWords, nextPassageOp.p_idx),
                      explanation: `Student repeated the word "${studentWords[op.s_idx]}"`
                    });
                    continue; // Skip default insertion handling
                  }
                }
              }
            }

            // Handle standard miscues
            switch (op.op) {
              case 'sub':
                miscues.push({
                  type: 'Substitution',
                  originalWord: passageWords[p_idx],
                  studentWord: studentWords[s_idx],
                  context: getContext(passageWords, p_idx),
                  explanation: `Student substituted "${studentWords[s_idx]}" for "${passageWords[p_idx]}"`
                });
                break;
              case 'del':
                miscues.push({
                  type: 'Omission',
                  originalWord: passageWords[p_idx],
                  studentWord: '[omitted]',
                  context: getContext(passageWords, p_idx),
                  explanation: `Student omitted the word "${passageWords[p_idx]}"`
                });
                break;
              case 'ins':
                miscues.push({
                  type: 'Insertion',
                  originalWord: '[none]',
                  studentWord: studentWords[s_idx],
                  context: getContext(passageWords, p_idx),
                  explanation: `Student inserted the word "${studentWords[s_idx]}"`
                });
                break;
              // 'match' operations are ignored
            }
          }

          // Count miscues by type
          const miscueCounts = {
            Substitution: 0,
            Omission: 0,
            Insertion: 0,
            Repetition: 0,
            Reversal: 0
          };

          miscues.forEach(miscue => {
            if (miscueCounts.hasOwnProperty(miscue.type)) {
              miscueCounts[miscue.type]++;
            }
          });

          resolve({
            summary: {
              totalMiscues: miscues.length,
              substitutions: miscueCounts.Substitution,
              omissions: miscueCounts.Omission,
              insertions: miscueCounts.Insertion,
              repetitions: miscueCounts.Repetition,
              reversals: miscueCounts.Reversal,
            },
            miscues: miscues
          });
        }, 1500);
      });

      // Helper function to get context around a word
      function getContext(words, index) {
        const start = Math.max(0, index - 2);
        const end = Math.min(words.length, index + 3);
        return words.slice(start, end).join(' ');
      }
    };


    // From components/icons.tsx
    const BookReaderIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2 3.993A1 1 0 0 1 3 3h18a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.993zM4 5v12h7V5H4zm9 0v12h7V5h-7z" /></svg>);
    const UserIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a5 5 0 0 1 5 5v1a5 5 0 0 1-10 0V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v1a3 3 0 0 0 6 0V7a3 3 0 0 0-3-3zm-5 9a7 7 0 0 1 7-7h.042a7.002 7.002 0 0 1 6.958 7v4.993A1 1 0 0 1 20 21H4a1 1 0 0 1-1-1V13zm2 0v5h12v-5a5 5 0 0 0-5-5h-2a5 5 0 0 0-5 5z" /></svg>);
    const DashboardIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13 3.562v16.876a2 2 0 0 1-3.464.364L3 12l6.536-8.802a2 2 0 0 1 3.464.364zM15 5.062a2 2 0 0 1 3.464-.364L21 12l-2.536 7.302a2 2 0 0 1-3.464-.364V5.062z" /></svg>);
    const StudentIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4.91 14.091c-.306.059-.62.091-.937.091C2.119 14.182 1 15.301 1 16.636V22h12v-5.364c0-1.335-1.119-2.455-2.973-2.455-.317 0-.631.032-.937.091a6.01 6.01 0 0 1-4.18-.182zM19.09 14.091a6.01 6.01 0 0 1-4.18.182c-.306-.059-.62-.091-.937.091C12.119 14.182 11 15.301 11 16.636V22h12v-5.364c0-1.335-1.119-2.455-2.973-2.455-.317 0-.631.032-.937.091zM8 7.091A4.091 4.091 0 1 1 8 15.273A4.091 4.091 0 0 1 8 7.091zm8 0a4.091 4.091 0 1 1 0 8.182A4.091 4.091 0 0 1 16 7.091zM8 9a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4z" /></svg>);
    const AttendanceIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3a1 1 0 0 1 1 1v2h3a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h3V4a1 1 0 0 1 1-1h10zm-2 2H9v2h6V5zm-3 6.5a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0zM17 10a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0zm-7 5.5a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0zM13 14a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z" /></svg>);
    const ReadingIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 18H6a1 1 0 0 0 0 2h15v1H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h16v16zM5 4v13h15V4H5zm14 15a1 1 0 1 1 0 2H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h16a1 1 0 1 1 0 2H5v15h14zM7 6h10v2H7V6zm0 4h10v2H7v-2z" /></svg>);
    const QuizIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v2h-2V7zm0 4h2v6h-2v-6z" /></svg>);
    const ResultsIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17v2h18v-2H3zm3.41-8.755L2 12.665V14h19v-1.95l-7.258-4.475-3.324 2.6L3.41 8.245zM4 5h16v2H4V5z" /></svg>);
    const GuidelinesIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8.009 8.009 0 0 1-8 8zm1-5v2h-2v-2h2zm0-8v6h-2V7h2z" /></svg>);
    const VocabularyIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 5.333V20a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V5.333a2 2 0 0 1 .586-1.414l.001-.001 7-4a2 2 0 0 1 2.828 0l7 4a2 2 0 0 1 .585 1.415zM12 2.828l-6.237 3.564L12 10l6.237-3.608L12 2.828zM6 8.333v10.334h12V8.333L12 12 6 8.333z" /></svg>);
    const ProsodyIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9h2V7H3v2zm0 4h2v-2H3v2zm0 4h2v-2H3v2zm4-8h2V7H7v2zm0 4h2v-2H7v2zm0 4h2v-2H7v2zm4-8h2V7h-2v2zm0 4h2v-2h-2v2zm0 4h2v-2h-2v2zm4-8h2V7h-2v2zm0 4h2v-2h-2v2zm4-4h2V7h-2v2zm-4 4h2v-2h-2v2zm4 0h2v-2h-2v2zm-4 4h2v-2h-2v2zm4 0h2v-2h-2v2z" /></svg>);
    const EditIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16.707 2.293a1 1 0 0 1 1.414 0l4 4a1 1 0 0 1 0 1.414l-11 11A1 1 0 0 1 10 19H5a1 1 0 0 1-1-1v-5a1 1 0 0 1 .293-.707l11-11.001zM16 6.414l-9 9V17h1.586l9-9L16 6.414zM18.414 5l-1-1L19 2.414 20.586 4 18.414 5z" /></svg>);
    const TrashIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 6V4a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v2h3a1 1 0 0 1 1 1v1H3V7a1 1 0 0 1 1-1h3zm2 0h6V4H9v2zM5 9v11a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V9H5zm4 2h2v7H9v-7zm4 0h2v7h-2v-7z" /></svg>);
    const PlusIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2h6z" /></svg>);
    const PlayIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z" /></svg>);
    const StopIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z" /></svg>);
    const MicrophoneIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3zm0 2a1 1 0 0 1 1 1v8a1 1 0 0 1-2 0V5a1 1 0 0 1 1-1z" /><path d="M19 11a1 1 0 0 1 1 1v.5a7.5 7.5 0 0 1-15 0V12a1 1 0 1 1 2 0v.5a5.5 5.5 0 0 0 11 0V12a1 1 0 0 1 1-1z" /></svg>);
    const VolumeIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" /></svg>);
    const DrillIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" /></svg>);
    const DownloadIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a1 1 0 0 1 1 1v10.586l2.293-2.293a1 1 0 0 1 1.414 1.414l-4 4a1 1 0 0 1-1.414 0l-4-4a1 1 0 1 1 1.414-1.414L11 13.586V3a1 1 0 0 1 1-1zM5 17a1 1 0 0 1 1 1v2h12v-2a1 1 0 1 1 2 0v2a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-2a1 1 0 0 1 1-1z" /></svg>);
    const EyeIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" /></svg>);
    const EyeOffIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z" /></svg>);

    // From components/Modal.tsx
    const Modal = ({ isOpen, onClose, title, children, footer }) => {
      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center" onClick={onClose}>
          <div
            className="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4 animate-fade-in-down"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="modal-gradient-header rounded-t-lg p-4 flex justify-between items-center">
              <h3 className="text-xl font-semibold text-white">{title}</h3>
              <button onClick={onClose} className="text-white hover:text-gray-200">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
            </div>
            <div className="p-6">
              {children}
            </div>
            {footer && (
              <div className="flex justify-end items-center p-4 border-t">
                {footer}
              </div>
            )}
          </div>
        </div>
      );
    };

    // UPDATED: From components/Sidebar.tsx - Made sidebar fixed
    const Sidebar = ({ activeModule, setActiveModule }) => {
      const navItems = [
        { id: Module.Dashboard, label: 'Dashboard', icon: DashboardIcon },
        { id: Module.StudentManagement, label: 'Student Management', icon: StudentIcon },
        { id: Module.Attendance, label: 'Attendance', icon: AttendanceIcon },
        { id: Module.ReadingAssessment, label: 'Reading Assessment', icon: ReadingIcon },
        { id: Module.Comprehension, label: 'Comprehension Quiz', icon: QuizIcon },
        { id: Module.Results, label: 'Results & Reports', icon: ResultsIcon },
        { id: Module.Guidelines, label: 'PHIL IRI Guidelines', icon: GuidelinesIcon },
        { id: Module.Vocabulary, label: 'Vocabulary', icon: VocabularyIcon }, // NEW: Added Vocabulary module
        { id: Module.Prosody, label: 'Prosody', icon: ProsodyIcon }, // NEW: Added Prosody module
        { id: Module.ReadingDrill, label: 'Reading Drill', icon: DrillIcon }, // NEW: Added Reading Drill module
      ];

      return (
        <aside className="fixed-sidebar bg-secondary text-white flex-shrink-0">
          <nav className="flex flex-col p-2">
            {navItems.map(item => (
              <a
                key={item.id}
                href="#"
                onClick={(e) => {
                  e.preventDefault();
                  setActiveModule(item.id);
                }}
                className={`flex items-center px-4 py-3 my-1 rounded-md transition-colors duration-200 ${activeModule === item.id
                  ? 'bg-primary text-white'
                  : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                  }`}
              >
                <item.icon className="w-5 h-5 mr-3" />
                <span>{item.label}</span>
              </a>
            ))}
          </nav>
        </aside>
      );
    };

    // UPDATED: Teacher Name Modal Component with Gradient
    const TeacherNameModal = ({ isOpen, onClose, teacherName, setTeacherName }) => {
      const [tempTeacherName, setTempTeacherName] = useState(teacherName || '');

      const handleSave = () => {
        setTeacherName(tempTeacherName);
        onClose();
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Set Teacher Name">
          <div className="space-y-4">
            {/* UPDATED: Added gradient header */}
            <div className="teacher-modal-gradient p-4 rounded-md text-white">
              <p className="text-sm">
                This name will appear on all PDF reports as "Evaluated by: [Teacher Name]".
              </p>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700">Teacher Name</label>
              <input
                type="text"
                value={tempTeacherName}
                onChange={(e) => setTempTeacherName(e.target.value)}
                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                placeholder="Enter your name"
              />
            </div>

            <div className="flex justify-end gap-2 pt-4">
              <button
                onClick={onClose}
                className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300"
              >
                Cancel
              </button>
              <button
                onClick={handleSave}
                className="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-blue-600"
              >
                Save
              </button>
            </div>
          </div>
        </Modal>
      );
    };

    // NEW: Progress Report Settings Modal Component
    const ProgressReportSettingsModal = ({ isOpen, onClose, settings, updateSettings }) => {
      const [tempSettings, setTempSettings] = useState(settings);

      useEffect(() => {
        setTempSettings(settings);
      }, [settings, isOpen]);

      const handleSave = () => {
        updateSettings(tempSettings);
        onClose();
      };

      const handlePeriodChange = (period) => {
        setTempSettings(prev => ({
          ...prev,
          reportPeriod: period
        }));
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Progress Report Settings">
          <div className="space-y-4">
            <div className="bg-blue-50 p-4 rounded-md border border-blue-200">
              <p className="text-sm text-blue-700">
                Configure how many weeks or days of data should be included in the progress reports.
              </p>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Report Period Type</label>
              <div className="flex gap-4">
                <label className="flex items-center">
                  <input
                    type="radio"
                    name="reportPeriod"
                    value="weeks"
                    checked={tempSettings.reportPeriod === 'weeks'}
                    onChange={() => handlePeriodChange('weeks')}
                    className="form-radio h-4 w-4 text-primary"
                  />
                  <span className="ml-2">Weeks</span>
                </label>
                <label className="flex items-center">
                  <input
                    type="radio"
                    name="reportPeriod"
                    value="days"
                    checked={tempSettings.reportPeriod === 'days'}
                    onChange={() => handlePeriodChange('days')}
                    className="form-radio h-4 w-4 text-primary"
                  />
                  <span className="ml-2">Days</span>
                </label>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Total {tempSettings.reportPeriod === 'weeks' ? 'Weeks' : 'Days'} for Report
              </label>
              <input
                type="number"
                min="1"
                max={tempSettings.reportPeriod === 'weeks' ? '52' : '365'}
                value={tempSettings.totalWeeks}
                onChange={(e) => setTempSettings(prev => ({
                  ...prev,
                  totalWeeks: parseInt(e.target.value) || 1
                }))}
                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
              />
              <p className="text-xs text-gray-500 mt-1">
                Set the total number of {tempSettings.reportPeriod === 'weeks' ? 'weeks' : 'days'} to include in progress reports.
              </p>
            </div>

            <div className="flex justify-end gap-2 pt-4">
              <button
                onClick={onClose}
                className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300"
              >
                Cancel
              </button>
              <button
                onClick={handleSave}
                className="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-blue-600"
              >
                Save Settings
              </button>
            </div>
          </div>
        </Modal>
      );
    };

    // NEW: Assessment Settings Modal Component
    const AssessmentSettingsModal = ({ isOpen, onClose, settings, updateSettings }) => {
      const [tempSettings, setTempSettings] = useState(settings);

      useEffect(() => {
        setTempSettings(settings);
      }, [settings, isOpen]);

      const handleSave = () => {
        updateSettings(tempSettings);
        onClose();
      };

      const handlePeriodChange = (period) => {
        setTempSettings(prev => ({
          ...prev,
          reportPeriod: period
        }));
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Assessment Settings">
          <div className="space-y-4">
            <div className="bg-blue-50 p-4 rounded-md border border-blue-200">
              <p className="text-sm text-blue-700">
                Configure how many weeks or days of assessments should be available for tracking.
              </p>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Assessment Period Type</label>
              <div className="flex gap-4">
                <label className="flex items-center">
                  <input
                    type="radio"
                    name="reportPeriod"
                    value="weeks"
                    checked={tempSettings.reportPeriod === 'weeks'}
                    onChange={() => handlePeriodChange('weeks')}
                    className="form-radio h-4 w-4 text-primary"
                  />
                  <span className="ml-2">Weeks</span>
                </label>
                <label className="flex items-center">
                  <input
                    type="radio"
                    name="reportPeriod"
                    value="days"
                    checked={tempSettings.reportPeriod === 'days'}
                    onChange={() => handlePeriodChange('days')}
                    className="form-radio h-4 w-4 text-primary"
                  />
                  <span className="ml-2">Days</span>
                </label>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Total {tempSettings.reportPeriod === 'weeks' ? 'Weeks' : 'Days'} for Assessments
              </label>
              <input
                type="number"
                min="1"
                max={tempSettings.reportPeriod === 'weeks' ? '52' : '365'}
                value={tempSettings.totalWeeks}
                onChange={(e) => setTempSettings(prev => ({
                  ...prev,
                  totalWeeks: parseInt(e.target.value) || 1
                }))}
                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
              />
              <p className="text-xs text-gray-500 mt-1">
                Set the total number of {tempSettings.reportPeriod === 'weeks' ? 'weeks' : 'days'} available for assessments.
              </p>
            </div>

            <div className="flex justify-end gap-2 pt-4">
              <button
                onClick={onClose}
                className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300"
              >
                Cancel
              </button>
              <button
                onClick={handleSave}
                className="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-blue-600"
              >
                Save Settings
              </button>
            </div>
          </div>
        </Modal>
      );
    };

    // NEW: Unlocking Difficulties Modal Component
    const UnlockingDifficultiesModal = ({ isOpen, onClose, passageId, difficultWords, onAddWord, onRemoveWord, onUpdateWord }) => {
      const [newWord, setNewWord] = useState('');
      const [newDefinition, setNewDefinition] = useState('');
      const [editingWord, setEditingWord] = useState(null);

      const handleAddWord = () => {
        if (newWord.trim() && newDefinition.trim()) {
          onAddWord(passageId, newWord.trim(), newDefinition.trim());
          setNewWord('');
          setNewDefinition('');
        }
      };

      const handleEditWord = (word) => {
        setEditingWord(word);
        setNewWord(word.word);
        setNewDefinition(word.definition);
      };

      const handleSaveEdit = () => {
        if (editingWord && newWord.trim() && newDefinition.trim()) {
          onUpdateWord(passageId, editingWord.word, newWord.trim(), newDefinition.trim());
          setEditingWord(null);
          setNewWord('');
          setNewDefinition('');
        }
      };

      const handleCancelEdit = () => {
        setEditingWord(null);
        setNewWord('');
        setNewDefinition('');
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Unlocking Difficulties">
          <div className="space-y-4">
            <div className="bg-blue-50 p-4 rounded-md border border-blue-200">
              <p className="text-sm text-blue-700">
                Add difficult words from the passage and their definitions. These will be highlighted in the passage for students.
              </p>
            </div>

            <div className="space-y-3">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700">Word</label>
                  <input
                    type="text"
                    value={newWord}
                    onChange={(e) => setNewWord(e.target.value)}
                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                    placeholder="Enter difficult word"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">Definition</label>
                  <input
                    type="text"
                    value={newDefinition}
                    onChange={(e) => setNewDefinition(e.target.value)}
                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                    placeholder="Enter definition"
                  />
                </div>
              </div>

              <div className="flex gap-2">
                {editingWord ? (
                  <>
                    <button
                      onClick={handleSaveEdit}
                      className="px-4 py-2 text-sm text-white bg-success rounded-md hover:bg-green-600"
                    >
                      Save Changes
                    </button>
                    <button
                      onClick={handleCancelEdit}
                      className="px-4 py-2 text-sm text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300"
                    >
                      Cancel
                    </button>
                  </>
                ) : (
                  <button
                    onClick={handleAddWord}
                    className="px-4 py-2 text-sm text-white bg-primary rounded-md hover:bg-blue-600"
                  >
                    Add Word
                  </button>
                )}
              </div>
            </div>

            <div className="mt-6">
              <h4 className="text-lg font-semibold text-gray-800 mb-3">Current Difficult Words</h4>
              {difficultWords.length === 0 ? (
                <div className="text-center py-4 text-gray-500 border-2 border-dashed rounded-md">
                  No difficult words added yet.
                </div>
              ) : (
                <div className="space-y-3 max-h-64 overflow-y-auto">
                  {difficultWords.map((wordItem, index) => (
                    <div key={index} className="flex justify-between items-start p-3 bg-gray-50 rounded-md border">
                      <div className="flex-1">
                        <p className="font-semibold text-gray-800">{wordItem.word}</p>
                        <p className="text-sm text-gray-600 mt-1">{wordItem.definition}</p>
                      </div>
                      <div className="flex gap-2 ml-4">
                        <button
                          onClick={() => handleEditWord(wordItem)}
                          className="text-warning hover:text-yellow-600"
                        >
                          <EditIcon className="w-5 h-5" />
                        </button>
                        <button
                          onClick={() => onRemoveWord(passageId, wordItem.word)}
                          className="text-danger hover:text-red-600"
                        >
                          <TrashIcon className="w-5 h-5" />
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </Modal>
      );
    };

    // UPDATED: Letter Sound Recognition Component with joined capital and lowercase letters
    const LetterSoundRecognition = ({ drillData, onUpdateDrill, speak, isSpeaking, selectedVoice, voices, setSelectedVoice, rate, setRate, pitch, setPitch, volume, setVolume, previewVoice }) => {
      const [currentLetterIndex, setCurrentLetterIndex] = useState(0);
      const [letterCase, setLetterCase] = useState('both'); // 'both', 'uppercase', or 'lowercase'

      const currentLetter = drillData.letters[currentLetterIndex];

      // Determine what to display based on selected case
      const getDisplayLetter = () => {
        switch (letterCase) {
          case 'uppercase':
            return currentLetter.letter;
          case 'lowercase':
            return currentLetter.lowercase;
          case 'both':
          default:
            return `${currentLetter.letter} ${currentLetter.lowercase}`;
        }
      };

      const displayLetter = getDisplayLetter();

      const handleNextLetter = () => {
        setCurrentLetterIndex((prev) => (prev + 1) % drillData.letters.length);
      };

      const handlePrevLetter = () => {
        setCurrentLetterIndex((prev) => (prev - 1 + drillData.letters.length) % drillData.letters.length);
      };

      const handlePlayLetterSound = () => {
        speak(`The letter ${currentLetter.letter} makes the sound ${currentLetter.sound}. For example, ${currentLetter.example}. ${currentLetter.pronunciation}`);
      };

      const handlePlaySoundOnly = () => {
        speak(currentLetter.sound);
      };

      const handlePlayExample = () => {
        speak(currentLetter.example);
      };

      return (
        <div className="bg-white rounded-lg shadow-md p-6">
          <div className="flex justify-between items-center mb-6">
            <h3 className="text-xl font-bold text-gray-800">Letter Sound Recognition</h3>
            <div className="flex items-center gap-2">
              <button
                onClick={handlePrevLetter}
                className="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300"
              >
                Previous
              </button>
              <button
                onClick={handleNextLetter}
                className="px-3 py-1 bg-primary text-white rounded-md hover:bg-blue-600"
              >
                Next
              </button>
            </div>
          </div>

          <div className="text-center mb-6">
            <div className="flex justify-center mb-4">
              <div className="case-toggle">
                <button
                  className={letterCase === 'both' ? 'active' : ''}
                  onClick={() => setLetterCase('both')}
                >
                  A a
                </button>
                <button
                  className={letterCase === 'uppercase' ? 'active' : ''}
                  onClick={() => setLetterCase('uppercase')}
                >
                  A
                </button>
                <button
                  className={letterCase === 'lowercase' ? 'active' : ''}
                  onClick={() => setLetterCase('lowercase')}
                >
                  a
                </button>
              </div>
            </div>

            <div className="letter-tile bg-primary text-white text-4xl mb-4 mx-auto">
              {displayLetter}
            </div>
            <p className="text-lg text-gray-600 mb-2">Sound: <span className="font-bold">{currentLetter.sound}</span></p>
            <p className="text-gray-600 mb-2">Example: <span className="font-bold">{currentLetter.example}</span></p>
            <p className="text-sm text-gray-500 italic mb-2">{currentLetter.emphasis}</p>
            <p className="text-sm text-gray-600">{currentLetter.pronunciation}</p>
          </div>

          <div className="flex flex-wrap justify-center gap-3 mb-6">
            <button
              onClick={handlePlayLetterSound}
              disabled={isSpeaking}
              className="sound-button flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600 disabled:opacity-50"
            >
              <VolumeIcon className="w-5 h-5" />
              Play Full Explanation
            </button>
            <button
              onClick={handlePlaySoundOnly}
              disabled={isSpeaking}
              className="sound-button flex items-center gap-2 px-4 py-2 bg-success text-white rounded-md hover:bg-green-600 disabled:opacity-50"
            >
              <VolumeIcon className="w-5 h-5" />
              Play Sound Only
            </button>
            <button
              onClick={handlePlayExample}
              disabled={isSpeaking}
              className="sound-button flex items-center gap-2 px-4 py-2 bg-warning text-white rounded-md hover:bg-yellow-600 disabled:opacity-50"
            >
              <VolumeIcon className="w-5 h-5" />
              Play Example
            </button>
          </div>

          <CollapsibleTTSControls
            voices={voices}
            selectedVoice={selectedVoice}
            setSelectedVoice={setSelectedVoice}
            rate={rate}
            setRate={setRate}
            pitch={pitch}
            setPitch={setPitch}
            volume={volume}
            setVolume={setVolume}
            previewVoice={previewVoice}
            isSpeaking={isSpeaking}
          />

          <div className="mt-6 pt-4 border-t">
            <h4 className="text-lg font-semibold text-gray-800 mb-2">All Letters</h4>
            <div className="flex flex-wrap gap-2">
              {drillData.letters.map((letter, index) => (
                <div
                  key={letter.letter}
                  onClick={() => setCurrentLetterIndex(index)}
                  className={`letter-tile cursor-pointer ${index === currentLetterIndex
                    ? 'bg-primary text-white'
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                >
                  {letterCase === 'both' ? `${letter.letter} ${letter.lowercase}` :
                    letterCase === 'uppercase' ? letter.letter : letter.lowercase}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // CVC Word Practice Component
    const CVCWordPractice = ({ drillData, onUpdateDrill, speak, isSpeaking, selectedVoice, voices, setSelectedVoice, rate, setRate, pitch, setPitch, volume, setVolume, previewVoice }) => {
      const [currentWordIndex, setCurrentWordIndex] = useState(0);

      const currentWord = drillData.words[currentWordIndex];

      const handleNextWord = () => {
        setCurrentWordIndex((prev) => (prev + 1) % drillData.words.length);
      };

      const handlePrevWord = () => {
        setCurrentWordIndex((prev) => (prev - 1 + drillData.words.length) % drillData.words.length);
      };

      const handlePlayWord = () => {
        speak(`The word is ${currentWord.word}. It follows the ${currentWord.pattern} pattern and sounds like ${currentWord.sound}.`);
      };

      const handlePlaySoundOnly = () => {
        speak(currentWord.word);
      };

      const handlePlayPattern = () => {
        speak(`This word follows the ${currentWord.pattern} pattern.`);
      };

      return (
        <div className="bg-white rounded-lg shadow-md p-6">
          <div className="flex justify-between items-center mb-6">
            <h3 className="text-xl font-bold text-gray-800">CVC Word Practice</h3>
            <div className="flex items-center gap-2">
              <button
                onClick={handlePrevWord}
                className="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300"
              >
                Previous
              </button>
              <button
                onClick={handleNextWord}
                className="px-3 py-1 bg-primary text-white rounded-md hover:bg-blue-600"
              >
                Next
              </button>
            </div>
          </div>

          <div className="text-center mb-6">
            <div className="word-tile bg-success text-white text-3xl mb-4 mx-auto">
              {currentWord.word}
            </div>
            <p className="text-lg text-gray-600 mb-2">Pattern: <span className="font-bold">{currentWord.pattern}</span></p>
            <p className="text-gray-600 mb-2">Sound: <span className="font-bold">{currentWord.sound}</span></p>
          </div>

          <div className="flex flex-wrap justify-center gap-3 mb-6">
            <button
              onClick={handlePlayWord}
              disabled={isSpeaking}
              className="sound-button flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600 disabled:opacity-50"
            >
              <VolumeIcon className="w-5 h-5" />
              Play Full Explanation
            </button>
            <button
              onClick={handlePlaySoundOnly}
              disabled={isSpeaking}
              className="sound-button flex items-center gap-2 px-4 py-2 bg-success text-white rounded-md hover:bg-green-600 disabled:opacity-50"
            >
              <VolumeIcon className="w-5 h-5" />
              Play Word
            </button>
            <button
              onClick={handlePlayPattern}
              disabled={isSpeaking}
              className="sound-button flex items-center gap-2 px-4 py-2 bg-warning text-white rounded-md hover:bg-yellow-600 disabled:opacity-50"
            >
              <VolumeIcon className="w-5 h-5" />
              Play Pattern
            </button>
          </div>

          <CollapsibleTTSControls
            voices={voices}
            selectedVoice={selectedVoice}
            setSelectedVoice={setSelectedVoice}
            rate={rate}
            setRate={setRate}
            pitch={pitch}
            setPitch={setPitch}
            volume={volume}
            setVolume={setVolume}
            previewVoice={previewVoice}
            isSpeaking={isSpeaking}
          />

          <div className="mt-6 pt-4 border-t">
            <h4 className="text-lg font-semibold text-gray-800 mb-2">All CVC Words</h4>
            <div className="flex flex-wrap gap-2">
              {drillData.words.map((word, index) => (
                <div
                  key={word.word}
                  onClick={() => setCurrentWordIndex(index)}
                  className={`word-tile cursor-pointer ${index === currentWordIndex
                    ? 'bg-success text-white'
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                >
                  {word.word}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // Fuller Method Component
    const FullerMethod = ({ drillData, onUpdateDrill, speak, isSpeaking, selectedVoice, voices, setSelectedVoice, rate, setRate, pitch, setPitch, volume, setVolume, previewVoice }) => {
      const [currentFamilyIndex, setCurrentFamilyIndex] = useState(0);

      const currentFamily = drillData.wordFamilies[currentFamilyIndex];

      const handleNextFamily = () => {
        setCurrentFamilyIndex((prev) => (prev + 1) % drillData.wordFamilies.length);
      };

      const handlePrevFamily = () => {
        setCurrentFamilyIndex((prev) => (prev - 1 + drillData.wordFamilies.length) % drillData.wordFamilies.length);
      };

      const handlePlayFamily = () => {
        speak(`The ${currentFamily.family} word family includes: ${currentFamily.words.join(', ')}.`);
      };

      const handlePlayWords = () => {
        currentFamily.words.forEach((word, index) => {
          setTimeout(() => {
            speak(word);
          }, index * 1000);
        });
      };

      return (
        <div className="bg-white rounded-lg shadow-md p-6">
          <div className="flex justify-between items-center mb-6">
            <h3 className="text-xl font-bold text-gray-800">Fuller Method - Word Families</h3>
            <div className="flex items-center gap-2">
              <button
                onClick={handlePrevFamily}
                className="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300"
              >
                Previous
              </button>
              <button
                onClick={handleNextFamily}
                className="px-3 py-1 bg-primary text-white rounded-md hover:bg-blue-600"
              >
                Next
              </button>
            </div>
          </div>

          <div className="text-center mb-6">
            <div className="word-tile bg-warning text-white text-3xl mb-4 mx-auto">
              {currentFamily.family}
            </div>
            <p className="text-lg text-gray-600 mb-4">Word Family</p>
          </div>

          <div className="mb-6">
            <h4 className="text-lg font-semibold text-gray-800 mb-3">Words in this family:</h4>
            <div className="flex flex-wrap gap-2 justify-center">
              {currentFamily.words.map((word, index) => (
                <div
                  key={word}
                  onClick={() => speak(word)}
                  className="word-tile bg-gray-100 text-gray-700 hover:bg-gray-200 cursor-pointer"
                >
                  {word}
                </div>
              ))}
            </div>
          </div>

          <div className="flex flex-wrap justify-center gap-3 mb-6">
            <button
              onClick={handlePlayFamily}
              disabled={isSpeaking}
              className="sound-button flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600 disabled:opacity-50"
            >
              <VolumeIcon className="w-5 h-5" />
              Play Family Explanation
            </button>
            <button
              onClick={handlePlayWords}
              disabled={isSpeaking}
              className="sound-button flex items-center gap-2 px-4 py-2 bg-success text-white rounded-md hover:bg-green-600 disabled:opacity-50"
            >
              <VolumeIcon className="w-5 h-5" />
              Play All Words
            </button>
          </div>

          <CollapsibleTTSControls
            voices={voices}
            selectedVoice={selectedVoice}
            setSelectedVoice={setSelectedVoice}
            rate={rate}
            setRate={setRate}
            pitch={pitch}
            setPitch={setPitch}
            volume={volume}
            setVolume={setVolume}
            previewVoice={previewVoice}
            isSpeaking={isSpeaking}
          />

          <div className="mt-6 pt-4 border-t">
            <h4 className="text-lg font-semibold text-gray-800 mb-2">All Word Families</h4>
            <div className="flex flex-wrap gap-2">
              {drillData.wordFamilies.map((family, index) => (
                <div
                  key={family.family}
                  onClick={() => setCurrentFamilyIndex(index)}
                  className={`word-tile cursor-pointer ${index === currentFamilyIndex
                    ? 'bg-warning text-white'
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                >
                  {family.family}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // Sound Blending Component
    const SoundBlending = ({ drillData, onUpdateDrill, speak, isSpeaking, selectedVoice, voices, setSelectedVoice, rate, setRate, pitch, setPitch, volume, setVolume, previewVoice }) => {
      const [currentExerciseIndex, setCurrentExerciseIndex] = useState(0);
      const [showWord, setShowWord] = useState(false);

      const currentExercise = drillData.exercises[currentExerciseIndex];

      const handleNextExercise = () => {
        setCurrentExerciseIndex((prev) => (prev + 1) % drillData.exercises.length);
        setShowWord(false);
      };

      const handlePrevExercise = () => {
        setCurrentExerciseIndex((prev) => (prev - 1 + drillData.exercises.length) % drillData.exercises.length);
        setShowWord(false);
      };

      const handlePlaySounds = () => {
        // Play each sound with a pause between them
        currentExercise.sounds.forEach((sound, index) => {
          setTimeout(() => {
            speak(sound);
          }, index * 800);
        });

        // After all sounds, play the blended word
        setTimeout(() => {
          speak(`When we blend these sounds together, we get ${currentExercise.word}.`);
        }, currentExercise.sounds.length * 800 + 500);
      };

      const handlePlayWord = () => {
        speak(currentExercise.word);
      };

      const handleRevealWord = () => {
        setShowWord(true);
      };

      return (
        <div className="bg-white rounded-lg shadow-md p-6">
          <div className="flex justify-between items-center mb-6">
            <h3 className="text-xl font-bold text-gray-800">Sound Blending Activities</h3>
            <div className="flex items-center gap-2">
              <button
                onClick={handlePrevExercise}
                className="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300"
              >
                Previous
              </button>
              <button
                onClick={handleNextExercise}
                className="px-3 py-1 bg-primary text-white rounded-md hover:bg-blue-600"
              >
                Next
              </button>
            </div>
          </div>

          <div className="text-center mb-6">
            <h4 className="text-lg font-semibold text-gray-800 mb-4">Blend these sounds together:</h4>
            <div className="flex justify-center gap-3 mb-6">
              {currentExercise.sounds.map((sound, index) => (
                <div key={index} className="blending-box bg-primary text-white">
                  {sound}
                </div>
              ))}
            </div>

            {showWord ? (
              <div className="word-tile bg-success text-white text-3xl mb-4 mx-auto">
                {currentExercise.word}
              </div>
            ) : (
              <button
                onClick={handleRevealWord}
                className="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 mb-4"
              >
                Reveal Word
              </button>
            )}
          </div>

          <div className="flex flex-wrap justify-center gap-3 mb-6">
            <button
              onClick={handlePlaySounds}
              disabled={isSpeaking}
              className="sound-button flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600 disabled:opacity-50"
            >
              <VolumeIcon className="w-5 h-5" />
              Play Sounds & Blend
            </button>
            <button
              onClick={handlePlayWord}
              disabled={isSpeaking}
              className="sound-button flex items-center gap-2 px-4 py-2 bg-success text-white rounded-md hover:bg-green-600 disabled:opacity-50"
            >
              <VolumeIcon className="w-5 h-5" />
              Play Word
            </button>
          </div>

          <CollapsibleTTSControls
            voices={voices}
            selectedVoice={selectedVoice}
            setSelectedVoice={setSelectedVoice}
            rate={rate}
            setRate={setRate}
            pitch={pitch}
            setPitch={setPitch}
            volume={volume}
            setVolume={setVolume}
            previewVoice={previewVoice}
            isSpeaking={isSpeaking}
          />

          <div className="mt-6 pt-4 border-t">
            <h4 className="text-lg font-semibold text-gray-800 mb-2">All Blending Exercises</h4>
            <div className="flex flex-wrap gap-2">
              {drillData.exercises.map((exercise, index) => (
                <div
                  key={exercise.word}
                  onClick={() => {
                    setCurrentExerciseIndex(index);
                    setShowWord(false);
                  }}
                  className={`word-tile cursor-pointer ${index === currentExerciseIndex
                    ? 'bg-success text-white'
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                >
                  {exercise.sounds.join(' + ')}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // Drill Management Modal
    const DrillManagementModal = ({ isOpen, onClose, drillData, onUpdateDrill }) => {
      const [editingDrill, setEditingDrill] = useState(null);
      const [editingData, setEditingData] = useState(null);

      const handleEditDrill = (drillType) => {
        setEditingDrill(drillType);
        setEditingData(JSON.parse(JSON.stringify(drillData[drillType])));
      };

      const handleSaveDrill = () => {
        if (!editingDrill || !editingData) return;

        onUpdateDrill(editingDrill, editingData);
        setEditingDrill(null);
        setEditingData(null);
      };

      const handleCancelEdit = () => {
        setEditingDrill(null);
        setEditingData(null);
      };

      const handleAddItem = (itemType) => {
        if (!editingData) return;

        const newItem = getDefaultItem(itemType);
        setEditingData({
          ...editingData,
          [itemType]: [...editingData[itemType], newItem]
        });
      };

      const handleUpdateItem = (itemType, index, field, value) => {
        if (!editingData) return;

        const updatedItems = [...editingData[itemType]];
        updatedItems[index] = {
          ...updatedItems[index],
          [field]: value
        };

        setEditingData({
          ...editingData,
          [itemType]: updatedItems
        });
      };

      const handleDeleteItem = (itemType, index) => {
        if (!editingData) return;

        const updatedItems = [...editingData[itemType]];
        updatedItems.splice(index, 1);

        setEditingData({
          ...editingData,
          [itemType]: updatedItems
        });
      };

      const getDefaultItem = (itemType) => {
        switch (itemType) {
          case 'letters':
            return { letter: '', lowercase: '', sound: '', example: '', emphasis: '', pronunciation: '' };
          case 'words':
            return { word: '', pattern: 'CVC', sound: '' };
          case 'wordFamilies':
            return { family: '', words: [''] };
          case 'exercises':
            return { sounds: [''], word: '' };
          default:
            return {};
        }
      };

      const toggleDrillEnabled = (drillType) => {
        onUpdateDrill(drillType, {
          ...drillData[drillType],
          enabled: !drillData[drillType].enabled
        });
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Manage Reading Drills">
          {editingDrill ? (
            <div>
              <h4 className="text-lg font-semibold mb-4 capitalize">
                Edit {editingDrill.replace(/([A-Z])/g, ' $1').toLowerCase()}
              </h4>

              {editingDrill === 'letterSounds' && (
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <h5 className="font-medium">Letter Sounds</h5>
                    <button
                      onClick={() => handleAddItem('letters')}
                      className="flex items-center gap-1 px-3 py-1 text-sm bg-success text-white rounded-md"
                    >
                      <PlusIcon className="w-4 h-4" /> Add Letter
                    </button>
                  </div>

                  <div className="space-y-4 max-h-96 overflow-y-auto">
                    {editingData.letters.map((letter, index) => (
                      <div key={index} className="p-4 border rounded-md bg-gray-50">
                        <div className="grid grid-cols-2 gap-4 mb-3">
                          <div>
                            <label className="block text-sm font-medium text-gray-700">Uppercase</label>
                            <input
                              type="text"
                              value={letter.letter}
                              onChange={(e) => handleUpdateItem('letters', index, 'letter', e.target.value)}
                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                              maxLength={1}
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700">Lowercase</label>
                            <input
                              type="text"
                              value={letter.lowercase}
                              onChange={(e) => handleUpdateItem('letters', index, 'lowercase', e.target.value)}
                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                              maxLength={1}
                            />
                          </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4 mb-3">
                          <div>
                            <label className="block text-sm font-medium text-gray-700">Sound</label>
                            <input
                              type="text"
                              value={letter.sound}
                              onChange={(e) => handleUpdateItem('letters', index, 'sound', e.target.value)}
                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700">Example Word</label>
                            <input
                              type="text"
                              value={letter.example}
                              onChange={(e) => handleUpdateItem('letters', index, 'example', e.target.value)}
                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                            />
                          </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4 mb-3">
                          <div>
                            <label className="block text-sm font-medium text-gray-700">Emphasis</label>
                            <input
                              type="text"
                              value={letter.emphasis}
                              onChange={(e) => handleUpdateItem('letters', index, 'emphasis', e.target.value)}
                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700">Pronunciation Guide</label>
                            <input
                              type="text"
                              value={letter.pronunciation}
                              onChange={(e) => handleUpdateItem('letters', index, 'pronunciation', e.target.value)}
                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                            />
                          </div>
                        </div>

                        <div className="flex justify-end">
                          <button
                            onClick={() => handleDeleteItem('letters', index)}
                            className="text-danger hover:text-red-700"
                          >
                            <TrashIcon className="w-5 h-5" />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {editingDrill === 'cvcWords' && (
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <h5 className="font-medium">CVC Words</h5>
                    <button
                      onClick={() => handleAddItem('words')}
                      className="flex items-center gap-1 px-3 py-1 text-sm bg-success text-white rounded-md"
                    >
                      <PlusIcon className="w-4 h-4" /> Add Word
                    </button>
                  </div>

                  <div className="space-y-4 max-h-96 overflow-y-auto">
                    {editingData.words.map((word, index) => (
                      <div key={index} className="p-4 border rounded-md bg-gray-50">
                        <div className="grid grid-cols-3 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700">Word</label>
                            <input
                              type="text"
                              value={word.word}
                              onChange={(e) => handleUpdateItem('words', index, 'word', e.target.value)}
                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700">Pattern</label>
                            <select
                              value={word.pattern}
                              onChange={(e) => handleUpdateItem('words', index, 'pattern', e.target.value)}
                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                            >
                              <option value="CVC">CVC</option>
                              <option value="CVCC">CVCC</option>
                              <option value="CCVC">CCVC</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700">Sound</label>
                            <input
                              type="text"
                              value={word.sound}
                              onChange={(e) => handleUpdateItem('words', index, 'sound', e.target.value)}
                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                            />
                          </div>
                        </div>

                        <div className="flex justify-end mt-3">
                          <button
                            onClick={() => handleDeleteItem('words', index)}
                            className="text-danger hover:text-red-700"
                          >
                            <TrashIcon className="w-5 h-5" />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {editingDrill === 'fullerMethod' && (
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <h5 className="font-medium">Word Families</h5>
                    <button
                      onClick={() => handleAddItem('wordFamilies')}
                      className="flex items-center gap-1 px-3 py-1 text-sm bg-success text-white rounded-md"
                    >
                      <PlusIcon className="w-4 h-4" /> Add Family
                    </button>
                  </div>

                  <div className="space-y-4 max-h-96 overflow-y-auto">
                    {editingData.wordFamilies.map((family, index) => (
                      <div key={index} className="p-4 border rounded-md bg-gray-50">
                        <div className="mb-3">
                          <label className="block text-sm font-medium text-gray-700">Word Family</label>
                          <input
                            type="text"
                            value={family.family}
                            onChange={(e) => handleUpdateItem('wordFamilies', index, 'family', e.target.value)}
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700">Words (comma separated)</label>
                          <input
                            type="text"
                            value={family.words.join(', ')}
                            onChange={(e) => handleUpdateItem('wordFamilies', index, 'words', e.target.value.split(',').map(w => w.trim()))}
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                          />
                        </div>

                        <div className="flex justify-end mt-3">
                          <button
                            onClick={() => handleDeleteItem('wordFamilies', index)}
                            className="text-danger hover:text-red-700"
                          >
                            <TrashIcon className="w-5 h-5" />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {editingDrill === 'soundBlending' && (
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <h5 className="font-medium">Sound Blending Exercises</h5>
                    <button
                      onClick={() => handleAddItem('exercises')}
                      className="flex items-center gap-1 px-3 py-1 text-sm bg-success text-white rounded-md"
                    >
                      <PlusIcon className="w-4 h-4" /> Add Exercise
                    </button>
                  </div>

                  <div className="space-y-4 max-h-96 overflow-y-auto">
                    {editingData.exercises.map((exercise, index) => (
                      <div key={index} className="p-4 border rounded-md bg-gray-50">
                        <div className="grid grid-cols-2 gap-4 mb-3">
                          <div>
                            <label className="block text-sm font-medium text-gray-700">Sounds (comma separated)</label>
                            <input
                              type="text"
                              value={exercise.sounds.join(', ')}
                              onChange={(e) => handleUpdateItem('exercises', index, 'sounds', e.target.value.split(',').map(s => s.trim()))}
                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700">Word</label>
                            <input
                              type="text"
                              value={exercise.word}
                              onChange={(e) => handleUpdateItem('exercises', index, 'word', e.target.value)}
                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                            />
                          </div>
                        </div>

                        <div className="flex justify-end">
                          <button
                            onClick={() => handleDeleteItem('exercises', index)}
                            className="text-danger hover:text-red-700"
                          >
                            <TrashIcon className="w-5 h-5" />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              <div className="flex justify-end gap-2 mt-6">
                <button
                  onClick={handleCancelEdit}
                  className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300"
                >
                  Cancel
                </button>
                <button
                  onClick={handleSaveDrill}
                  className="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-blue-600"
                >
                  Save Changes
                </button>
              </div>
            </div>
          ) : (
            <div>
              <div className="space-y-4">
                {Object.keys(drillData).map(drillType => (
                  <div
                    key={drillType}
                    className={`p-4 border rounded-md flex justify-between items-center ${drillData[drillType].enabled ? 'active-drill' : 'bg-gray-50'}`}
                  >
                    <div>
                      <h5 className="font-medium capitalize">
                        {drillType.replace(/([A-Z])/g, ' $1').toLowerCase()}
                      </h5>
                      <p className="text-sm text-gray-500">
                        {drillType === 'letterSounds' && `${drillData[drillType].letters.length} letters`}
                        {drillType === 'cvcWords' && `${drillData[drillType].words.length} words`}
                        {drillType === 'fullerMethod' && `${drillData[drillType].wordFamilies.length} word families`}
                        {drillType === 'soundBlending' && `${drillData[drillType].exercises.length} exercises`}
                      </p>
                    </div>

                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => handleEditDrill(drillType)}
                        className="text-warning hover:text-yellow-600"
                      >
                        <EditIcon className="w-5 h-5" />
                      </button>

                      <div className="flex items-center">
                        <span className={`mr-2 text-sm ${drillData[drillType].enabled ? 'text-success' : 'text-gray-500'}`}>
                          {drillData[drillType].enabled ? 'Enabled' : 'Disabled'}
                        </span>
                        <button
                          onClick={() => toggleDrillEnabled(drillType)}
                          className={`relative inline-flex h-6 w-11 items-center rounded-full ${drillData[drillType].enabled ? 'bg-success' : 'bg-gray-300'
                            }`}
                        >
                          <span
                            className={`inline-block h-4 w-4 transform rounded-full bg-white transition ${drillData[drillType].enabled ? 'translate-x-6' : 'translate-x-1'
                              }`}
                          />
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              <div className="mt-6 pt-4 border-t">
                <button
                  onClick={() => {
                    // Reset to default data
                    if (window.confirm('Are you sure you want to reset all drills to default values?')) {
                      Object.keys(defaultDrillData).forEach(drillType => {
                        onUpdateDrill(drillType, defaultDrillData[drillType]);
                      });
                    }
                  }}
                  className="px-4 py-2 text-sm text-white bg-danger rounded-md hover:bg-red-600"
                >
                  Reset to Defaults
                </button>
              </div>
            </div>
          )}
        </Modal>
      );
    };

    // UPDATED: Vocabulary Management Modal
    const VocabularyManagementModal = ({ isOpen, onClose, vocabulary, addWord, updateWord, deleteWord }) => {
      const [editingItem, setEditingItem] = useState(null); // { id, word, definition }
      const [newItem, setNewItem] = useState({ word: '', definition: '' });

      const handleSave = (e) => {
        if (editingItem) {
          if (editingItem.word.trim() && editingItem.definition.trim()) {
            updateWord(editingItem.id, editingItem.word, editingItem.definition);
            setEditingItem(null);
          } else {
            alert('Word and definition cannot be empty.');
          }
        }
      };

      const handleAdd = (e) => {
        if (newItem.word.trim() && newItem.definition.trim()) {
          addWord(newItem.word, newItem.definition);
          setNewItem({ word: '', definition: '' });
        } else {
          alert('Word and definition cannot be empty.');
        }
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Manage Vocabulary">
          <div className="space-y-4">
            <div className="p-4 border rounded-md bg-gray-50">
              <form onSubmit={handleAdd}>
                <h4 className="font-semibold text-lg mb-2">Add New Word</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                  <input
                    type="text"
                    placeholder="Word"
                    value={newItem.word}
                    onChange={(e) => setNewItem(prev => ({ ...prev, word: e.target.value }))}
                    className="w-full p-2 border rounded-md"
                    required
                  />
                  <input
                    type="text"
                    placeholder="Definition"
                    value={newItem.definition}
                    onChange={(e) => setNewItem(prev => ({ ...prev, definition: e.target.value }))}
                    className="w-full p-2 border rounded-md"
                    required
                  />
                </div>
                <button type="submit" className="px-4 py-2 text-sm text-white bg-primary rounded-md hover:bg-blue-600">
                  Add Word
                </button>
              </form>
            </div>

            <div className="mt-6">
              <h4 className="text-lg font-semibold text-gray-800 mb-3">Vocabulary List</h4>
              <div className="space-y-3 max-h-80 overflow-y-auto">
                {vocabulary.map(item => (
                  <div key={item.id} className="p-3 bg-gray-50 rounded-md border">
                    {editingItem?.id === item.id ? (
                      <form onSubmit={handleSave} className="space-y-2">
                        <input
                          type="text"
                          value={editingItem.word}
                          onChange={(e) => setEditingItem(prev => ({ ...prev, word: e.target.value }))}
                          className="w-full p-2 border rounded-md"
                          required
                        />
                        <textarea
                          value={editingItem.definition}
                          onChange={(e) => setEditingItem(prev => ({ ...prev, definition: e.target.value }))}
                          className="w-full p-2 border rounded-md"
                          rows="2"
                          required
                        />
                        <div className="flex gap-2">
                          <button type="submit" className="px-3 py-1 text-sm text-white bg-success rounded-md">Save</button>
                          <button type="button" onClick={() => setEditingItem(null)} className="px-3 py-1 text-sm text-gray-700 bg-gray-200 rounded-md">Cancel</button>
                        </div>
                      </form>
                    ) : (
                      <div className="flex justify-between items-start">
                        <div>
                          <p className="font-semibold text-gray-800">{item.word}</p>
                          <p className="text-sm text-gray-600 mt-1">{item.definition}</p>
                        </div>
                        <div className="flex gap-2 ml-4">
                          <button onClick={() => setEditingItem({ ...item })} className="text-warning hover:text-yellow-600"><EditIcon className="w-5 h-5" /></button>
                          <button onClick={() => deleteWord(item.id)} className="text-danger hover:text-red-600"><TrashIcon className="w-5 h-5" /></button>
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          </div>
        </Modal>
      );
    };

    // UPDATED: Vocabulary Practice Component with Review and Practice sections
    const VocabularyPractice = () => {
      const { vocabulary, addWord, updateWord, deleteWord } = useVocabularyList();
      const [isManagementModalOpen, setIsManagementModalOpen] = useState(false);
      const [activeTab, setActiveTab] = useState('review'); // 'review' or 'practice'
      const [practiceWords, setPracticeWords] = useState([]);
      const [currentWordIndex, setCurrentWordIndex] = useState(0);
      const [options, setOptions] = useState([]);
      const [selectedAnswer, setSelectedAnswer] = useState(null);
      const [isAnswered, setIsAnswered] = useState(false);
      const [score, setScore] = useState({ correct: 0, incorrect: 0 });
      const [isPracticeActive, setIsPracticeActive] = useState(false);
      const [searchTerm, setSearchTerm] = useState('');

      const shuffleArray = (array) => {
        return array.map(value => ({ value, sort: Math.random() }))
          .sort((a, b) => a.sort - b.sort)
          .map(({ value }) => value);
      };

      const startPractice = () => {
        if (vocabulary.length < 4) {
          alert("You need at least 4 words in your vocabulary list to start the practice.");
          return;
        }
        setScore({ correct: 0, incorrect: 0 });
        setCurrentWordIndex(0);
        const shuffled = shuffleArray(vocabulary);
        setPracticeWords(shuffled);
        generateOptions(shuffled[0], shuffled);
        setIsPracticeActive(true);
      };

      const generateOptions = (correctWord, wordList) => {
        // Get 3 random incorrect definitions
        const distractors = wordList
          .filter(w => w.id !== correctWord.id)
          .slice(0, 3)
          .map(w => w.definition);

        const allOptions = shuffleArray([correctWord.definition, ...distractors]);
        setOptions(allOptions);
        setSelectedAnswer(null);
        setIsAnswered(false);
      };

      const handleSelectAnswer = (definition) => {
        if (isAnswered) return;
        setSelectedAnswer(definition);
        const correctDefinition = practiceWords[currentWordIndex].definition;
        if (definition === correctDefinition) {
          setScore(prev => ({ ...prev, correct: prev.correct + 1 }));
        } else {
          setScore(prev => ({ ...prev, incorrect: prev.incorrect + 1 }));
        }
        setIsAnswered(true);
      };

      const handleNextWord = () => {
        if (currentWordIndex < practiceWords.length - 1) {
          const nextIndex = currentWordIndex + 1;
          setCurrentWordIndex(nextIndex);
          generateOptions(practiceWords[nextIndex], practiceWords);
        } else {
          // End of practice
          setIsPracticeActive(false);
        }
      };

      const filteredVocabulary = vocabulary.filter(item =>
        item.word.toLowerCase().includes(searchTerm.toLowerCase()) ||
        item.definition.toLowerCase().includes(searchTerm.toLowerCase())
      );

      const renderReviewSection = () => (
        <div className="bg-white p-6 rounded-lg shadow-md">
          <div className="mb-4">
            <input
              type="text"
              placeholder="Search words or definitions..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full p-2 border rounded-md"
            />
          </div>
          <div className="space-y-3 max-h-[60vh] overflow-y-auto">
            {filteredVocabulary.length > 0 ? filteredVocabulary.map(item => (
              <div key={item.id} className="p-4 bg-gray-50 rounded-md border">
                <p className="font-semibold text-gray-800 text-lg">{item.word}</p>
                <p className="text-sm text-gray-600 mt-1">{item.definition}</p>
              </div>
            )) : (
              <div className="text-center py-8 text-gray-500">
                <p>No words found. {vocabulary.length > 0 ? 'Try a different search term.' : 'Add some words to get started!'}</p>
              </div>
            )}
          </div>
        </div>
      );

      const renderPracticeSection = () => {
        if (!isPracticeActive) {
          return (
            <div className="text-center bg-white p-10 rounded-lg shadow-md">
              {score.correct + score.incorrect > 0 && (
                <div className="mb-8">
                  <h3 className="text-xl font-semibold text-gray-700 mb-4">Last Practice Score</h3>
                  <p className="text-4xl font-bold text-success">{Math.round((score.correct / (score.correct + score.incorrect)) * 100)}%</p>
                  <p className="text-gray-600">{score.correct} correct out of {score.correct + score.incorrect}</p>
                </div>
              )}
              <button onClick={startPractice} className="px-8 py-4 text-lg font-semibold text-white bg-success rounded-lg shadow-lg hover:bg-green-600 transition-transform transform hover:scale-105">
                Start New Practice
              </button>
              <p className="text-sm text-gray-500 mt-4">You need at least 4 words to start.</p>
            </div>
          );
        }

        const currentWord = practiceWords[currentWordIndex];
        return currentWord ? (<div className="bg-white p-6 rounded-lg shadow-md">
          <div className="flex justify-between items-center mb-6 pb-4 border-b">
            <p className="text-lg font-semibold">Word {currentWordIndex + 1} of {practiceWords.length}</p>
            <div className="flex gap-4 text-sm">
              <span className="px-3 py-1 bg-green-100 text-success rounded-full font-medium">Correct: {score.correct}</span>
              <span className="px-3 py-1 bg-red-100 text-danger rounded-full font-medium">Incorrect: {score.incorrect}</span>
            </div>
          </div>

          <div className="text-center mb-8">
            <h3 className="text-4xl font-bold text-primary mb-2">{currentWord.word}</h3>
            <p className="text-gray-500">Choose the correct definition below.</p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {options.map((definition, index) => {
              const isCorrect = definition === currentWord.definition;
              const isSelected = definition === selectedAnswer;
              let cardClass = '';
              if (isAnswered) {
                if (isCorrect) cardClass = 'reveal-correct';
                if (isSelected && !isCorrect) cardClass = 'incorrect';
                if (isSelected && isCorrect) cardClass = 'correct';
              } else if (isSelected) {
                cardClass = 'selected';
              }

              return (
                <div
                  key={index}
                  onClick={() => handleSelectAnswer(definition)}
                  className={`vocab-card p-4 rounded-lg shadow-sm cursor-pointer border-2 ${cardClass}`}
                >
                  <p>{definition}</p>
                </div>
              );
            })}
          </div>

          {isAnswered && (
            <div className="text-center mt-8">
              <button onClick={handleNextWord} className="px-6 py-3 text-white bg-primary rounded-lg hover:bg-blue-600">
                {currentWordIndex < practiceWords.length - 1 ? 'Next Word' : 'Finish Practice'}
              </button>
            </div>
          )}
        </div>
        ) : null;
      }

      return (
        <div>
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-2xl font-bold text-gray-800">Vocabulary</h2>
            <button onClick={() => setIsManagementModalOpen(true)} className="flex items-center gap-2 px-4 py-2 text-white bg-primary rounded-md shadow-sm hover:bg-blue-600">
              <EditIcon className="w-5 h-5" /> Manage Vocabulary
            </button>
          </div>

          <div className="mb-6">
            <div className="flex border-b">
              <button
                onClick={() => setActiveTab('review')}
                className={`flex-1 px-4 py-3 text-center font-medium ${activeTab === 'review' ? 'text-primary border-b-2 border-primary' : 'text-gray-500 hover:text-gray-700'}`}
              >
                Review
              </button>
              <button
                onClick={() => setActiveTab('practice')}
                className={`flex-1 px-4 py-3 text-center font-medium ${activeTab === 'practice' ? 'text-primary border-b-2 border-primary' : 'text-gray-500 hover:text-gray-700'}`}
              >
                Practice
              </button>
            </div>
          </div>

          {activeTab === 'review' ? renderReviewSection() : renderPracticeSection()}

          <VocabularyManagementModal isOpen={isManagementModalOpen} onClose={() => setIsManagementModalOpen(false)} vocabulary={vocabulary} addWord={addWord} updateWord={updateWord} deleteWord={deleteWord} />
        </div>
      );
    };

    // NEW: Prosody Practice Component
    const ProsodyPractice = ({ students, passages }) => {
      const [selectedStudent, setSelectedStudent] = useState('');
      const [selectedPassageId, setSelectedPassageId] = useState(Object.keys(passages).length > 0 ? Object.keys(passages)[0] : '');
      const [isRecording, setIsRecording] = useState(false);
      const [recordingTime, setRecordingTime] = useState(0);
      const [audioURL, setAudioURL] = useState(null);
      const [analysisResult, setAnalysisResult] = useState(null);
      const [isLoading, setIsLoading] = useState(false);
      const [isSaved, setIsSaved] = useState(false);

      const mediaRecorderRef = useRef(null);
      const audioChunksRef = useRef([]);
      const timerIntervalRef = useRef(null);

      // NEW: Audio Analysis Refs
      const audioContextRef = useRef(null);
      const analyserRef = useRef(null);
      const sourceRef = useRef(null);
      const dataCollectionIntervalRef = useRef(null);
      const recognitionRef = useRef(null);

      // NEW: Audio Data State
      const [transcript, setTranscript] = useState('');
      const [audioData, setAudioData] = useState({ pitch: [], volume: [] });

      const { saveProsodyResult } = useProsodyStorage();
      const currentPassage = useMemo(() => passages[parseInt(selectedPassageId, 10)], [passages, selectedPassageId]);

      const startRecording = async () => {
        if (!selectedStudent) {
          alert("Please select a student first.");
          return;
        }
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

          // Audio Context Setup for Pitch/Volume
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          audioContextRef.current = new AudioContext();
          analyserRef.current = audioContextRef.current.createAnalyser();
          analyserRef.current.fftSize = 2048;
          sourceRef.current = audioContextRef.current.createMediaStreamSource(stream);
          sourceRef.current.connect(analyserRef.current);

          const bufferLength = analyserRef.current.fftSize;
          const dataArray = new Float32Array(bufferLength);

          // Data Collection Loop
          setAudioData({ pitch: [], volume: [] });
          dataCollectionIntervalRef.current = setInterval(() => {
            if (!analyserRef.current) return;
            analyserRef.current.getFloatTimeDomainData(dataArray);

            // Calculate RMS (Volume/Stress)
            let sumSquares = 0;
            for (let i = 0; i < bufferLength; i++) {
              sumSquares += dataArray[i] * dataArray[i];
            }
            const rms = Math.sqrt(sumSquares / bufferLength);

            // Calculate Pitch (Autocorrelation)
            // Simplified YIN-like approach or Zero-crossing for performance
            let rL = 2048;
            let corr = new Float32Array(rL);
            for (let i = 0; i < rL; i++) {
              for (let j = 0; j < rL - i; j++) {
                corr[i] += dataArray[j] * dataArray[j + i];
              }
            }
            let d = 0;
            while (corr[d] > corr[d + 1]) d++;
            let maxval = -1, maxpos = -1;
            for (let i = d; i < rL; i++) {
              if (corr[i] > maxval) {
                maxval = corr[i];
                maxpos = i;
              }
            }
            let pitch = -1;
            if (maxpos > 0) {
              pitch = audioContextRef.current.sampleRate / maxpos;
            }

            setAudioData(prev => ({
              pitch: [...prev.pitch, pitch],
              volume: [...prev.volume, rms]
            }));
          }, 100); // Sample every 100ms

          // Speech Recognition Setup
          if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognitionRef.current = new SpeechRecognition();
            recognitionRef.current.continuous = true;
            recognitionRef.current.interimResults = true;
            recognitionRef.current.lang = 'en-US';
            recognitionRef.current.onresult = (event) => {
              let finalTranscript = '';
              for (let i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
              }
              if (finalTranscript) setTranscript(prev => prev + ' ' + finalTranscript);
            };
            recognitionRef.current.start();
          }

          // Media Recorder Setup
          mediaRecorderRef.current = new MediaRecorder(stream);
          audioChunksRef.current = [];
          setAudioURL(null);
          setAnalysisResult(null);
          setIsSaved(false);
          setTranscript(''); // Reset transcript

          mediaRecorderRef.current.ondataavailable = (event) => {
            audioChunksRef.current.push(event.data);
          };

          mediaRecorderRef.current.onstop = () => {
            const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/wav' });
            const url = URL.createObjectURL(audioBlob);
            setAudioURL(url);
            stream.getTracks().forEach(track => track.stop());
            if (audioContextRef.current) audioContextRef.current.close();
            if (recognitionRef.current) recognitionRef.current.stop();
            clearInterval(dataCollectionIntervalRef.current);
          };

          mediaRecorderRef.current.start();
          setIsRecording(true);
          setRecordingTime(0);
          timerIntervalRef.current = setInterval(() => {
            setRecordingTime(prev => prev + 1);
          }, 1000);
        } catch (err) {
          console.error("Error starting recording:", err);
          alert("Could not start recording. Please ensure microphone access is allowed.");
        }
      };

      const stopRecording = () => {
        if (mediaRecorderRef.current && mediaRecorderRef.current.state === 'recording') {
          mediaRecorderRef.current.stop();
        }
        setIsRecording(false);
        clearInterval(timerIntervalRef.current);
      };

      const handleToggleRecording = () => {
        isRecording ? stopRecording() : startRecording();
      };

      const analyzeProsodyReal = () => {
        setIsLoading(true);

        setTimeout(() => {
          // --- 1. Pitch Variation Analysis ---
          // Filter out unrealistic pitch values (e.g., < 50Hz or > 500Hz which might be noise)
          const validPitches = audioData.pitch.filter(p => p > 50 && p < 500);
          let pitchScore = 0;
          let pitchRange = 0;
          if (validPitches.length > 5) {
            const minPitch = Math.min(...validPitches);
            const maxPitch = Math.max(...validPitches);
            pitchRange = maxPitch - minPitch;

            // Scoring Rule: 50-120 Hz = full score
            if (pitchRange >= 50) pitchScore = 25;
            else if (pitchRange >= 20) pitchScore = 15; // Partial
            else pitchScore = 5; // Low
          }

          // --- 2. Speech Rate Analysis ---
          // Prefer transcript word count, fallback to passage word count estimation
          const wordCount = transcript.trim().length > 0 ? transcript.trim().split(/\s+/).length : (currentPassage.wordCount || 0);
          const wpm = recordingTime > 0 ? Math.round((wordCount / recordingTime) * 60) : 0;

          let rateScore = 0;
          // Ideal range: 100-150 WPM
          if (wpm >= 90 && wpm <= 160) rateScore = 25;
          else if (wpm >= 70 && wpm < 90) rateScore = 15;
          else if (wpm > 160 && wpm <= 180) rateScore = 15;
          else rateScore = 5;

          // --- 3. Pausing & Phrasing Analysis ---
          // Detect silence gaps (> 0.4s) based on low volume
          const SILENCE_THRESHOLD = 0.02; // RMS threshold
          let silenceBlocks = 0;
          let isSilent = false;
          let currentSilenceDuration = 0;

          audioData.volume.forEach(vol => {
            if (vol < SILENCE_THRESHOLD) {
              if (!isSilent) isSilent = true;
              currentSilenceDuration += 0.1; // 100ms blocks
            } else {
              if (isSilent && currentSilenceDuration > 0.4) {
                silenceBlocks++;
              }
              isSilent = false;
              currentSilenceDuration = 0;
            }
          });

          // Heuristic usage of punctuation count (approximate ideal pauses)
          const punctuationCount = (currentPassage.content.match(/[.,!?]/g) || []).length;
          let phrasingScore = 0;
          // Ideally, pauses should roughly match sentence structure
          const pauseRatio = silenceBlocks / (punctuationCount || 1);
          if (pauseRatio >= 0.8 && pauseRatio <= 1.5) phrasingScore = 25;
          else if (pauseRatio >= 0.5 && pauseRatio < 0.8) phrasingScore = 15;
          else phrasingScore = 10;

          // --- 4. Stress & Emphasis Analysis ---
          // Variance of volume (energy)
          const meanVol = audioData.volume.reduce((a, b) => a + b, 0) / (audioData.volume.length || 1);
          const variance = audioData.volume.reduce((a, b) => a + Math.pow(b - meanVol, 2), 0) / (audioData.volume.length || 1);
          const stdDev = Math.sqrt(variance);

          let stressScore = 0;
          // Higher variance typically means more dynamic range/emphasis
          if (stdDev > 0.05) stressScore = 25;
          else if (stdDev > 0.02) stressScore = 15;
          else stressScore = 5;

          const overallScore = pitchScore + rateScore + phrasingScore + stressScore;

          // Feedback Generation
          let feedback = [];
          if (rateScore < 20) feedback.push(wpm > 150 ? "Slow down a bit to be clearer." : "Try to read with a steadier, slightly faster pace.");
          else feedback.push("Good pacing.");

          if (pitchScore < 15) feedback.push("Try to vary your pitch more to sound more expressive.");
          else feedback.push("Excellent pitch variation.");

          if (stressScore < 15) feedback.push("Use more volume changes to emphasize important words.");

          const result = {
            scores: {
              phrasing: phrasingScore,
              intonation: pitchScore,  // Mapping Pitch to Intonation label
              stress: stressScore,
              rate: rateScore,
            },
            wpm,
            overallScore,
            feedback: feedback.join(' '),
            debug: { pitchRange: Math.round(pitchRange), volStdDev: stdDev.toFixed(4) } // For transparency
          };

          setAnalysisResult(result);

          // Automatically save the result
          if (selectedStudent) {
            saveProsodyResult(parseInt(selectedStudent, 10), parseInt(selectedPassageId, 10), result);
            setIsSaved(true);
          }

          setIsLoading(false);
        }, 1000);
      };

      const ProgressRing = ({ score }) => {
        const radius = 50;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (score / 100) * circumference;
        let colorClass = 'text-success';
        if (score < 80) colorClass = 'text-primary';
        if (score < 60) colorClass = 'text-warning';
        if (score < 40) colorClass = 'text-danger';

        return (
          <div className="relative flex items-center justify-center">
            <svg className="progress-ring w-32 h-32" viewBox="0 0 120 120">
              <circle className="text-gray-200" strokeWidth="10" stroke="currentColor" fill="transparent" r={radius} cx="60" cy="60" />
              <circle className={`progress-ring__circle ${colorClass}`} strokeWidth="10" strokeDasharray={circumference} strokeDashoffset={offset} stroke="currentColor" fill="transparent" r={radius} cx="60" cy="60" />
            </svg>
            <span className="absolute text-3xl font-bold">{score}</span>
          </div>
        );
      };

      if (!currentPassage) return <div className="p-6 bg-white rounded-lg shadow-md">No passages available. Please add a passage in the Reading Assessment tab.</div>;

      return (
        <div>
          <h2 className="text-2xl font-bold text-gray-800 mb-4">Prosody Practice</h2>
          <div className="bg-white rounded-lg shadow-md p-6 space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <select value={selectedStudent} onChange={e => setSelectedStudent(e.target.value)} className="block w-full rounded-md border-gray-300">
                <option value="">Select a student</option>
                {students.map(s => <option key={s.id} value={s.id.toString()}>{s.firstName} {s.lastName}</option>)}
              </select>
              <select value={selectedPassageId} onChange={e => setSelectedPassageId(e.target.value)} className="block w-full rounded-md border-gray-300">
                {Object.keys(passages).map(id => <option key={id} value={id}>{passages[parseInt(id, 10)].title}</option>)}
              </select>
            </div>

            <div className="bg-gray-50 border-l-4 border-primary p-4 rounded-r-md">
              <h4 className="text-xl font-bold text-gray-800 mb-2">{currentPassage.title}</h4>
              <p className="text-gray-700 leading-relaxed">{currentPassage.content}</p>
            </div>

            <div className="flex flex-wrap items-center justify-center gap-4 p-4 border rounded-lg">
              <button onClick={handleToggleRecording} className={`flex items-center gap-3 px-6 py-3 text-lg font-semibold text-white rounded-lg shadow-md transition-transform transform hover:scale-105 ${isRecording ? 'bg-danger' : 'bg-success'}`}>
                {isRecording ? <div className="recording-dot animate-pulse"></div> : <MicrophoneIcon className="w-6 h-6" />}
                {isRecording ? 'Stop Recording' : 'Start Recording'}
              </button>
              {isRecording && <span className="text-lg font-mono">Time: {new Date(recordingTime * 1000).toISOString().substr(14, 5)}</span>}
            </div>

            {audioURL && (
              <div className="p-4 border rounded-lg bg-gray-50 space-y-4">
                <h3 className="text-lg font-semibold">Recording & Analysis</h3>
                <audio src={audioURL} controls className="w-full" />
                <button onClick={analyzeProsodyReal} disabled={isLoading} className="px-4 py-2 bg-secondary text-white font-bold rounded-lg shadow-md hover:bg-gray-700 disabled:opacity-50">
                  {isLoading ? 'Analyzing Audio...' : 'Analyze Prosody'}
                </button>
              </div>
            )}

            {isLoading && <LoadingSpinner />}

            {analysisResult && (
              <div className="p-6 border-2 border-dashed rounded-lg">
                <h3 className="text-2xl font-bold text-center mb-6">Prosody Analysis Report</h3>
                <div className="grid grid-cols-1 md:grid-cols-5 gap-6 items-center">
                  <div className="md:col-span-2 flex justify-center">
                    <ProgressRing score={analysisResult.overallScore} />
                  </div>
                  <div className="md:col-span-3 space-y-4">
                    <div className="prosody-score-card flex justify-between items-center bg-blue-50 p-3 rounded-lg">
                      <span className="font-semibold">Phrasing</span><span className="font-bold text-blue-600">{analysisResult.scores.phrasing}/100</span>
                    </div>
                    <div className="prosody-score-card flex justify-between items-center bg-green-50 p-3 rounded-lg">
                      <span className="font-semibold">Intonation</span><span className="font-bold text-green-600">{analysisResult.scores.intonation}/100</span>
                    </div>
                    <div className="prosody-score-card flex justify-between items-center bg-yellow-50 p-3 rounded-lg">
                      <span className="font-semibold">Stress</span><span className="font-bold text-yellow-600">{analysisResult.scores.stress}/100</span>
                    </div>
                    <div className="prosody-score-card flex justify-between items-center bg-red-50 p-3 rounded-lg">
                      <span className="font-semibold">Rate ({analysisResult.wpm} WPM)</span><span className="font-bold text-red-600">{analysisResult.scores.rate}/100</span>
                    </div>
                  </div>
                </div>
                <div className="mt-6 text-center bg-gray-100 p-4 rounded-lg">
                  <p className="font-semibold">Feedback:</p>
                  <p className="text-gray-700">{analysisResult.feedback}</p>
                </div>
                {isSaved && (
                  <div className="mt-6 text-center text-sm text-success font-medium flex items-center justify-center gap-1">
                    <svg className="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Result automatically saved to student's record.
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      );
    };

    // Main Reading Drill Component
    const ReadingDrill = () => {
      const [drillData, setDrillData] = useLocalStorage('echoText-drillData', defaultDrillData);
      const [activeDrill, setActiveDrill] = useState('letterSounds');
      const [isManagementModalOpen, setIsManagementModalOpen] = useState(false);

      const {
        voices,
        selectedVoice,
        setSelectedVoice,
        speak,
        cancel,
        isSpeaking,
        isSupported,
        rate,
        setRate,
        pitch,
        setPitch,
        volume,
        setVolume,
        previewVoice
      } = useSpeechSynthesis();

      const handleUpdateDrill = (drillType, updatedData) => {
        setDrillData(prev => ({
          ...prev,
          [drillType]: updatedData
        }));
      };

      const drillComponents = {
        letterSounds: (
          <LetterSoundRecognition
            drillData={drillData.letterSounds}
            onUpdateDrill={handleUpdateDrill}
            speak={speak}
            isSpeaking={isSpeaking}
            selectedVoice={selectedVoice}
            voices={voices}
            setSelectedVoice={setSelectedVoice}
            rate={rate}
            setRate={setRate}
            pitch={pitch}
            setPitch={setPitch}
            volume={volume}
            setVolume={setVolume}
            previewVoice={previewVoice}
          />
        ),
        cvcWords: (
          <CVCWordPractice
            drillData={drillData.cvcWords}
            onUpdateDrill={handleUpdateDrill}
            speak={speak}
            isSpeaking={isSpeaking}
            selectedVoice={selectedVoice}
            voices={voices}
            setSelectedVoice={setSelectedVoice}
            rate={rate}
            setRate={setRate}
            pitch={pitch}
            setPitch={setPitch}
            volume={volume}
            setVolume={setVolume}
            previewVoice={previewVoice}
          />
        ),
        fullerMethod: (
          <FullerMethod
            drillData={drillData.fullerMethod}
            onUpdateDrill={handleUpdateDrill}
            speak={speak}
            isSpeaking={isSpeaking}
            selectedVoice={selectedVoice}
            voices={voices}
            setSelectedVoice={setSelectedVoice}
            rate={rate}
            setRate={setRate}
            pitch={pitch}
            setPitch={setPitch}
            volume={volume}
            setVolume={setVolume}
            previewVoice={previewVoice}
          />
        ),
        soundBlending: (
          <SoundBlending
            drillData={drillData.soundBlending}
            onUpdateDrill={handleUpdateDrill}
            speak={speak}
            isSpeaking={isSpeaking}
            selectedVoice={selectedVoice}
            voices={voices}
            setSelectedVoice={setSelectedVoice}
            rate={rate}
            setRate={setRate}
            pitch={pitch}
            setPitch={setPitch}
            volume={volume}
            setVolume={setVolume}
            previewVoice={previewVoice}
          />
        )
      };

      const drillLabels = {
        letterSounds: 'Letter Sound Recognition',
        cvcWords: 'CVC Word Practice',
        fullerMethod: 'Fuller Method',
        soundBlending: 'Sound Blending'
      };

      return (
        <div>
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-2xl font-bold text-gray-800">Reading Drill</h2>
            <button
              onClick={() => setIsManagementModalOpen(true)}
              className="flex items-center gap-2 px-4 py-2 text-white bg-primary rounded-md shadow-sm hover:bg-blue-600"
            >
              <EditIcon className="w-5 h-5" />
              Manage Drills
            </button>
          </div>

          <div className="bg-white rounded-lg shadow-md mb-6">
            <div className="flex border-b">
              {Object.keys(drillComponents).map(drillType => (
                <button
                  key={drillType}
                  onClick={() => setActiveDrill(drillType)}
                  className={`flex-1 px-4 py-3 text-center font-medium ${activeDrill === drillType
                    ? 'text-primary border-b-2 border-primary'
                    : 'text-gray-500 hover:text-gray-700'
                    } ${!drillData[drillType].enabled ? 'opacity-50' : ''}`}
                  disabled={!drillData[drillType].enabled}
                >
                  {drillLabels[drillType]}
                  {!drillData[drillType].enabled && (
                    <span className="ml-2 text-xs text-gray-400">(Disabled)</span>
                  )}
                </button>
              ))}
            </div>

            <div className="p-6">
              {drillData[activeDrill].enabled ? (
                drillComponents[activeDrill]
              ) : (
                <div className="text-center py-10">
                  <p className="text-lg text-gray-500 mb-4">
                    This drill is currently disabled.
                  </p>
                  <button
                    onClick={() => setIsManagementModalOpen(true)}
                    className="px-4 py-2 text-white bg-primary rounded-md hover:bg-blue-600"
                  >
                    Enable in Drill Management
                  </button>
                </div>
              )}
            </div>
          </div>

          <DrillManagementModal
            isOpen={isManagementModalOpen}
            onClose={() => setIsManagementModalOpen(false)}
            drillData={drillData}
            onUpdateDrill={handleUpdateDrill}
          />
        </div>
      );
    };

    // UPDATED: Dashboard Component with corrected reading progress and weeks completed
    const Dashboard = ({ students, assessments, attendance }) => {
      const [selectedStudentId, setSelectedStudentId] = useState('');
      const [settings] = useAssessmentSettings();

      const getPhilIriLevel = (wordRecognition, comprehension) => {
        if (wordRecognition === undefined || comprehension === undefined) return { level: 'Not Assessed', class: 'bg-gray-400 text-white' };
        if (wordRecognition >= 97 && comprehension >= 80) return { level: 'Independent', class: 'bg-success text-white' };
        if (wordRecognition >= 90 && comprehension >= 59) return { level: 'Instructional', class: 'bg-primary text-white' };
        if (wordRecognition < 1 || comprehension < 1) return { level: 'Non-Reader', class: 'bg-danger text-white' };
        if (wordRecognition < 90 || comprehension < 59) return { level: 'Frustration', class: 'bg-warning text-white' };
        return { level: 'Not Assessed', class: 'bg-gray-400 text-white' };
      };

      const stats = useMemo(() => {
        const totalStudents = students.length;
        let totalPresents = 0;
        let totalAttendanceRecords = 0;
        Object.values(attendance).forEach(weekData => {
          Object.values(weekData).forEach((record) => {
            if (record.status === 'present') totalPresents++;
            totalAttendanceRecords++;
          });
        });
        const avgAttendance = totalAttendanceRecords > 0 ? Math.round((totalPresents / totalAttendanceRecords) * 100) : 0;
        let totalProgress = 0;
        let assessedStudents = 0;
        Object.values(assessments).forEach(studentAssessments => {
          if (studentAssessments.length > 0) {
            totalProgress += studentAssessments[studentAssessments.length - 1].wordRecognition;
            assessedStudents++;
          }
        });
        const avgProgress = assessedStudents > 0 ? Math.round(totalProgress / assessedStudents) : 0;

        // CORRECTED: Calculate actual weeks completed based on assessment data
        let weeksCompleted = 0;
        Object.values(assessments).forEach(studentAssessments => {
          if (studentAssessments.length > 0) {
            const maxWeek = Math.max(...studentAssessments.map(a => a.week));
            weeksCompleted = Math.max(weeksCompleted, maxWeek);
          }
        });

        return { totalStudents, avgAttendance, avgProgress, weeksCompleted: Math.min(weeksCompleted, settings.totalWeeks) };
      }, [students, attendance, assessments, settings]);

      // Calculate reading profile distribution for the Vertical Bar Graph
      const readingProfileDistribution = useMemo(() => {
        const counts = { 'Independent': 0, 'Instructional': 0, 'Frustration': 0, 'Non-Reader': 0, 'Not Assessed': 0 };

        students.forEach(student => {
          const studentAssessments = assessments[student.id];
          if (studentAssessments && studentAssessments.length > 0) {
            const latest = studentAssessments[studentAssessments.length - 1];
            const { level } = getPhilIriLevel(latest.wordRecognition, latest.comprehension);
            if (counts.hasOwnProperty(level)) {
              counts[level]++;
            } else {
              counts['Not Assessed']++;
            }
          } else {
            counts['Not Assessed']++;
          }
        });

        return [
          { label: 'Independent', count: counts['Independent'], color: 'bg-success', hex: '#2ecc71' },
          { label: 'Instructional', count: counts['Instructional'], color: 'bg-primary', hex: '#3498db' },
          { label: 'Frustration', count: counts['Frustration'], color: 'bg-warning', hex: '#f39c12' },
          { label: 'Non-Reader', count: counts['Non-Reader'], color: 'bg-danger', hex: '#e74c3c' },
          { label: 'Not Assessed', count: counts['Not Assessed'], color: 'bg-gray-400', hex: '#95a5a6' }
        ];
      }, [students, assessments]);

      const selectedStudentProgress = useMemo(() => {
        if (!selectedStudentId) return null;
        const studentAssessments = assessments[parseInt(selectedStudentId)];
        if (!studentAssessments || studentAssessments.length === 0) return null;
        return studentAssessments[studentAssessments.length - 1];
      }, [selectedStudentId, assessments]);

      // NEW: Student progress data for bar graph
      const studentProgressData = useMemo(() => {
        return students.map(student => {
          const studentAssessments = assessments[student.id] || [];
          const latestAssessment = studentAssessments.length > 0
            ? studentAssessments[studentAssessments.length - 1]
            : null;

          return {
            name: `${student.firstName} ${student.lastName}`,
            progress: latestAssessment ? latestAssessment.wordRecognition : 0,
            level: latestAssessment ? getPhilIriLevel(latestAssessment.wordRecognition, latestAssessment.comprehension).level : 'Not Assessed'
          };
        }, [students, assessments]);
      }, [students, assessments]);

      const ProgressBar = ({ value, color, label, text }) => (
        <div className="mb-3">
          <label className="form-label text-sm text-gray-600">{label}</label>
          <div className="w-full bg-gray-200 rounded-full h-6">
            <div
              className={`${color} h-6 rounded-full flex items-center justify-center text-white text-sm font-medium`}
              style={{ width: `${value}%` }}
            >
              {text || `${value}%`}
            </div>
          </div>
        </div>
      );

      // NEW: Bar Graph Component
      const BarGraph = ({ data, title }) => {
        const maxValue = Math.max(...data.map(item => item.progress), 100);

        return (
          <div className="bg-white p-4 rounded-lg shadow-md">
            <h3 className="text-lg font-semibold text-gray-800 mb-4">{title}</h3>
            <div className="bar-graph">
              {data.map((item, index) => (
                <div
                  key={index}
                  className="bar"
                  style={{ height: `${(item.progress / maxValue) * 100}%` }}
                  title={`${item.name}: ${item.progress}% (${item.level})`}
                >
                  <div className="bar-value">{item.progress}%</div>
                  <div className="bar-label">
                    {item.name.split(' ')[0]}
                  </div>
                </div>
              ))}
            </div>
            <div className="mt-4 grid grid-cols-2 gap-2 text-xs">
              {data.map((item, index) => (
                <div key={index} className="flex items-center">
                  <div
                    className="w-3 h-3 rounded-full mr-2"
                    style={{
                      backgroundColor:
                        item.level === 'Independent' ? '#2ecc71' :
                          item.level === 'Instructional' ? '#3498db' :
                            item.level === 'Frustration' ? '#f39c12' :
                              item.level === 'Non-Reader' ? '#e74c3c' : '#95a5a6'
                    }}
                  ></div>
                  <span className="truncate">{item.name}: {item.progress}%</span>
                </div>
              ))}
            </div>
          </div>
        );
      };

      return (
        <div>
          <h2 className="text-2xl font-bold text-gray-800 mb-6">Dashboard</h2>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 mb-6">
            <div className="bg-blue-100 text-primary p-5 rounded-lg shadow-md text-center"><p className="text-3xl font-bold">{stats.totalStudents}</p><p>Students Enrolled</p></div>
            <div className="bg-green-100 text-success p-5 rounded-lg shadow-md text-center"><p className="text-3xl font-bold">{stats.avgAttendance}%</p><p>Average Attendance</p></div>
            <div className="bg-yellow-100 text-warning p-5 rounded-lg shadow-md text-center"><p className="text-3xl font-bold">{stats.avgProgress}%</p><p>Reading Progress</p></div>
            <div className="bg-red-100 text-danger p-5 rounded-lg shadow-md text-center"><p className="text-3xl font-bold">{stats.weeksCompleted}/{settings.totalWeeks}</p><p>Weeks Completed</p></div>
          </div>
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">

            {/* Enhanced Vertical Bar Chart for Reading Profile Summary */}
            <div className="bg-white rounded-lg shadow-md lg:col-span-2">
              <div className="px-6 py-4 border-b bg-gradient-to-br from-primary to-secondary text-white rounded-t-lg">
                <h5 className="text-lg font-semibold">Reading Profile Summary</h5>
              </div>
              <div className="p-6">
                {/* Bar Chart Container - Zero at bottom */}
                <div className="flex items-end h-64 px-4 pb-2 space-x-2 md:space-x-4">
                  {readingProfileDistribution.map((item, index) => {
                    // Calculate max value for scaling
                    const maxValue = Math.max(...readingProfileDistribution.map(d => d.count), 1);

                    // Calculate height with minimum 5% for visibility
                    const calculatedHeight = (item.count / maxValue) * 100;
                    const barHeight = Math.max(5, calculatedHeight); // Minimum 5% height

                    // Use gradient colors for bars
                    const gradientColors = {
                      'Independent': 'from-green-400 to-green-600',
                      'Instructional': 'from-blue-400 to-blue-600',
                      'Frustration': 'from-yellow-400 to-yellow-600',
                      'Non-Reader': 'from-red-400 to-red-600',
                      'Not Assessed': 'from-gray-400 to-gray-600'
                    };

                    const gradientClass = gradientColors[item.label] || 'from-gray-400 to-gray-600';

                    return (
                      <div
                        key={index}
                        className="flex flex-col items-center justify-end flex-1 h-full group relative"
                        style={{ height: '100%' }}
                      >
                        {/* Bar with gradient and animation - GROWS UP FROM BOTTOM */}
                        <div
                          className={`w-3/4 max-w-[60px] rounded-t-lg bg-gradient-to-t ${gradientClass} transition-all duration-700 ease-out hover:brightness-110 hover:scale-105 relative`}
                          style={{
                            height: `${barHeight}%`,
                            minHeight: '20px' // Absolute minimum height
                          }}
                          title={`${item.label}: ${item.count} students`}
                        >
                          {/* Tooltip on hover */}
                          <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-300 whitespace-nowrap pointer-events-none z-10">
                            <div className="font-semibold">{item.label}</div>
                            <div>{item.count} students</div>
                            <div className="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                          </div>

                          {/* Bar value inside bar (visible on hover) */}
                          <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <span className="text-white font-bold text-sm drop-shadow-lg">
                              {item.count}
                            </span>
                          </div>

                          {/* Count value displayed on top of bar */}
                          <div className="absolute -top-6 left-1/2 transform -translate-x-1/2 text-sm font-semibold text-gray-700">
                            {item.count}
                          </div>
                        </div>

                        {/* Category label at the very bottom */}
                        <div className="mt-2 text-center w-full">
                          <span className="text-xs font-semibold text-gray-600 block truncate px-1">
                            {item.label}
                          </span>
                          <span className="text-xs text-gray-500 mt-1 block">
                            {students.length > 0 ? `${Math.round((item.count / students.length) * 100)}%` : '0%'}
                          </span>
                        </div>
                      </div>
                    );
                  })}
                </div>

                {/* Baseline at zero - Optional visual indicator */}
                <div className="mt-2 px-4">
                  <div className="border-t border-gray-300 pt-2 text-xs text-gray-500">
                    Reading Profile Distribution
                  </div>
                </div>
              </div>
            </div>
            <div className="bg-white rounded-lg shadow-md">
              <div className="px-6 py-4 border-b bg-gradient-to-br from-primary to-secondary text-white rounded-t-lg"><h5 className="text-lg font-semibold">Reading Progress</h5></div>
              <div className="p-6">
                <select className="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm mb-4" value={selectedStudentId} onChange={e => setSelectedStudentId(e.target.value)}>
                  <option value="">Select a student</option>
                  {students.map(s => <option key={s.id} value={s.id}>{s.firstName} {s.lastName}</option>)}
                </select>
                {selectedStudentProgress ? (
                  <>
                    <ProgressBar value={selectedStudentProgress.wordRecognition} color="bg-primary" label="Overall Progress" />
                    <ProgressBar value={selectedStudentProgress.wordRecognition} color="bg-success" label="Word Recognition" />
                    <ProgressBar value={selectedStudentProgress.readingSpeed} color="bg-blue-400" label="Reading Speed" text={`${selectedStudentProgress.readingSpeed} WPM`} />
                    <ProgressBar value={selectedStudentProgress.comprehension} color="bg-warning" label="Comprehension" />
                  </>
                ) : (
                  <div className="text-center text-gray-500 pt-8">Select a student to view their progress.</div>
                )}
              </div>
            </div>
          </div>

          {/* NEW: Student Progress Bar Graph */}
          <div className="mt-6">
            <BarGraph
              data={studentProgressData}
              title="Student Reading Progress Overview"
            />
          </div>
        </div>
      );
    };

    // From components/StudentManagement.tsx
    const StudentForm = ({ onSave, onClose, studentToEdit }) => {
      const [formData, setFormData] = useState({
        firstName: studentToEdit?.firstName || '',
        lastName: studentToEdit?.lastName || '',
        gradeLevel: studentToEdit?.gradeLevel || '',
        section: studentToEdit?.section || '',
      });

      const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!formData.firstName || !formData.lastName || !formData.gradeLevel) {
          alert("Please fill in all required fields.");
          return;
        }
        onSave({ id: studentToEdit?.id, ...formData });
      };

      return (
        <form onSubmit={handleSubmit}>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700">First Name</label>
              <input type="text" name="firstName" value={formData.firstName} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm" required />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">Last Name</label>
              <input type="text" name="lastName" value={formData.lastName} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm" required />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">Grade Level</label>
              <select name="gradeLevel" value={formData.gradeLevel} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm" required>
                <option value="">Select Grade Level</option>
                {['Kinder', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'].map(grade =>
                  <option key={grade} value={grade}>{grade === 'Kinder' ? 'Kindergarten' : `Grade ${grade}`}</option>
                )}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">Section</label>
              <input type="text" name="section" value={formData.section} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm" />
            </div>
          </div>
          <div className="flex justify-end gap-2 mt-6">
            <button type="button" onClick={onClose} className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
            <button type="submit" className="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-blue-600">Save Student</button>
          </div>
        </form>
      );
    };

    const StudentManagement = ({ students, setStudents, onDeleteStudent }) => {
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [studentToEdit, setStudentToEdit] = useState(null);

      const handleOpenModal = (student) => {
        setStudentToEdit(student || null);
        setIsModalOpen(true);
      };

      const handleCloseModal = () => {
        setIsModalOpen(false);
        setStudentToEdit(null);
      };

      const handleSaveStudent = (studentData) => {
        if (studentData.id) {
          setStudents(students.map(s => s.id === studentData.id ? { ...s, ...studentData } : s));
        } else {
          const newStudent = {
            ...studentData,
            id: students.length > 0 ? Math.max(...students.map(s => s.id)) + 1 : 1,
          };
          setStudents([...students, newStudent]);
        }
        handleCloseModal();
      };

      return (
        <div>
          <h2 className="text-2xl font-bold text-gray-800 mb-4">Student Management</h2>
          <div className="mb-6 flex justify-end">
            <button onClick={() => handleOpenModal()} className="flex items-center gap-2 px-4 py-2 text-white bg-primary rounded-md shadow-sm hover:bg-blue-600">
              <PlusIcon className="w-5 h-5" /> Enroll New Student
            </button>
          </div>

          <div className="bg-white rounded-lg shadow-md">
            <div className="px-6 py-4 border-b">
              <h5 className="text-lg font-semibold mb-0">Student List</h5>
            </div>
            <div className="p-4">
              <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade Level</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Section</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {students.map(student => (
                      <tr key={student.id} className="hover:bg-gray-50">
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{student.id}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{`${student.firstName} ${student.lastName}`}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{student.gradeLevel === 'Kinder' ? 'Kindergarten' : `Grade ${student.gradeLevel}`}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{student.section}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                          <button onClick={() => handleOpenModal(student)} className="text-warning hover:text-yellow-600 mr-3">
                            <EditIcon className="w-5 h-5" />
                          </button>
                          <button onClick={() => onDeleteStudent(student.id)} className="text-danger hover:text-red-600">
                            <TrashIcon className="w-5 h-5" />
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <Modal isOpen={isModalOpen} onClose={handleCloseModal} title={studentToEdit ? 'Edit Student' : 'Enroll New Student'}>
            <StudentForm onSave={handleSaveStudent} onClose={handleCloseModal} studentToEdit={studentToEdit} />
          </Modal>
        </div>
      );
    };

    // UPDATED: AttendanceComponent to use configurable weeks
    const AttendanceComponent = ({ students, attendance, setAttendance }) => {
      const [settings] = useAssessmentSettings();
      const [currentWeek, setCurrentWeek] = useState(1);
      const [weeklyData, setWeeklyData] = useState(attendance[currentWeek] || {});

      useEffect(() => {
        setWeeklyData(attendance[currentWeek] || {});
      }, [currentWeek, attendance]);

      const handleDataChange = (studentId, field, value) => {
        setWeeklyData(prev => ({
          ...prev,
          [studentId]: {
            ...(prev[studentId] || { status: 'present', score: 0 }),
            [field]: value
          }
        }));
      };

      const handleSaveAttendance = () => {
        const updatedAttendance = { ...attendance, [currentWeek]: weeklyData };
        setAttendance(updatedAttendance);
        alert('Attendance for ' + (settings.reportPeriod === 'weeks' ? 'Week ' : 'Day ') + currentWeek + ' saved successfully!');
      };

      const attendanceSummary = useMemo(() => {
        return students.map(student => {
          let presentCount = 0;
          const weeklyStatuses = Array.from({ length: settings.totalWeeks }, (_, i) => {
            const week = i + 1;
            const record = attendance[week]?.[student.id];
            if (record?.status === 'present') {
              presentCount++;
            }
            return record?.status || 'N/A';
          });
          return {
            studentName: `${student.firstName} ${student.lastName}`,
            statuses: weeklyStatuses,
            total: `${presentCount}/${settings.totalWeeks}`
          };
        }, [students, attendance, settings]);
      }, [students, attendance, settings]);

      return (
        <div>
          <h2 className="text-2xl font-bold text-gray-800 mb-4">Attendance Tracking</h2>
          <div className="bg-white rounded-lg shadow-md mb-6">
            <div className="px-6 py-4 border-b flex justify-between items-center">
              <h5 className="text-lg font-semibold mb-0">{settings.totalWeeks}-{settings.reportPeriod === 'weeks' ? 'Week' : 'Day'} Attendance Record</h5>
              <div className="flex items-center gap-4">
                <select
                  className="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm"
                  value={currentWeek}
                  onChange={e => setCurrentWeek(parseInt(e.target.value))}
                >
                  {Array.from({ length: settings.totalWeeks }, (_, i) => (
                    <option key={i + 1} value={i + 1}>{settings.reportPeriod === 'weeks' ? 'Week ' : 'Day '}{i + 1}</option>
                  ))}
                </select>
                <button onClick={handleSaveAttendance} className="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-blue-600">Save</button>
              </div>
            </div>
            <div className="p-4">
              <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50"><tr>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Student Name</th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Daily Score</th>
                  </tr></thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {students.map(student => (
                      <tr key={student.id}>
                        <td className="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{student.firstName} {student.lastName}</td>
                        <td className="px-4 py-4">
                          <select
                            className="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm"
                            value={weeklyData[student.id]?.status || 'present'}
                            onChange={e => handleDataChange(student.id, 'status', e.target.value)}
                          >
                            <option value="present">Present</option>
                            <option value="absent">Absent</option>
                          </select>
                        </td>
                        <td className="px-4 py-4">
                          <input
                            type="number"
                            className="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm"
                            min="0"
                            max="100"
                            value={weeklyData[student.id]?.score || ''}
                            onChange={e => handleDataChange(student.id, 'score', parseInt(e.target.value) || 0)}
                          />
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div className="bg-white rounded-lg shadow-md">
            <div className="px-6 py-4 border-b"><h5 className="text-lg font-semibold mb-0">Attendance Summary</h5></div>
            <div className="p-4">
              <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200 border">
                  <thead className="bg-gray-50"><tr>
                    <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase border">Student</th>
                    {Array.from({ length: settings.totalWeeks }, (_, i) => <th key={i} className="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase border">{settings.reportPeriod === 'weeks' ? 'W' : 'D'}{i + 1}</th>)}
                    <th className="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase border">Total</th>
                  </tr></thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {attendanceSummary.map(summary => (
                      <tr key={summary.studentName}>
                        <td className="px-2 py-2 whitespace-nowrap text-sm font-medium text-gray-900 border">{summary.studentName}</td>
                        {summary.statuses.map((status, index) => (
                          <td key={index} className="px-2 py-2 text-center border">
                            {status === 'present' && <span className="text-success">âœ”</span>}
                            {status === 'absent' && <span className="text-danger">âœ–</span>}
                            {status === 'N/A' && <span className="text-gray-400">-</span>}
                          </td>
                        ))}
                        <td className="px-2 py-2 text-center text-sm font-medium border">{summary.total}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // UPDATED: Question Management Modal Component
    const QuestionManagementModal = ({ isOpen, onClose, passages, setPassages, selectedPassageId }) => {
      const [editingQuestion, setEditingQuestion] = useState(null);
      const currentPassage = passages[parseInt(selectedPassageId, 10)];
      const questions = currentPassage?.quiz || [];

      const handleAddQuestion = () => {
        setEditingQuestion({
          id: null,
          question: '',
          type: 'multiple-choice',
          points: 1,
          options: [
            { letter: 'A', text: '' },
            { letter: 'B', text: '' },
            { letter: 'C', text: '' },
            { letter: 'D', text: '' }
          ],
          correctAnswer: 'A'
        });
      };

      const handleEditQuestion = (question) => {
        setEditingQuestion({ ...question });
      };

      const handleDeleteQuestion = (questionId) => {
        if (window.confirm('Are you sure you want to delete this question?')) {
          const updatedQuestions = questions.filter(q => q.id !== questionId);
          setPassages(prev => ({
            ...prev,
            [parseInt(selectedPassageId, 10)]: {
              ...prev[parseInt(selectedPassageId, 10)],
              quiz: updatedQuestions
            }
          }));
        }
      };

      const handleSaveQuestion = () => {
        if (!editingQuestion.question.trim()) {
          alert('Please enter a question.');
          return;
        }

        if ((editingQuestion.type === 'multiple-choice' || editingQuestion.type === 'true-false') &&
          editingQuestion.options.some(opt => !opt.text.trim())) {
          alert('Please fill in all options.');
          return;
        }

        const updatedQuestions = [...questions];

        if (editingQuestion.id) {
          // Update existing question
          const index = updatedQuestions.findIndex(q => q.id === editingQuestion.id);
          if (index !== -1) {
            updatedQuestions[index] = editingQuestion;
          }
        } else {
          // Add new question
          const newQuestion = {
            ...editingQuestion,
            id: Date.now()
          };
          updatedQuestions.push(newQuestion);
        }

        setPassages(prev => ({
          ...prev,
          [parseInt(selectedPassageId, 10)]: {
            ...prev[parseInt(selectedPassageId, 10)],
            quiz: updatedQuestions
          }
        }));

        setEditingQuestion(null);
      };

      const handleOptionChange = (index, text) => {
        const newOptions = [...editingQuestion.options];
        newOptions[index].text = text;
        setEditingQuestion(prev => ({ ...prev, options: newOptions }));
      };

      const handleAddOption = () => {
        const newLetter = String.fromCharCode(65 + editingQuestion.options.length); // A, B, C, etc.
        setEditingQuestion(prev => ({
          ...prev,
          options: [...prev.options, { letter: newLetter, text: '' }]
        }));
      };

      const handleRemoveOption = (index) => {
        if (editingQuestion.options.length <= 2) {
          alert('A question must have at least 2 options.');
          return;
        }
        const newOptions = [...editingQuestion.options];
        newOptions.splice(index, 1);
        // Reassign letters
        newOptions.forEach((opt, idx) => {
          opt.letter = String.fromCharCode(65 + idx);
        });
        setEditingQuestion(prev => ({
          ...prev,
          options: newOptions,
          correctAnswer: prev.correctAnswer === editingQuestion.options[index].letter ? 'A' : prev.correctAnswer
        }));
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Manage Comprehension Questions">
          {editingQuestion ? (
            <div className="space-y-4">
              <h4 className="text-lg font-semibold">
                {editingQuestion.id ? 'Edit Question' : 'Add New Question'}
              </h4>

              <div>
                <label className="block text-sm font-medium text-gray-700">Question</label>
                <textarea
                  value={editingQuestion.question}
                  onChange={(e) => setEditingQuestion(prev => ({ ...prev, question: e.target.value }))}
                  className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                  rows="3"
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700">Question Type</label>
                  <select
                    value={editingQuestion.type}
                    onChange={(e) => setEditingQuestion(prev => ({
                      ...prev,
                      type: e.target.value,
                      options: e.target.value === 'true-false'
                        ? [{ letter: 'A', text: 'True' }, { letter: 'B', text: 'False' }]
                        : prev.options
                    }))}
                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                  >
                    <option value="multiple-choice">Multiple Choice</option>
                    <option value="true-false">True or False</option>
                    <option value="short-answer">Short Answer</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">Points</label>
                  <input
                    type="number"
                    value={editingQuestion.points}
                    onChange={(e) => setEditingQuestion(prev => ({ ...prev, points: parseInt(e.target.value) || 1 }))}
                    min="1"
                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                  />
                </div>
              </div>

              {(editingQuestion.type === 'multiple-choice' || editingQuestion.type === 'true-false') && (
                <div>
                  <div className="flex justify-between items-center mb-2">
                    <label className="block text-sm font-medium text-gray-700">Options</label>
                    {editingQuestion.type === 'multiple-choice' && (
                      <button
                        type="button"
                        onClick={handleAddOption}
                        className="text-sm text-primary hover:text-blue-600"
                      >
                        + Add Option
                      </button>
                    )}
                  </div>
                  {editingQuestion.options.map((opt, index) => (
                    <div key={index} className="flex items-center gap-2 mb-2">
                      <input
                        type="radio"
                        name="correctAnswer"
                        value={opt.letter}
                        checked={editingQuestion.correctAnswer === opt.letter}
                        onChange={() => setEditingQuestion(prev => ({ ...prev, correctAnswer: opt.letter }))}
                        className="form-radio h-4 w-4 text-primary"
                      />
                      <span className="font-semibold w-6">{opt.letter}.</span>
                      <input
                        type="text"
                        value={opt.text}
                        onChange={(e) => handleOptionChange(index, e.target.value)}
                        className="flex-1 block rounded-md border-gray-300 shadow-sm"
                        disabled={editingQuestion.type === 'true-false'}
                      />
                      {editingQuestion.type === 'multiple-choice' && editingQuestion.options.length > 2 && (
                        <button
                          type="button"
                          onClick={() => handleRemoveOption(index)}
                          className="text-danger hover:text-red-600"
                        >
                          <TrashIcon className="w-4 h-4" />
                        </button>
                      )}
                    </div>
                  ))}
                </div>
              )}

              {editingQuestion.type === 'short-answer' && (
                <div>
                  <label className="block text-sm font-medium text-gray-700">Correct Answer</label>
                  <input
                    type="text"
                    value={editingQuestion.correctAnswer || ''}
                    onChange={(e) => setEditingQuestion(prev => ({ ...prev, correctAnswer: e.target.value }))}
                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                  />
                </div>
              )}

              <div className="flex justify-end gap-2 pt-4">
                <button
                  type="button"
                  onClick={() => setEditingQuestion(null)}
                  className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300"
                >
                  Cancel
                </button>
                <button
                  type="button"
                  onClick={handleSaveQuestion}
                  className="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-blue-600"
                >
                  Save Question
                </button>
              </div>
            </div>
          ) : (
            <div>
              <div className="flex justify-between items-center mb-4">
                <h4 className="text-lg font-semibold">
                  Questions for {currentPassage?.title}
                </h4>
                <button
                  onClick={handleAddQuestion}
                  className="flex items-center gap-2 px-4 py-2 text-white bg-primary rounded-md shadow-sm hover:bg-blue-600"
                >
                  <PlusIcon className="w-5 h-5" />
                  Add Question
                </button>
              </div>

              {questions.length === 0 ? (
                <div className="text-center py-8 text-gray-500">
                  No questions have been added to this passage yet.
                </div>
              ) : (
                <div className="space-y-4 max-h-96 overflow-y-auto">
                  {questions.map((question, index) => (
                    <div key={question.id} className="p-4 border rounded-md bg-gray-50">
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <p className="font-semibold">{index + 1}. {question.question}</p>
                          <div className="flex gap-4 mt-1 text-sm text-gray-500">
                            <span>Type: {question.type}</span>
                            <span>Points: {question.points}</span>
                          </div>
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={() => handleEditQuestion(question)}
                            className="text-warning hover:text-yellow-600"
                          >
                            <EditIcon className="w-5 h-5" />
                          </button>
                          <button
                            onClick={() => handleDeleteQuestion(question.id)}
                            className="text-danger hover:text-red-600"
                          >
                            <TrashIcon className="w-5 h-5" />
                          </button>
                        </div>
                      </div>

                      {(question.type === 'multiple-choice' || question.type === 'true-false') && (
                        <div className="mt-2 pl-4 space-y-1">
                          {question.options.map(opt => (
                            <div key={opt.letter} className="flex items-center">
                              <input
                                type="radio"
                                checked={question.correctAnswer === opt.letter}
                                readOnly
                                className="form-radio h-4 w-4 mr-2"
                              />
                              <span className={question.correctAnswer === opt.letter ? 'font-semibold text-success' : ''}>
                                {opt.letter}. {opt.text}
                                {question.correctAnswer === opt.letter && ' âœ“'}
                              </span>
                            </div>
                          ))}
                        </div>
                      )}

                      {question.type === 'short-answer' && (
                        <div className="mt-2 pl-4">
                          <p className="text-sm">
                            <span className="font-semibold">Correct Answer:</span> {question.correctAnswer}
                          </p>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </Modal>
      );
    };

    // From components/ReadingAssessment.tsx
    const PassageManagementModal = ({ isOpen, onClose, passages, setPassages }) => {
      const [editingPassage, setEditingPassage] = useState(null);

      const handleEdit = (passageId) => {
        const passage = passages[parseInt(passageId, 10)];
        setEditingPassage({ id: passageId, title: passage.title, content: passage.content });
      };

      const handleAddNew = () => {
        setEditingPassage({ id: null, title: '', content: '' });
      };

      const handleFormChange = (e) => {
        if (!editingPassage) return;
        const { name, value } = e.target;
        setEditingPassage(prev => prev ? { ...prev, [name]: value } : null);
      };

      const handleDelete = (passageId) => {
        if (Object.keys(passages).length <= 1) {
          alert('You cannot delete the last remaining passage.');
          return;
        }
        if (window.confirm('Are you sure you want to delete this passage?')) {
          setPassages(prev => {
            const newPassages = { ...prev };
            delete newPassages[parseInt(passageId, 10)];
            return newPassages;
          });
        }
      };

      const handleSave = () => {
        if (!editingPassage || !editingPassage.title || !editingPassage.content) {
          alert('Title and Content cannot be empty.');
          return;
        }
        const wordCount = editingPassage.content.split(/\s+/).filter(Boolean).length;

        if (editingPassage.id) {
          const passageId = parseInt(editingPassage.id, 10);
          setPassages(prev => ({
            ...prev,
            [passageId]: {
              ...prev[passageId],
              title: editingPassage.title,
              content: editingPassage.content,
              wordCount: wordCount,
            }
          }));
        } else {
          const newId = Date.now();
          setPassages(prev => ({
            ...prev,
            [newId]: {
              title: editingPassage.title,
              content: editingPassage.content,
              wordCount: wordCount,
              quiz: []
            }
          }));
        }
        setEditingPassage(null);
      };

      useEffect(() => {
        if (!isOpen) {
          setEditingPassage(null);
        }
      }, [isOpen]);

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Manage Reading Passages">
          {editingPassage ? (
            <div>
              <h4 className="text-lg font-semibold mb-2">{editingPassage.id ? 'Edit Passage' : 'Add New Passage'}</h4>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700">Title</label>
                  <input type="text" name="title" value={editingPassage.title} onChange={handleFormChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">Content</label>
                  <textarea name="content" value={editingPassage.content} onChange={handleFormChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm" rows={8}></textarea>
                </div>
              </div>
              <div className="flex justify-end gap-2 mt-6">
                <button onClick={() => setEditingPassage(null)} className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Back to List</button>
                <button onClick={handleSave} className="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-blue-600">Save Passage</button>
              </div>
            </div>
          ) : (
            <div>
              <div className="flex justify-end mb-4">
                <button onClick={handleAddNew} className="flex items-center gap-2 px-4 py-2 text-white bg-success rounded-md shadow-sm hover:bg-green-600">
                  <PlusIcon className="w-5 h-5" /> Add New Passage
                </button>
              </div>
              <ul className="space-y-2 max-h-96 overflow-y-auto">
                {Object.keys(passages).map(id => (
                  <li key={id} className="flex justify-between items-center p-3 bg-gray-50 rounded-md border">
                    <span className="font-medium">{passages[parseInt(id, 10)].title}</span>
                    <div className="flex gap-2">
                      <button onClick={() => handleEdit(id)} className="text-warning hover:text-yellow-600"><EditIcon className="w-5 h-5" /></button>
                      <button onClick={() => handleDelete(id)} className="text-danger hover:text-red-600"><TrashIcon className="w-5 h-5" /></button>
                    </div>
                  </li>
                ))}
              </ul>
            </div>
          )}
        </Modal>
      );
    };

    const LoadingSpinner = () => (
      <div className="flex flex-col items-center justify-center space-y-4 py-8">
        <svg className="animate-spin h-10 w-10 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p className="text-gray-500 text-lg">Analyzing reading with AI... this may take a moment.</p>
      </div>
    );

    // Editable Miscue Card Component
    const EditableMiscueCard = ({ miscue, index, onUpdate, onDelete }) => {
      const [isEditing, setIsEditing] = useState(false);
      const [editedMiscue, setEditedMiscue] = useState(miscue);

      const miscueTypeColors = {
        Substitution: { border: 'border-yellow-500', bg: 'bg-yellow-100', text: 'text-yellow-700' },
        Omission: { border: 'border-red-500', bg: 'bg-red-100', text: 'text-red-700' },
        Insertion: { border: 'border-blue-500', bg: 'bg-blue-100', text: 'text-blue-700' },
        Repetition: { border: 'border-green-500', bg: 'bg-green-100', text: 'text-green-700' },
        Reversal: { border: 'border-indigo-500', bg: 'bg-indigo-100', text: 'text-indigo-700' },
      };

      const colors = miscueTypeColors[miscue.type] || { border: 'border-gray-500', bg: 'bg-gray-100', text: 'text-gray-700' };

      const handleSave = () => {
        onUpdate(index, editedMiscue);
        setIsEditing(false);
      };

      const handleCancel = () => {
        setEditedMiscue(miscue);
        setIsEditing(false);
      };

      const handleChange = (field, value) => {
        setEditedMiscue(prev => ({ ...prev, [field]: value }));
      };

      return (
        <div className={`editable-miscue ${isEditing ? 'editing' : ''}`}>
          <div className={`border-l-4 ${colors.border} ${colors.bg} p-4 rounded-r-lg shadow-sm`}>
            <div className="flex justify-between items-center mb-2">
              <h3 className={`text-lg font-bold ${colors.text}`}>
                {isEditing ? (
                  <select
                    value={editedMiscue.type}
                    onChange={(e) => handleChange('type', e.target.value)}
                    className="rounded border px-2 py-1"
                  >
                    <option value="Substitution">Substitution</option>
                    <option value="Omission">Omission</option>
                    <option value="Insertion">Insertion</option>
                    <option value="Repetition">Repetition</option>
                    <option value="Reversal">Reversal</option>
                  </select>
                ) : (
                  miscue.type
                )}
              </h3>
              <div className="flex gap-2">
                {isEditing ? (
                  <>
                    <button onClick={handleSave} className="text-success hover:text-green-700">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path></svg>
                    </button>
                    <button onClick={handleCancel} className="text-danger hover:text-red-700">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                  </>
                ) : (
                  <>
                    <button onClick={() => setIsEditing(true)} className="text-warning hover:text-yellow-700">
                      <EditIcon className="w-5 h-5" />
                    </button>
                    <button onClick={() => onDelete(index)} className="text-danger hover:text-red-700">
                      <TrashIcon className="w-5 h-5" />
                    </button>
                  </>
                )}
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-3">
              <div className="bg-white p-3 rounded border">
                <p className="font-semibold text-gray-600 mb-1">Original Text:</p>
                {isEditing ? (
                  <input
                    type="text"
                    value={editedMiscue.originalWord}
                    onChange={(e) => handleChange('originalWord', e.target.value)}
                    className="w-full p-1 border rounded"
                  />
                ) : (
                  <p className="text-red-600 line-through font-mono text-base">{miscue.originalWord || '---'}</p>
                )}
              </div>
              <div className="bg-white p-3 rounded border">
                <p className="font-semibold text-gray-600 mb-1">Student Read:</p>
                {isEditing ? (
                  <input
                    type="text"
                    value={editedMiscue.studentWord}
                    onChange={(e) => handleChange('studentWord', e.target.value)}
                    className="w-full p-1 border rounded"
                  />
                ) : (
                  <p className="text-green-600 font-mono text-base">{miscue.studentWord || '---'}</p>
                )}
              </div>
            </div>

            <div className="bg-gray-50 p-3 rounded border mb-3">
              <p className="font-semibold text-gray-600 mb-1">Context:</p>
              {isEditing ? (
                <textarea
                  value={editedMiscue.context}
                  onChange={(e) => handleChange('context', e.target.value)}
                  className="w-full p-1 border rounded"
                  rows="2"
                />
              ) : (
                <p className="text-gray-800 italic">{`..."${miscue.context}..."`}</p>
              )}
            </div>

            <div>
              <p className="font-semibold text-gray-600 mb-1">Explanation:</p>
              {isEditing ? (
                <textarea
                  value={editedMiscue.explanation}
                  onChange={(e) => handleChange('explanation', e.target.value)}
                  className="w-full p-1 border rounded"
                  rows="2"
                />
              ) : (
                <p className="text-gray-800 text-sm">{miscue.explanation}</p>
              )}
            </div>
          </div>
        </div>
      );
    };

    const SummaryCard = ({ summary }) => {
      const miscueTypeColors = {
        Substitution: { border: 'border-yellow-500', bg: 'bg-yellow-100', text: 'text-yellow-700' },
        Omission: { border: 'border-red-500', bg: 'bg-red-100', text: 'text-red-700' },
        Insertion: { border: 'border-blue-500', bg: 'bg-blue-100', text: 'text-blue-700' },
        Repetition: { border: 'border-green-500', bg: 'bg-green-100', text: 'text-green-700' },
        Reversal: { border: 'border-indigo-500', bg: 'bg-indigo-100', text: 'text-indigo-700' },
      };
      return (
        <div className="bg-gray-50 p-6 rounded-lg shadow-sm border">
          <h2 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Analysis Summary</h2>
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center">
            <div className="bg-white p-3 rounded-md border shadow-sm">
              <p className="text-3xl font-bold text-gray-800">{summary.totalMiscues}</p>
              <p className="text-sm text-gray-500">Total Miscues</p>
            </div>
            <div className={`p-3 rounded-md ${miscueTypeColors.Substitution.bg} border ${miscueTypeColors.Substitution.border}`}>
              <p className={`text-3xl font-bold ${miscueTypeColors.Substitution.text}`}>{summary.substitutions}</p>
              <p className="text-sm text-gray-500">Substitutions</p>
            </div>
            <div className={`p-3 rounded-md ${miscueTypeColors.Omission.bg} border ${miscueTypeColors.Omission.border}`}>
              <p className={`text-3xl font-bold ${miscueTypeColors.Omission.text}`}>{summary.omissions}</p>
              <p className="text-sm text-gray-500">Omissions</p>
            </div>
            <div className={`p-3 rounded-md ${miscueTypeColors.Insertion.bg} border ${miscueTypeColors.Insertion.border}`}>
              <p className={`text-3xl font-bold ${miscueTypeColors.Insertion.text}`}>{summary.insertions}</p>
              <p className="text-sm text-gray-500">Insertions</p>
            </div>
            <div className={`p-3 rounded-md ${miscueTypeColors.Repetition.bg} border ${miscueTypeColors.Repetition.border}`}>
              <p className={`text-3xl font-bold ${miscueTypeColors.Repetition.text}`}>{summary.repetitions}</p>
              <p className="text-sm text-gray-500">Repetitions</p>
            </div>
            <div className={`p-3 rounded-md ${miscueTypeColors.Reversal.bg} border ${miscueTypeColors.Reversal.border}`}>
              <p className={`text-3xl font-bold ${miscueTypeColors.Reversal.text}`}>{summary.reversals}</p>
              <p className="text-sm text-gray-500">Reversals</p>
            </div>
          </div>
        </div>
      );
    };

    // FIXED: ReadingAssessment component with proper miscue updates in localStorage
    const ReadingAssessment = ({ students, passages, setPassages, onSaveAssessment, teacherName }) => {
      const [selectedStudent, setSelectedStudent] = useState('');
      const [selectedPassageId, setSelectedPassageId] = useState(Object.keys(passages).length > 0 ? Object.keys(passages)[0] : '');
      const [selectedWeek, setSelectedWeek] = useState('1');
      const [timer, setTimer] = useState(0);
      const [isTiming, setIsTiming] = useState(false);
      const [comprehensionScore, setComprehensionScore] = useState('');
      const [studentReading, setStudentReading] = useState('');
      const [isRecording, setIsRecording] = useState(false);
      const [analysisResult, setAnalysisResult] = useState(null);
      const [isLoading, setIsLoading] = useState(false);
      const [analysisError, setAnalysisError] = useState(null);
      const [isPassageModalOpen, setIsPassageModalOpen] = useState(false);
      const [isQuestionModalOpen, setIsQuestionModalOpen] = useState(false);
      const [isUnlockingDifficultiesOpen, setIsUnlockingDifficultiesOpen] = useState(false);
      const [isAssessmentSettingsOpen, setIsAssessmentSettingsOpen] = useState(false);
      const [studentAnswers, setStudentAnswers] = useState({});
      const [hoveredWord, setHoveredWord] = useState(null);
      const [settings, updateSettings] = useAssessmentSettings();

      const [currentAnalysisId, setCurrentAnalysisId] = useState(null); // FIXED: Track current analysis ID
      const [fontSize, setFontSize] = useState(18); // NEW: Font size state

      const {
        voices,
        selectedVoice,
        setSelectedVoice,
        speak,
        cancel,
        isSpeaking,
        isSupported: isTtsSupported,
        currentWordIndex,
        rate,
        setRate,
        pitch,
        setPitch,
        volume,
        setVolume,
        previewVoice
      } = useSpeechSynthesis();

      // NEW: Use difficult words hook
      const {
        difficultWords,
        addDifficultWord,
        removeDifficultWord,
        getDifficultWordsForPassage,
        updateDifficultWord
      } = useDifficultWords();

      // FIXED: Use miscue storage hook with update functionality
      const { saveMiscueAnalysis, updateMiscueAnalysis } = useMiscueStorage();

      const mediaRecorderRef = useRef(null);
      const audioChunksRef = useRef([]);
      const timerIntervalRef = useRef(null);
      const recognitionRef = useRef(null);

      const currentPassage = useMemo(() => passages[parseInt(selectedPassageId, 10)], [passages, selectedPassageId]);
      const passageText = useMemo(() => currentPassage?.content.replace(/<[^>]*>?/gm, '') || '', [currentPassage]);
      const passageWords = useMemo(() => passageText.split(/\s+/).filter(Boolean), [passageText]);

      // NEW: Get difficult words for current passage
      const currentDifficultWords = useMemo(() =>
        getDifficultWordsForPassage(parseInt(selectedPassageId, 10)),
        [getDifficultWordsForPassage, selectedPassageId]
      );

      useEffect(() => {
        setStudentAnswers({});
        setComprehensionScore('');
        setAnalysisResult(null);
        setAnalysisError(null);
        setStudentReading('');
        setCurrentAnalysisId(null); // FIXED: Reset current analysis ID
      }, [selectedPassageId, selectedStudent]);

      useEffect(() => {
        if (isTiming) {
          timerIntervalRef.current = window.setInterval(() => {
            setTimer(prev => prev + 1);
          }, 1000);
        } else if (timerIntervalRef.current) {
          clearInterval(timerIntervalRef.current);
          timerIntervalRef.current = null;
        }
        return () => {
          if (timerIntervalRef.current) clearInterval(timerIntervalRef.current);
        };
      }, [isTiming]);

      const stopRecording = useCallback(() => {
        if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
          mediaRecorderRef.current.stop();
        }
        if (recognitionRef.current) {
          recognitionRef.current.stop();
        }
        setIsRecording(false);
        setIsTiming(false); // Stop timer when recording stops
      }, []);

      useEffect(() => {
        return () => {
          stopRecording();
        };
      }, [stopRecording]);

      const startRecording = async () => {
        setStudentReading('');
        setAnalysisError(null);
        setAnalysisResult(null);

        // Start the timer when recording starts
        setTimer(0);
        setIsTiming(true);

        // Check if browser supports Web Speech API
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognitionRef.current = new SpeechRecognition();

          recognitionRef.current.continuous = true;
          recognitionRef.current.interimResults = true;
          recognitionRef.current.lang = 'en-US';

          recognitionRef.current.onstart = () => {
            setIsRecording(true);
          };

          recognitionRef.current.onresult = (event) => {
            let interimTranscript = '';
            let finalTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; i++) {
              const transcript = event.results[i][0].transcript;
              if (event.results[i].isFinal) {
                finalTranscript += transcript;
              } else {
                interimTranscript += transcript;
              }
            }

            setStudentReading(prev => {
              // Only add final results to avoid duplication
              if (finalTranscript) {
                const newText = prev + finalTranscript;
                // Add a space after a period if it's followed by a letter.
                return newText.replace(/\.(?=[a-zA-Z])/g, '. ');
              }
              return prev;
            });
          };

          recognitionRef.current.onerror = (event) => {
            console.error('Speech recognition error', event.error);
            if (event.error === 'not-allowed') {
              setAnalysisError('Microphone access was denied. Please allow microphone access and try again.');
            } else {
              setAnalysisError(`Speech recognition error: ${event.error}`);
            }
            setIsRecording(false);
            setIsTiming(false); // Stop timer on error
          };

          recognitionRef.current.onend = () => {
            // If we're still supposed to be recording, restart
            if (isRecording) {
              recognitionRef.current.start();
            }
          };

          try {
            recognitionRef.current.start();
          } catch (error) {
            console.error('Error starting speech recognition:', error);
            setAnalysisError('Could not start speech recognition. Please check your microphone settings.');
            setIsRecording(false);
            setIsTiming(false); // Stop timer on error
          }
        } else {
          setAnalysisError('Your browser does not support speech recognition. Please try Chrome or Edge.');
        }
      };

      const handleToggleRecording = () => {
        if (!selectedStudent) { alert("Please select a student first."); return; }
        if (isRecording) {
          stopRecording();
        } else {
          startRecording();
        }
      };

      const handleStartTimer = () => {
        if (!selectedStudent) { alert("Please select a student first."); return; }
        setTimer(0);
        setIsTiming(true);
      }

      const handleAnalyze = useCallback(async () => {
        if (!passageText || !studentReading) {
          setAnalysisError("Both passage and student reading are required for analysis.");
          return;
        }
        setIsLoading(true);
        setAnalysisError(null);
        setAnalysisResult(null);

        try {
          const result = await analyzeMiscuesWithGemini(passageText, studentReading);
          setAnalysisResult(result);

          // FIXED: Save miscue analysis to storage and track the ID
          if (selectedStudent && selectedPassageId) {
            const analysisId = saveMiscueAnalysis(
              parseInt(selectedStudent, 10),
              parseInt(selectedPassageId, 10),
              result,
              studentReading,
              passageText
            );
            setCurrentAnalysisId(analysisId); // FIXED: Store the current analysis ID
          }
        } catch (err) {
          setAnalysisError(err.message);
        } finally {
          setIsLoading(false);
        }
      }, [passageText, studentReading, selectedStudent, selectedPassageId, saveMiscueAnalysis]);

      // CORRECTED WPM CALCULATION - based on transcribed words
      const calculateWPM = useCallback(() => {
        if (timer === 0 || !studentReading.trim()) return 0;
        const minutes = timer / 60;
        // Count words in student's transcribed reading
        const wordCount = studentReading.trim().split(/\s+/).filter(word => word.length > 0).length;
        return Math.round(wordCount / minutes);
      }, [timer, studentReading]);

      const handleSave = () => {
        if (!selectedStudent || comprehensionScore === '') {
          alert("Please select a student and ensure a comprehension score is calculated or entered.");
          return;
        }
        const wordCount = currentPassage.wordCount;
        const miscueCount = analysisResult ? analysisResult.summary.totalMiscues : 0;
        const wordRecognition = Math.max(0, Math.round(((wordCount - miscueCount) / wordCount) * 100));
        const newAssessment = {
          week: parseInt(selectedWeek, 10),
          wordRecognition,
          readingSpeed: calculateWPM(),
          comprehension: parseInt(comprehensionScore, 10),
          miscues: miscueCount,
        };
        onSaveAssessment(parseInt(selectedStudent, 10), newAssessment);
        alert('Assessment saved successfully!');
      };

      const handleExportToPDF = () => {
        if (!selectedStudent || !currentPassage) { alert("Please select a student and a passage first."); return; }
        const student = students.find(s => s.id === parseInt(selectedStudent, 10));
        if (!student) { alert("Selected student not found."); return; }

        // FIXED: Use the global jsPDF instance
        const { jsPDF } = window.jspdf;

        const doc = new jsPDF();
        // Compute PHIL-IRI level for this assessment
        doc.setFontSize(20).setFont("helvetica", "bold").text("EchoText Assessment Report", 105, 22, { align: 'center' });
        doc.setFontSize(12).setFont("helvetica", "normal");
        doc.text(`Student:`, 14, 40).setFont("helvetica", "bold").text(`${student.firstName} ${student.lastName}`, 34, 40);
        doc.setFont("helvetica", "normal").text(`Grade:`, 14, 47).setFont("helvetica", "bold").text(`${student.gradeLevel === 'Kinder' ? 'Kindergarten' : `Grade ${student.gradeLevel}`}`, 30, 47);
        doc.setFont("helvetica", "normal").text(`Date:`, 150, 40).setFont("helvetica", "bold").text(new Date().toLocaleDateString(), 162, 40);
        doc.setFont("helvetica", "normal").text(`Evaluated by:`, 14, 54).setFont("helvetica", "bold").text(`${teacherName || 'Teacher'}`, 42, 54);
        doc.setLineWidth(0.5).line(14, 60, 196, 60);
        doc.setFontSize(11).text(`Passage Title: ${currentPassage.title}`, 14, 68).line(14, 80, 196, 80);

        const miscueCount = analysisResult ? analysisResult.summary.totalMiscues : 0;
        const wordRecognition = Math.max(0, Math.round(((currentPassage.wordCount - miscueCount) / currentPassage.wordCount) * 100));
        const comprehensionVal = comprehensionScore !== '' ? parseInt(comprehensionScore, 10) : undefined;

        // local PHIL-IRI calculator (matches the app logic)
        const computePhilIri = (wr, comp) => {
          if (wr === undefined || comp === undefined) return { level: 'Not Assessed', badge: 'N/A' };
          if (wr >= 97 && comp >= 80) return { level: 'Independent', badge: 'Independent' };
          if (wr >= 90 && comp >= 59) return { level: 'Instructional', badge: 'Instructional' };
          if (wr < 1 || comp < 1) return { level: 'Non-Reader', badge: 'Non-Reader' };
          if (wr < 90 || comp < 59) return { level: 'Frustration', badge: 'Frustration' };
          return { level: 'Not Assessed', badge: 'N/A' };
        };

        const phil = computePhilIri(wordRecognition, comprehensionVal);

        doc.autoTable({
          startY: 90,
          head: [['Metric', 'Score']],
          body: [
            ['Words Per Minute (WPM)', calculateWPM().toString()],
            ['Word Recognition', `${wordRecognition}%`],
            ['Comprehension Score', `${comprehensionVal !== undefined ? comprehensionVal + '%' : 'N/A'}`],
            ['Total Miscues', miscueCount.toString()],
            ['PHIL-IRI Level', phil.level]
          ],
          theme: 'striped', headStyles: { fillColor: [44, 62, 80] }
        });

        // Add miscue details if available
        if (analysisResult && analysisResult.miscues.length > 0) {
          doc.setFontSize(14).setFont("helvetica", "bold").text("Miscue Analysis Details", 14, doc.lastAutoTable.finalY + 15);

          const miscueTableData = analysisResult.miscues.map((miscue, index) => [
            index + 1,
            miscue.type,
            miscue.originalWord,
            miscue.studentWord,
            miscue.explanation
          ]);

          doc.autoTable({
            startY: doc.lastAutoTable.finalY + 20,
            head: [['#', 'Type', 'Original Word', 'Student Read', 'Explanation']],
            body: miscueTableData,
            theme: 'grid',
            headStyles: { fillColor: [44, 62, 80] },
            styles: { fontSize: 8 },
            columnStyles: {
              0: { cellWidth: 10 },
              1: { cellWidth: 25 },
              2: { cellWidth: 30 },
              3: { cellWidth: 30 },
              4: { cellWidth: 95 }
            }
          });
        }

        doc.save(`Assessment_Report_${student.firstName}_${student.lastName}.pdf`);
      };

      const handleCheckAnswers = () => {
        const quiz = currentPassage.quiz || [];
        if (quiz.length === 0) { alert("No quiz available for this passage."); return; }
        let correctPoints = 0;
        let totalPoints = quiz.reduce((sum, q) => sum + q.points, 0);
        quiz.forEach(q => {
          const studentAnswer = studentAnswers[q.id];
          if (studentAnswer && q.correctAnswer.toLowerCase() === studentAnswer.toLowerCase()) {
            correctPoints += q.points;
          }
        });
        const score = totalPoints > 0 ? Math.round((correctPoints / totalPoints) * 100) : 100;
        setComprehensionScore(score.toString());
        alert(`Quiz graded! Comprehension Score: ${score}%`);
      };

      const formatTime = (seconds) => `${Math.floor(seconds / 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`;

      // FIXED: Handle miscue updates with localStorage persistence
      const handleUpdateMiscue = (index, updatedMiscue) => {
        setAnalysisResult(prev => {
          const newMiscues = [...prev.miscues];
          newMiscues[index] = updatedMiscue;

          // Recalculate summary
          const miscueCounts = {
            Substitution: 0,
            Omission: 0,
            Insertion: 0,
            Repetition: 0,
            Reversal: 0
          };

          newMiscues.forEach(miscue => {
            if (miscueCounts.hasOwnProperty(miscue.type)) {
              miscueCounts[miscue.type]++;
            }
          });

          const updatedAnalysis = {
            ...prev,
            miscues: newMiscues,
            summary: {
              totalMiscues: newMiscues.length,
              substitutions: miscueCounts.Substitution,
              omissions: miscueCounts.Omission,
              insertions: miscueCounts.Insertion,
              repetitions: miscueCounts.Repetition,
              reversals: miscueCounts.Reversal,
            }
          };

          // FIXED: Update the analysis in localStorage
          if (selectedStudent && currentAnalysisId) {
            updateMiscueAnalysis(
              parseInt(selectedStudent, 10),
              currentAnalysisId,
              updatedAnalysis
            );
          }

          return updatedAnalysis;
        });
      };

      // FIXED: Handle miscue deletion with localStorage persistence
      const handleDeleteMiscue = (index) => {
        setAnalysisResult(prev => {
          const newMiscues = [...prev.miscues];
          newMiscues.splice(index, 1);

          // Recalculate summary
          const miscueCounts = {
            Substitution: 0,
            Omission: 0,
            Insertion: 0,
            Repetition: 0,
            Reversal: 0
          };

          newMiscues.forEach(miscue => {
            if (miscueCounts.hasOwnProperty(miscue.type)) {
              miscueCounts[miscue.type]++;
            }
          });

          const updatedAnalysis = {
            ...prev,
            miscues: newMiscues,
            summary: {
              totalMiscues: newMiscues.length,
              substitutions: miscueCounts.Substitution,
              omissions: miscueCounts.Omission,
              insertions: miscueCounts.Insertion,
              repetitions: miscueCounts.Repetition,
              reversals: miscueCounts.Reversal,
            }
          };

          // FIXED: Update the analysis in localStorage
          if (selectedStudent && currentAnalysisId) {
            updateMiscueAnalysis(
              parseInt(selectedStudent, 10),
              currentAnalysisId,
              updatedAnalysis
            );
          }

          return updatedAnalysis;
        });
      };

      // NEW: Check if a word is difficult
      const isDifficultWord = (word) => {
        return currentDifficultWords.some(dw =>
          dw.word.toLowerCase() === word.toLowerCase().replace(/[.,!?"]/g, '')
        );
      };

      // NEW: Get definition for a word
      const getWordDefinition = (word) => {
        const difficultWord = currentDifficultWords.find(dw =>
          dw.word.toLowerCase() === word.toLowerCase().replace(/[.,!?"]/g, '')
        );
        return difficultWord ? difficultWord.definition : null;
      };

      if (!currentPassage) return <div className="p-6 bg-white rounded-lg shadow-md">No passages available. Please add a passage using the "Manage Passages" button.</div>;

      return (
        <div>
          <h2 className="text-2xl font-bold text-gray-800 mb-4">Reading Assessment</h2>
          <div className="bg-white rounded-lg shadow-md p-6 space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <select value={selectedStudent} onChange={e => setSelectedStudent(e.target.value)} className="block w-full rounded-md border-gray-300">
                <option value="">Select a student</option>
                {students.map(s => <option key={s.id} value={s.id.toString()}>{s.firstName} {s.lastName}</option>)}
              </select>
              <select value={selectedPassageId} onChange={e => setSelectedPassageId(e.target.value)} className="block w-full rounded-md border-gray-300">
                {Object.keys(passages).map(id => <option key={id} value={id}>{passages[parseInt(id, 10)].title}</option>)}
              </select>
              <select value={selectedWeek} onChange={e => setSelectedWeek(e.target.value)} className="block w-full rounded-md border-gray-300">
                {Array.from({ length: settings.totalWeeks }, (_, i) => i + 1).map(week => <option key={week} value={week}>{settings.reportPeriod === 'weeks' ? 'Week ' : 'Day '}{week}</option>)}
              </select>
            </div>

            <div className="flex gap-2">
              <button onClick={() => setIsPassageModalOpen(true)} className="px-3 py-2 text-sm text-white bg-gray-600 rounded-md hover:bg-gray-700 whitespace-nowrap">Manage Passages</button>
              <button onClick={() => setIsQuestionModalOpen(true)} className="px-3 py-2 text-sm text-white bg-primary rounded-md hover:bg-blue-700 whitespace-nowrap">Manage Questions</button>
              {/* NEW: Unlocking Difficulties Button */}
              <button onClick={() => setIsUnlockingDifficultiesOpen(true)} className="px-3 py-2 text-sm text-white bg-warning rounded-md hover:bg-yellow-700 whitespace-nowrap">Unlocking Difficulties</button>
              {/* NEW: Assessment Settings Button */}
              <button onClick={() => setIsAssessmentSettingsOpen(true)} className="px-3 py-2 text-sm text-white bg-secondary rounded-md hover:bg-gray-700 whitespace-nowrap">Assessment Settings</button>
            </div>

            <div className="bg-gray-50 border-l-4 border-primary p-4 rounded-r-md">
              <h4 className="text-xl font-bold text-gray-800 mb-2">{currentPassage.title}</h4>
              <p className="text-gray-700 leading-relaxed" style={{ fontSize: `${fontSize}px`, lineHeight: '1.6' }}>
                {passageWords.map((word, index) => {
                  const cleanWord = word.replace(/[.,!?"]/g, '');
                  const isDifficult = isDifficultWord(cleanWord);
                  const definition = isDifficult ? getWordDefinition(cleanWord) : null;

                  return (
                    <span
                      key={index}
                      onClick={() => speak(word)}
                      onMouseEnter={() => isDifficult && setHoveredWord({ word: cleanWord, definition, index })}
                      onMouseLeave={() => setHoveredWord(null)}
                      className={`passage-word transition-colors duration-200 ${index === currentWordIndex ? 'current-word' : ''} ${isDifficult ? 'difficult-word' : ''}`}
                      title={isDifficult ? `Definition: ${definition}` : "Click to hear pronunciation"}
                    >
                      {word}{' '}
                      {hoveredWord && hoveredWord.index === index && (
                        <div className="word-definition">
                          {hoveredWord.definition}
                        </div>
                      )}
                    </span>
                  );
                })}
              </p>
            </div>

            <div className="flex flex-wrap items-start justify-between gap-4 p-4 border rounded-lg">
              <div className="flex-1 min-w-[300px] flex flex-col gap-4">
                {isTtsSupported ? (
                  <div className="space-y-3">
                    {/* Voice Selection Row */}
                    <div className="flex items-center gap-2">
                      <button onClick={() => isSpeaking ? cancel() : speak(passageText)} className={`px-3 py-2 text-sm text-white rounded-md ${isSpeaking ? 'bg-red-500' : 'bg-blue-500'}`}>
                        {isSpeaking ? 'Stop Speaking' : 'Listen to Passage'}
                      </button>
                      <select value={selectedVoice?.name || ''} onChange={(e) => setSelectedVoice(voices.find(v => v.name === e.target.value) || null)} className="block w-64 rounded-md border-gray-300 text-sm" disabled={isSpeaking}>
                        {voices.map(voice => <option key={voice.name} value={voice.name}>{voice.name} ({voice.lang})</option>)}
                      </select>
                    </div>

                    {/* Speed Control Row */}
                    <div className="flex items-center gap-2">
                      <label htmlFor="tts-speed" className="text-sm font-medium text-gray-700 w-20">Speed:</label>
                      <input
                        id="tts-speed"
                        type="range"
                        min="0.5"
                        max="2"
                        step="0.1"
                        value={rate}
                        onChange={(e) => setRate(parseFloat(e.target.value))}
                        className="w-48 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                        disabled={isSpeaking}
                      />
                      <span className="text-sm text-gray-600 min-w-[3rem]">{rate.toFixed(1)}x</span>
                    </div>

                    {/* Font Size Control Row */}
                    <div className="flex items-center gap-2">
                      <label htmlFor="font-size" className="text-sm font-medium text-gray-700 w-20">Font Size:</label>
                      <input
                        id="font-size"
                        type="range"
                        min="12"
                        max="32"
                        step="1"
                        value={fontSize}
                        onChange={(e) => setFontSize(parseInt(e.target.value))}
                        className="w-48 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                      />
                      <span className="text-sm text-gray-600 min-w-[3rem]">{fontSize}px</span>
                    </div>
                  </div>
                ) : <p className="text-xs text-red-500">TTS not supported.</p>}
              </div>
              <div className="flex-1 min-w-[250px] text-sm flex items-center gap-2 justify-end">
                <button onClick={handleToggleRecording} className={`flex items-center gap-2 px-3 py-2 text-sm text-white rounded-md ${isRecording ? 'bg-danger recording-pulse' : 'bg-success'}`}>
                  <MicrophoneIcon className="w-4 h-4" />
                  {isRecording ? 'Stop Recording' : 'Start Recording'}
                </button>
                <span className="px-3 py-1 bg-blue-100 text-primary rounded-full">Words: {currentPassage.wordCount}</span>
                <span className="px-3 py-1 bg-green-100 text-success rounded-full">Time: {formatTime(timer)}</span>
                <span className="px-3 py-1 bg-yellow-100 text-warning rounded-full">WPM: {calculateWPM()}</span>
              </div>
            </div>

            {/* UPDATED: Using CollapsibleTTSControls instead of TTSControls */}
            <CollapsibleTTSControls
              voices={voices}
              selectedVoice={selectedVoice}
              setSelectedVoice={setSelectedVoice}
              rate={rate}
              setRate={setRate}
              pitch={pitch}
              setPitch={setPitch}
              volume={volume}
              setVolume={setVolume}
              previewVoice={previewVoice}
              isSpeaking={isSpeaking}
            />

            <div className="p-4 border rounded-lg">
              <div className="flex flex-wrap items-center justify-between gap-4 mb-4">
                <button onClick={() => isTiming ? setIsTiming(false) : handleStartTimer()} className={`flex items-center gap-2 px-3 py-2 text-sm text-white rounded-md ${isTiming ? 'bg-gray-500' : 'bg-primary'}`}>
                  {isTiming ? <StopIcon className="w-4 h-4" /> : <PlayIcon className="w-4 h-4" />}
                  {isTiming ? 'Stop Timer' : 'Start Timer'}
                </button>

                <button
                  onClick={handleAnalyze}
                  disabled={isLoading || isRecording || !studentReading.trim()}
                  className="px-4 py-2 bg-secondary text-white font-bold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {isLoading ? 'Analyzing...' : 'Analyze with AI'}
                </button>
              </div>
              <div>
                <label htmlFor="studentReading" className="block text-sm font-medium text-gray-700 mb-1">Student's Transcribed Reading</label>
                <textarea
                  id="studentReading"
                  value={studentReading}
                  onChange={(e) => setStudentReading(e.target.value)}
                  rows={6}
                  className={`w-full p-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:outline-none transition-all duration-300 ${isRecording ? 'ring-2 ring-red-500/70' : ''}`}
                  placeholder={isRecording ? "Listening... transcribed text will appear here in real-time." : "Transcribed reading appears here..."}
                  disabled={isRecording}
                />
              </div>
            </div>

            <div className="mt-6 border-t pt-4">
              <h3 className="text-lg font-semibold text-gray-800 mb-2">AI-Powered Miscue Analysis</h3>
              {isLoading && <LoadingSpinner />}
              {analysisError && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert"><strong className="font-bold">Analysis Error: </strong><span className="block sm:inline">{analysisError}</span></div>}
              {analysisResult && (
                <div className="space-y-6 mt-4">
                  <SummaryCard summary={analysisResult.summary} />
                  <div>
                    <h4 className="text-xl font-bold text-gray-800 mb-4">Detailed Miscues</h4>
                    {analysisResult.miscues.length > 0 ? (
                      <div className="space-y-4">
                        {analysisResult.miscues.map((miscue, index) => (
                          <EditableMiscueCard
                            key={index}
                            miscue={miscue}
                            index={index}
                            onUpdate={handleUpdateMiscue}
                            onDelete={handleDeleteMiscue}
                          />
                        ))}
                      </div>
                    ) : (
                      <div className="text-center py-8 bg-green-50 border border-green-200 rounded-lg">
                        <p className="text-lg font-semibold text-green-700">Excellent! No miscues were detected.</p>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>

            <div className="space-y-4 mt-6 border-t pt-6">
              <h3 className="text-lg font-semibold text-gray-800">Quiz & Results</h3>
              <div className="space-y-4">
                {(currentPassage.quiz || []).map((q, index) => (
                  <div key={q.id} className="bg-gray-50 p-4 rounded-lg border">
                    <p className="font-semibold">{index + 1}. {q.question}</p>
                    <div className="mt-2 pl-4 space-y-1">
                      {q.type === 'multiple-choice' || q.type === 'true-false' ? (
                        q.options?.map(opt => (
                          <label key={opt.letter} className="flex items-center">
                            <input type="radio" name={`q_${q.id}`} value={opt.letter} onChange={(e) => setStudentAnswers(p => ({ ...p, [q.id]: e.target.value }))} className="form-radio h-4 w-4 mr-2" />
                            <span>{opt.text}</span>
                          </label>
                        ))
                      ) : (
                        <input type="text" name={`q_${q.id}`} onChange={(e) => setStudentAnswers(p => ({ ...p, [q.id]: e.target.value }))} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                      )}
                    </div>
                  </div>
                ))}
              </div>
              <button onClick={handleCheckAnswers} className="px-4 py-2 text-white bg-blue-600 rounded-md shadow-sm">Check Answers</button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-end mt-6 border-t pt-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Comprehension Score (%)</label>
                <input type="number" min="0" max="100" value={comprehensionScore} onChange={e => setComprehensionScore(e.target.value)} className="block w-full rounded-md border-gray-300 bg-gray-100" placeholder="Auto-calculated" />
              </div>
              <div className="flex gap-2">
                <button onClick={handleSave} className="w-full px-4 py-2 text-white bg-success rounded-md shadow-sm hover:bg-green-600">Save Assessment</button>
                <button onClick={handleExportToPDF} disabled={!selectedStudent} className="w-full px-4 py-2 text-white bg-secondary rounded-md shadow-sm hover:bg-gray-600 disabled:bg-gray-400">Export to PDF</button>
              </div>
            </div>
          </div>
          <PassageManagementModal isOpen={isPassageModalOpen} onClose={() => setIsPassageModalOpen(false)} passages={passages} setPassages={setPassages} />
          <QuestionManagementModal
            isOpen={isQuestionModalOpen}
            onClose={() => setIsQuestionModalOpen(false)}
            passages={passages}
            setPassages={setPassages}
            selectedPassageId={selectedPassageId}
          />
          {/* NEW: Unlocking Difficulties Modal */}
          <UnlockingDifficultiesModal
            isOpen={isUnlockingDifficultiesOpen}
            onClose={() => setIsUnlockingDifficultiesOpen(false)}
            passageId={parseInt(selectedPassageId, 10)}
            difficultWords={currentDifficultWords}
            onAddWord={addDifficultWord}
            onRemoveWord={removeDifficultWord}
            onUpdateWord={updateDifficultWord}
          />
          {/* NEW: Assessment Settings Modal */}
          <AssessmentSettingsModal
            isOpen={isAssessmentSettingsOpen}
            onClose={() => setIsAssessmentSettingsOpen(false)}
            settings={settings}
            updateSettings={updateSettings}
          />
        </div>
      );
    };

    // UPDATED: ComprehensionQuiz component with student dropdown and downloadable results
    const ComprehensionQuiz = ({ students, teacherName }) => {
      const [questions, setQuestions] = useState([]);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [selectedStudentId, setSelectedStudentId] = useState('');
      const [studentAnswers, setStudentAnswers] = useState({});
      const [quizResults, setQuizResults] = useState(null);
      const { saveResult, getResultsByStudent } = useComprehensionResults();

      const handleAddQuestion = (questionData) => {
        const newQuestion = { ...questionData, id: Date.now() };
        setQuestions([...questions, newQuestion]);
        setIsModalOpen(false);
      };

      const handleDeleteQuestion = (id) => {
        setQuestions(questions.filter(q => q.id !== id));
      };

      const totalPoints = questions.reduce((sum, q) => sum + q.points, 0);

      const handleSubmitAnswers = () => {
        if (!selectedStudentId) {
          alert("Please select a student first.");
          return;
        }

        let correctPoints = 0;
        let totalPoints = 0;
        const detailedResults = [];

        questions.forEach(q => {
          totalPoints += q.points;
          const studentAnswer = studentAnswers[q.id];
          const isCorrect = studentAnswer && q.correctAnswer.toLowerCase() === studentAnswer.toLowerCase();

          if (isCorrect) {
            correctPoints += q.points;
          }

          detailedResults.push({
            question: q.question,
            studentAnswer: studentAnswer || 'No answer',
            correctAnswer: q.correctAnswer,
            isCorrect: isCorrect,
            points: q.points,
            earnedPoints: isCorrect ? q.points : 0
          });
        });

        const score = totalPoints > 0 ? Math.round((correctPoints / totalPoints) * 100) : 0;

        const result = {
          score,
          totalPoints,
          earnedPoints: correctPoints,
          detailedResults,
          timestamp: new Date().toISOString()
        };

        setQuizResults(result);

        // Save result to localStorage
        saveResult(parseInt(selectedStudentId, 10), questions, score, studentAnswers);

        alert(`Quiz submitted! Score: ${score}% (${correctPoints}/${totalPoints} points)`);
      };

      const handleDownloadResults = () => {
        if (!quizResults || !selectedStudentId) return;

        const student = students.find(s => s.id === parseInt(selectedStudentId, 10));
        if (!student) return;

        // FIXED: Use the global jsPDF instance
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(20).setFont("helvetica", "bold").text("EchoText Comprehension Quiz Report", 105, 22, { align: 'center' });
        doc.setFontSize(12).setFont("helvetica", "normal");
        doc.text(`Student:`, 14, 40).setFont("helvetica", "bold").text(`${student.firstName} ${student.lastName}`, 34, 40);
        doc.setFont("helvetica", "normal").text(`Grade:`, 14, 47).setFont("helvetica", "bold").text(`${student.gradeLevel === 'Kinder' ? 'Kindergarten' : `Grade ${student.gradeLevel}`}`, 30, 47);
        doc.setFont("helvetica", "normal").text(`Date:`, 150, 40).setFont("helvetica", "bold").text(new Date().toLocaleDateString(), 162, 40);
        doc.setFont("helvetica", "normal").text(`Evaluated by:`, 14, 54).setFont("helvetica", "bold").text(`${teacherName || 'Teacher'}`, 42, 54);
        doc.setLineWidth(0.5).line(14, 60, 196, 60);

        // Quiz Summary
        doc.setFontSize(14).setFont("helvetica", "bold").text("Quiz Summary", 14, 75);
        doc.autoTable({
          startY: 80,
          head: [['Metric', 'Value']],
          body: [
            ['Total Score', `${quizResults.score}%`],
            ['Points Earned', `${quizResults.earnedPoints}/${quizResults.totalPoints}`],
            ['Number of Questions', questions.length.toString()],
            ['Date Completed', new Date(quizResults.timestamp).toLocaleDateString()]
          ],
          theme: 'striped',
          headStyles: { fillColor: [44, 62, 80] }
        });

        // Detailed Results
        if (quizResults.detailedResults.length > 0) {
          const detailedStartY = doc.lastAutoTable.finalY + 20;
          doc.setFontSize(14).setFont("helvetica", "bold").text("Detailed Question Results", 14, detailedStartY);

          const tableData = quizResults.detailedResults.map((result, index) => [
            index + 1,
            result.question.length > 50 ? result.question.substring(0, 50) + '...' : result.question,
            result.studentAnswer.length > 20 ? result.studentAnswer.substring(0, 20) + '...' : result.studentAnswer,
            result.correctAnswer.length > 20 ? result.correctAnswer.substring(0, 20) + '...' : result.correctAnswer,
            result.isCorrect ? 'Correct' : 'Incorrect',
            `${result.earnedPoints}/${result.points}`
          ]);

          doc.autoTable({
            startY: detailedStartY + 10,
            head: [['#', 'Question', 'Student Answer', 'Correct Answer', 'Result', 'Points']],
            body: tableData,
            theme: 'grid',
            headStyles: { fillColor: [44, 62, 80] },
            styles: { fontSize: 8 },
            columnStyles: {
              0: { cellWidth: 10 },
              1: { cellWidth: 45 },
              2: { cellWidth: 30 },
              3: { cellWidth: 30 },
              4: { cellWidth: 20 },
              5: { cellWidth: 20 }
            }
          });
        }

        doc.save(`Comprehension_Quiz_${student.firstName}_${student.lastName}.pdf`);
      };

      const QuestionForm = ({ onSave, onClose }) => {
        const [question, setQuestion] = useState('');
        const [type, setType] = useState('multiple-choice');
        const [points, setPoints] = useState(1);
        const [options, setOptions] = useState([
          { letter: 'A', text: '' }, { letter: 'B', text: '' }, { letter: 'C', text: '' }, { letter: 'D', text: '' }
        ]);
        const [correctAnswer, setCorrectAnswer] = useState('A');

        const handleOptionChange = (index, text) => {
          const newOptions = [...options];
          newOptions[index].text = text;
          setOptions(newOptions);
        };

        const handleSubmit = () => {
          if (!question) {
            alert("Please enter the question text.");
            return;
          }
          const newQuestion = { question, type, points, correctAnswer };
          if (type === 'multiple-choice' || type === 'true-false') {
            newQuestion.options = options.filter(opt => opt.text.trim() !== '');
          }
          onSave(newQuestion);
        };

        return (
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700">Question</label>
              <textarea value={question} onChange={e => setQuestion(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm" rows={2}></textarea>
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700">Question Type</label>
                <select value={type} onChange={e => setType(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                  <option value="multiple-choice">Multiple Choice</option>
                  <option value="true-false">True or False</option>
                  <option value="short-answer">Short Answer</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">Points</label>
                <input type="number" value={points} onChange={e => setPoints(parseInt(e.target.value) || 1)} min="1" className="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
              </div>
            </div>

            {(type === 'multiple-choice' || type === 'true-false') && (
              <div>
                <label className="block text-sm font-medium text-gray-700">Options & Correct Answer</label>
                {options.map((opt, index) => (
                  <div key={index} className="flex items-center gap-2 mt-2">
                    <input type="radio" name="correctAnswer" value={opt.letter} checked={correctAnswer === opt.letter} onChange={() => setCorrectAnswer(opt.letter)} className="form-radio h-4 w-4 text-primary" />
                    <span className="font-semibold">{opt.letter}</span>
                    <input type="text" value={opt.text} onChange={e => handleOptionChange(index, e.target.value)} className="block w-full rounded-md border-gray-300 shadow-sm" />
                  </div>
                ))}
              </div>
            )}
            <div className="flex justify-end gap-2 pt-4">
              <button type="button" onClick={onClose} className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
              <button type="button" onClick={handleSubmit} className="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-blue-600">Add Question</button>
            </div>
          </div>
        );
      };

      return (
        <div>
          <h2 className="text-2xl font-bold text-gray-800 mb-4">Comprehension Quiz</h2>

          {/* Student Selection */}
          <div className="bg-white rounded-lg shadow-md p-6 mb-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Select Student</label>
                <select
                  value={selectedStudentId}
                  onChange={e => setSelectedStudentId(e.target.value)}
                  className="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm"
                >
                  <option value="">Select a student</option>
                  {students.map(s => (
                    <option key={s.id} value={s.id}>{s.firstName} {s.lastName}</option>
                  ))}
                </select>
              </div>
              <div className="flex items-end">
                <button
                  onClick={() => {
                    setStudentAnswers({});
                    setQuizResults(null);
                  }}
                  className="w-full px-4 py-2 text-gray-700 bg-gray-200 rounded-md shadow-sm hover:bg-gray-300"
                >
                  Reset Quiz
                </button>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-md">
            <div className="p-6">
              <div className="flex justify-between items-center mb-4">
                <div className="flex gap-2">
                  <button onClick={() => setIsModalOpen(true)} className="flex items-center gap-2 px-4 py-2 text-white bg-primary rounded-md shadow-sm hover:bg-blue-600 text-sm">
                    <PlusIcon className="w-5 h-5" /> Add Question
                  </button>
                  <button onClick={() => setQuestions([])} className="px-4 py-2 text-gray-700 bg-gray-200 rounded-md shadow-sm hover:bg-gray-300 text-sm">Reset All Questions</button>
                </div>
                <div className="flex gap-4 text-sm">
                  <span className="px-3 py-1 bg-blue-100 text-primary rounded-full font-medium">Questions: {questions.length}</span>
                  <span className="px-3 py-1 bg-green-100 text-success rounded-full font-medium">Total Points: {totalPoints}</span>
                </div>
              </div>

              <div className="space-y-4">
                {questions.length > 0 ? questions.map((q, index) => (
                  <div key={q.id} className="bg-gray-50 rounded-lg p-4 border">
                    <div className="flex justify-between items-start">
                      <p className="font-semibold">{index + 1}. {q.question} <span className="text-gray-500 font-normal text-sm">({q.points} pts)</span></p>
                      <div>
                        <button className="text-warning hover:text-yellow-600 mr-2"><EditIcon className="w-5 h-5" /></button>
                        <button onClick={() => handleDeleteQuestion(q.id)} className="text-danger hover:text-red-600"><TrashIcon className="w-5 h-5" /></button>
                      </div>
                    </div>
                    {q.type !== 'short-answer' && q.options && (
                      <div className="mt-2 pl-4 space-y-1">
                        {q.options.map(opt => (
                          <div key={opt.letter} className="flex items-center">
                            <input
                              type="radio"
                              name={`q_${q.id}`}
                              value={opt.letter}
                              onChange={(e) => setStudentAnswers(prev => ({ ...prev, [q.id]: e.target.value }))}
                              checked={studentAnswers[q.id] === opt.letter}
                              className="form-radio h-4 w-4 mr-2"
                            />
                            <label>{opt.letter}. {opt.text}</label>
                          </div>
                        ))}
                      </div>
                    )}
                    {q.type === 'short-answer' && (
                      <div className="mt-2 pl-4">
                        <input
                          type="text"
                          name={`q_${q.id}`}
                          value={studentAnswers[q.id] || ''}
                          onChange={(e) => setStudentAnswers(prev => ({ ...prev, [q.id]: e.target.value }))}
                          className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                          placeholder="Enter your answer"
                        />
                      </div>
                    )}
                  </div>
                )) : <div className="text-center text-gray-500 py-10">No questions have been added to the quiz.</div>}
              </div>

              {quizResults && (
                <div className="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                  <h3 className="text-lg font-semibold text-green-800 mb-2">Quiz Results</h3>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div className="text-center">
                      <p className="text-2xl font-bold text-green-600">{quizResults.score}%</p>
                      <p className="text-sm text-green-700">Overall Score</p>
                    </div>
                    <div className="text-center">
                      <p className="text-2xl font-bold text-blue-600">{quizResults.earnedPoints}/{quizResults.totalPoints}</p>
                      <p className="text-sm text-blue-700">Points Earned</p>
                    </div>
                    <div className="text-center">
                      <p className="text-2xl font-bold text-purple-600">{questions.length}</p>
                      <p className="text-sm text-purple-700">Total Questions</p>
                    </div>
                    <div className="text-center">
                      <p className="text-2xl font-bold text-orange-600">
                        {quizResults.detailedResults.filter(r => r.isCorrect).length}
                      </p>
                      <p className="text-sm text-orange-700">Correct Answers</p>
                    </div>
                  </div>
                  <div className="flex justify-end">
                    <button
                      onClick={handleDownloadResults}
                      className="flex items-center gap-2 px-4 py-2 text-white bg-primary rounded-md hover:bg-blue-600"
                    >
                      <DownloadIcon className="w-4 h-4" />
                      Download Results
                    </button>
                  </div>
                </div>
              )}

              <div className="flex justify-between mt-6">
                <button
                  onClick={handleSubmitAnswers}
                  disabled={!selectedStudentId || questions.length === 0}
                  className="px-6 py-2 text-white bg-success rounded-md shadow-sm hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Submit Answers
                </button>

                {quizResults && (
                  <button
                    onClick={handleDownloadResults}
                    className="flex items-center gap-2 px-6 py-2 text-white bg-primary rounded-md shadow-sm hover:bg-blue-600"
                  >
                    <DownloadIcon className="w-4 h-4" />
                    Download PDF Report
                  </button>
                )}
              </div>
            </div>
          </div>
          <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Add Comprehension Question">
            <QuestionForm onSave={handleAddQuestion} onClose={() => setIsModalOpen(false)} />
          </Modal>
        </div>
      );
    };

    // FIXED: Miscue Analysis Report Component for Results & Reports tab
    const MiscueAnalysisReport = ({ students, passages, teacherName }) => {
      const [selectedStudentId, setSelectedStudentId] = useState('');
      const [selectedAnalysisId, setSelectedAnalysisId] = useState('');
      const { miscueData, getMiscueDataByStudent, deleteMiscueAnalysis } = useMiscueStorage();

      const studentMiscueData = selectedStudentId ? getMiscueDataByStudent(parseInt(selectedStudentId, 10)) : [];
      const selectedAnalysis = studentMiscueData.find(item => item.id === parseInt(selectedAnalysisId, 10));
      const selectedStudent = students.find(s => s.id === parseInt(selectedStudentId, 10));

      // FIXED: Get passage from localStorage instead of hardcoded samplePassages
      const selectedPassage = selectedAnalysis ?
        (() => {
          // Try to get passage from localStorage first
          try {
            const storedPassages = JSON.parse(localStorage.getItem('echoText-passages') || '{}');
            return storedPassages[selectedAnalysis.passageId] || { title: 'Unknown Passage', wordCount: 0 };
          } catch (e) {
            return { title: 'Unknown Passage', wordCount: 0 };
          }
        })() : null;

      const handleDeleteAnalysis = (analysisId) => {
        if (window.confirm('Are you sure you want to delete this miscue analysis?')) {
          deleteMiscueAnalysis(parseInt(selectedStudentId, 10), analysisId);
          setSelectedAnalysisId('');
        }
      };

      const handleDownloadAnalysis = () => {
        if (!selectedAnalysis || !selectedStudent) return;

        // FIXED: Use the global jsPDF instance correctly
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(20).setFont("helvetica", "bold").text("EchoText Miscue Analysis Report", 105, 22, { align: 'center' });
        doc.setFontSize(12).setFont("helvetica", "normal");
        doc.text(`Student:`, 14, 40).setFont("helvetica", "bold").text(`${selectedStudent.firstName} ${selectedStudent.lastName}`, 34, 40);
        doc.setFont("helvetica", "normal").text(`Grade:`, 14, 47).setFont("helvetica", "bold").text(`${selectedStudent.gradeLevel === 'Kinder' ? 'Kindergarten' : `Grade ${selectedStudent.gradeLevel}`}`, 30, 47);
        doc.setFont("helvetica", "normal").text(`Date:`, 150, 40).setFont("helvetica", "bold").text(new Date(selectedAnalysis.timestamp).toLocaleDateString(), 162, 40);
        doc.setFont("helvetica", "normal").text(`Evaluated by:`, 14, 54).setFont("helvetica", "bold").text(`${teacherName || 'Teacher'}`, 42, 54);
        doc.setLineWidth(0.5).line(14, 60, 196, 60);

        if (selectedPassage) {
          doc.setFontSize(11).text(`Passage: ${selectedPassage.title}`, 14, 68);
        }

        // Analysis Summary
        doc.setFontSize(14).setFont("helvetica", "bold").text("Miscue Analysis Summary", 14, 85);
        const summary = selectedAnalysis.analysisResult.summary;

        // Compute word recognition based on passage word count and miscues
        const wordRecognition = selectedPassage && typeof selectedPassage.wordCount === 'number'
          ? Math.max(0, Math.round(((selectedPassage.wordCount - summary.totalMiscues) / selectedPassage.wordCount) * 100))
          : undefined;

        // Try to read stored assessments to find a comprehension score (week 8 preferred)
        let comprehensionVal = undefined;
        try {
          const storedAssessments = JSON.parse(localStorage.getItem('echoText-assessments') || '{}');
          const studentAssess = storedAssessments[selectedStudent.id] || [];
          const week8 = studentAssess.find(a => a.week === 8) || studentAssess.slice(-1)[0];
          if (week8 && typeof week8.comprehension === 'number') comprehensionVal = week8.comprehension;
        } catch (e) {
          // ignore parsing errors
        }

        const computePhilIri = (wr, comp) => {
          if (wr === undefined || comp === undefined) return { level: 'Not Assessed', badge: 'N/A' };
          if (wr >= 97 && comp >= 80) return { level: 'Independent', badge: 'Independent' };
          if (wr >= 90 && comp >= 59) return { level: 'Instructional', badge: 'Instructional' };
          if (wr < 1 || comp < 1) return { level: 'Non-Reader', badge: 'Non-Reader' };
          if (wr < 90 || comp < 59) return { level: 'Frustration', badge: 'Frustration' };
          return { level: 'Not Assessed', badge: 'N/A' };
        };

        const phil = computePhilIri(wordRecognition, comprehensionVal);

        doc.autoTable({
          startY: 95,
          head: [['Metric', 'Count']],
          body: [
            ['Total Miscues', summary.totalMiscues.toString()],
            ['Substitutions', summary.substitutions.toString()],
            ['Omissions', summary.omissions.toString()],
            ['Insertions', summary.insertions.toString()],
            ['Repetitions', summary.repetitions.toString()],
            ['Reversals', summary.reversals.toString()],
            ['Word Recognition', wordRecognition !== undefined ? `${wordRecognition}%` : 'N/A'],
            ['Comprehension Score', comprehensionVal !== undefined ? `${comprehensionVal}%` : 'N/A'],
            ['PHIL-IRI Level', phil.level]
          ],
          theme: 'striped',
          headStyles: { fillColor: [44, 62, 80] }
        });

        // Student Reading - FIXED: Added proper spacing to prevent overlap
        const studentReadingY = doc.lastAutoTable.finalY + 25;
        doc.setFontSize(14).setFont("helvetica", "bold").text("Student Reading", 14, studentReadingY - 10);
        doc.setFontSize(10).setFont("helvetica", "normal");
        const studentReadingLines = doc.splitTextToSize(selectedAnalysis.studentReading, 180);
        doc.text(studentReadingLines, 14, studentReadingY);

        // Detailed Miscues - FIXED: Added proper spacing
        if (selectedAnalysis.analysisResult.miscues.length > 0) {
          const miscueStartY = studentReadingY + (studentReadingLines.length * 5) + 20;
          doc.setFontSize(14).setFont("helvetica", "bold").text("Detailed Miscue Analysis", 14, miscueStartY);

          const miscueTableData = selectedAnalysis.analysisResult.miscues.map((miscue, index) => [
            index + 1,
            miscue.type,
            miscue.originalWord,
            miscue.studentWord,
            miscue.explanation
          ]);

          doc.autoTable({
            startY: miscueStartY + 10,
            head: [['#', 'Type', 'Original Word', 'Student Read', 'Explanation']],
            body: miscueTableData,
            theme: 'grid',
            headStyles: { fillColor: [44, 62, 80] },
            styles: { fontSize: 8 },
            columnStyles: {
              0: { cellWidth: 10 },
              1: { cellWidth: 25 },
              2: { cellWidth: 30 },
              3: { cellWidth: 30 },
              4: { cellWidth: 95 }
            }
          });
        }

        doc.save(`Miscue_Analysis_${selectedStudent.firstName}_${selectedStudent.lastName}_${new Date(selectedAnalysis.timestamp).toISOString().split('T')[0]}.pdf`);
      };

      return (
        <div className="bg-white rounded-lg shadow-md p-6">
          <h3 className="text-xl font-bold text-gray-800 mb-4">Miscue Analysis Reports</h3>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Select Student</label>
              <select
                value={selectedStudentId}
                onChange={(e) => {
                  setSelectedStudentId(e.target.value);
                  setSelectedAnalysisId('');
                }}
                className="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm"
              >
                <option value="">Select a student</option>
                {students.map(s => (
                  <option key={s.id} value={s.id}>{s.firstName} {s.lastName}</option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Select Analysis</label>
              <select
                value={selectedAnalysisId}
                onChange={(e) => setSelectedAnalysisId(e.target.value)}
                className="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm"
                disabled={!selectedStudentId || studentMiscueData.length === 0}
              >
                <option value="">Select an analysis</option>
                {studentMiscueData.map(item => {
                  // FIXED: Get the passage title correctly
                  const passageTitle = (() => {
                    try {
                      const storedPassages = JSON.parse(localStorage.getItem('echoText-passages') || '{}');
                      return storedPassages[item.passageId]?.title || 'Unknown Passage';
                    } catch (e) {
                      return 'Unknown Passage';
                    }
                  })();
                  const date = new Date(item.timestamp).toLocaleDateString();
                  return (
                    <option key={item.id} value={item.id}>
                      {passageTitle} - {date}
                    </option>
                  );
                })}
              </select>
            </div>
          </div>

          {selectedAnalysis && (
            <div className="border rounded-lg p-6 bg-gray-50">
              <div className="flex justify-between items-center mb-4">
                <h4 className="text-lg font-bold text-gray-800">Miscue Analysis Details</h4>
                <div className="flex gap-2">
                  <button
                    onClick={handleDownloadAnalysis}
                    className="flex items-center gap-2 px-4 py-2 text-white bg-primary rounded-md hover:bg-blue-600"
                  >
                    <DownloadIcon className="w-5 h-5" />
                    Download Report
                  </button>
                  <button
                    onClick={() => handleDeleteAnalysis(selectedAnalysis.id)}
                    className="flex items-center gap-2 px-4 py-2 text-white bg-danger rounded-md hover:bg-red-600"
                  >
                    <TrashIcon className="w-5 h-5" />
                    Delete
                  </button>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4 mb-4 text-sm">
                <div>
                  <p><strong>Student:</strong> {selectedStudent.firstName} {selectedStudent.lastName}</p>
                  <p><strong>Date:</strong> {new Date(selectedAnalysis.timestamp).toLocaleDateString()}</p>
                </div>
                <div>
                  <p><strong>Passage:</strong> {selectedPassage ? selectedPassage.title : 'Unknown'}</p>
                  <p><strong>Total Miscues:</strong> {selectedAnalysis.analysisResult.summary.totalMiscues}</p>
                </div>
              </div>

              <SummaryCard summary={selectedAnalysis.analysisResult.summary} />

              <div className="mt-6">
                <h5 className="text-lg font-semibold text-gray-800 mb-2">Student Reading</h5>
                <div className="bg-white p-4 rounded border">
                  <p className="text-gray-700">{selectedAnalysis.studentReading}</p>
                </div>
              </div>

              {selectedAnalysis.analysisResult.miscues.length > 0 && (
                <div className="mt-6">
                  <h5 className="text-lg font-semibold text-gray-800 mb-2">Detailed Miscues</h5>
                  <div className="space-y-4">
                    {selectedAnalysis.analysisResult.miscues.map((miscue, index) => (
                      <div key={index} className={`border-l-4 ${miscue.type === 'Substitution' ? 'border-yellow-500 bg-yellow-50' :
                        miscue.type === 'Omission' ? 'border-red-500 bg-red-50' :
                          miscue.type === 'Insertion' ? 'border-blue-500 bg-blue-50' :
                            miscue.type === 'Repetition' ? 'border-green-500 bg-green-50' :
                              'border-indigo-500 bg-indigo-50'
                        } p-4 rounded-r-lg`}>
                        <div className="flex justify-between">
                          <h6 className="font-bold">{miscue.type}</h6>
                          <span className="text-sm text-gray-500">#{index + 1}</span>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
                          <div>
                            <p className="text-sm text-gray-600">Original:</p>
                            <p className="font-mono text-red-600 line-through">{miscue.originalWord}</p>
                          </div>
                          <div>
                            <p className="text-sm text-gray-600">Student Read:</p>
                            <p className="font-mono text-green-600">{miscue.studentWord}</p>
                          </div>
                        </div>
                        <div className="mt-2">
                          <p className="text-sm text-gray-600">Context:</p>
                          <p className="text-sm italic">..."{miscue.context}"...</p>
                        </div>
                        <div className="mt-2">
                          <p className="text-sm text-gray-600">Explanation:</p>
                          <p className="text-sm">{miscue.explanation}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          {selectedStudentId && studentMiscueData.length === 0 && (
            <div className="text-center py-8 border-2 border-dashed rounded-lg">
              <p className="text-gray-500">No miscue analysis data available for this student.</p>
            </div>
          )}

          {!selectedStudentId && (
            <div className="text-center py-8 border-2 border-dashed rounded-lg">
              <p className="text-gray-500">Select a student to view their miscue analysis reports.</p>
            </div>
          )}
        </div>
      );
    };

    // NEW: Class Summary Modal Component
    const ClassSummaryModal = ({ isOpen, onClose, students, assessments, teacherName }) => {
      const [selectedWeek, setSelectedWeek] = useState('1');
      const [settings] = useAssessmentSettings();

      const getPhilIriLevel = (wordRecognition, comprehension) => {
        if (wordRecognition === undefined || comprehension === undefined) return { level: 'Not Assessed', badge: 'N/A' };
        if (wordRecognition >= 97 && comprehension >= 80) return { level: 'Independent', badge: 'Independent' };
        if (wordRecognition >= 90 && comprehension >= 59) return { level: 'Instructional', badge: 'Instructional' };
        if (wordRecognition < 1 || comprehension < 1) return { level: 'Non-Reader', badge: 'Non-Reader' };
        if (wordRecognition < 90 || comprehension < 59) return { level: 'Frustration', badge: 'Frustration' };
        return { level: 'Not Assessed', badge: 'N/A' };
      };

      const classSummaryData = useMemo(() => {
        const week = parseInt(selectedWeek, 10);
        return students
          .map(student => {
            const studentAssessments = assessments[student.id] || [];
            const weekAssessment = studentAssessments.find(a => a.week === week);
            const levelInfo = weekAssessment ?
              getPhilIriLevel(weekAssessment.wordRecognition, weekAssessment.comprehension) :
              { level: 'Not Assessed', badge: 'N/A' };

            return {
              id: student.id,
              name: `${student.firstName} ${student.lastName}`,
              readingProfile: levelInfo.level
            };
          })
          .sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically by name
      }, [students, assessments, selectedWeek]);

      const handleDownloadClassSummary = () => {
        if (classSummaryData.length === 0) return;

        // FIXED: Use the global jsPDF instance
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(20).setFont("helvetica", "bold").text("EchoText Class Summary Report", 105, 22, { align: 'center' });
        doc.setFontSize(12).setFont("helvetica", "normal");
        doc.text(`Assessment Period:`, 14, 40).setFont("helvetica", "bold").text(`${settings.reportPeriod === 'weeks' ? 'Week' : 'Day'} ${selectedWeek}`, 50, 40);
        doc.setFont("helvetica", "normal").text(`Date:`, 150, 40).setFont("helvetica", "bold").text(new Date().toLocaleDateString(), 162, 40);
        doc.setFont("helvetica", "normal").text(`Evaluated by:`, 14, 47).setFont("helvetica", "bold").text(`${teacherName || 'Teacher'}`, 42, 47);
        doc.setLineWidth(0.5).line(14, 55, 196, 55);

        // Create table data with the required column order
        const tableData = [
          ['No.', 'Name of Learner', 'Reading Profile']
        ];

        classSummaryData.forEach((student, index) => {
          tableData.push([
            (index + 1).toString(),
            student.name,
            student.readingProfile
          ]);
        });

        doc.autoTable({
          startY: 65,
          head: [tableData[0]],
          body: tableData.slice(1),
          theme: 'grid',
          headStyles: { fillColor: [44, 62, 80] },
          styles: { fontSize: 10 },
          columnStyles: {
            0: { cellWidth: 15 },
            1: { cellWidth: 100 },
            2: { cellWidth: 70 }
          }
        });

        doc.save(`Class_Summary_${settings.reportPeriod === 'weeks' ? 'Week' : 'Day'}_${selectedWeek}.pdf`);
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Download Class Summary">
          <div className="space-y-4">
            <div className="bg-blue-50 p-4 rounded-md border border-blue-200">
              <p className="text-sm text-blue-700">
                Download a summary of all students' reading profiles for a selected assessment period.
                The report will be organized with students in alphabetical order.
              </p>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Select Assessment Period
              </label>
              <select
                value={selectedWeek}
                onChange={(e) => setSelectedWeek(e.target.value)}
                className="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm"
              >
                {Array.from({ length: settings.totalWeeks }, (_, i) => (
                  <option key={i + 1} value={i + 1}>
                    {settings.reportPeriod === 'weeks' ? 'Week ' : 'Day '}{i + 1}
                  </option>
                ))}
              </select>
            </div>

            <div className="mt-4">
              <h4 className="text-lg font-semibold text-gray-800 mb-2">Preview</h4>
              <div className="bg-gray-50 p-4 rounded-md border max-h-64 overflow-y-auto">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">No.</th>
                      <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name of Learner</th>
                      <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Reading Profile</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {classSummaryData.map((student, index) => (
                      <tr key={student.id}>
                        <td className="px-4 py-2 text-sm text-gray-500">{index + 1}</td>
                        <td className="px-4 py-2 text-sm font-medium text-gray-900">{student.name}</td>
                        <td className="px-4 py-2 text-sm text-gray-500">{student.readingProfile}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            <div className="flex justify-end gap-2 pt-4">
              <button
                onClick={onClose}
                className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300"
              >
                Cancel
              </button>
              <button
                onClick={handleDownloadClassSummary}
                className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-blue-600"
              >
                <DownloadIcon className="w-4 h-4" />
                Download Class Summary
              </button>
            </div>
          </div>
        </Modal>
      );
    };

    // NEW: Prosody Report Component for Results & Reports tab
    const ProsodyReport = ({ students, passages, teacherName }) => {
      const [selectedStudentId, setSelectedStudentId] = useState('');
      const [selectedAnalysisId, setSelectedAnalysisId] = useState('');
      const { prosodyData } = useProsodyStorage();

      const studentProsodyData = selectedStudentId ? prosodyData[parseInt(selectedStudentId, 10)] || [] : [];
      const selectedAnalysis = studentProsodyData.find(item => item.id === parseInt(selectedAnalysisId, 10));
      const selectedStudent = students.find(s => s.id === parseInt(selectedStudentId, 10));

      const getPassageTitle = (passageId) => {
        try {
          const storedPassages = JSON.parse(localStorage.getItem('echoText-passages') || '{}');
          return storedPassages[passageId]?.title || 'Unknown Passage';
        } catch (e) {
          return 'Unknown Passage';
        }
      };

      const handleDownloadReport = () => {
        if (!selectedAnalysis || !selectedStudent) return;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(20).setFont("helvetica", "bold").text("EchoText Prosody Report", 105, 22, { align: 'center' });
        doc.setFontSize(12).setFont("helvetica", "normal");
        doc.text(`Student:`, 14, 40).setFont("helvetica", "bold").text(`${selectedStudent.firstName} ${selectedStudent.lastName}`, 34, 40);
        doc.setFont("helvetica", "normal").text(`Grade:`, 14, 47).setFont("helvetica", "bold").text(`${selectedStudent.gradeLevel === 'Kinder' ? 'Kindergarten' : `Grade ${selectedStudent.gradeLevel}`}`, 30, 47);
        doc.setFont("helvetica", "normal").text(`Date:`, 150, 40).setFont("helvetica", "bold").text(new Date(selectedAnalysis.timestamp).toLocaleDateString(), 162, 40);
        doc.setFont("helvetica", "normal").text(`Evaluated by:`, 14, 54).setFont("helvetica", "bold").text(`${teacherName || 'Teacher'}`, 42, 54);
        doc.setLineWidth(0.5).line(14, 60, 196, 60);

        const passageTitle = getPassageTitle(selectedAnalysis.passageId);
        doc.setFontSize(11).text(`Passage: ${passageTitle}`, 14, 68);

        doc.setFontSize(14).setFont("helvetica", "bold").text("Prosody Analysis Summary", 14, 85);
        const { scores, overallScore, wpm, feedback } = selectedAnalysis.result;

        doc.autoTable({
          startY: 95,
          head: [['Metric', 'Score']],
          body: [
            ['Overall Score', `${overallScore}/100`],
            ['Phrasing', `${scores.phrasing}/100`],
            ['Intonation', `${scores.intonation}/100`],
            ['Stress', `${scores.stress}/100`],
            ['Rate', `${scores.rate}/100 (${wpm} WPM)`],
          ],
          theme: 'striped',
          headStyles: { fillColor: [44, 62, 80] }
        });

        const feedbackY = doc.lastAutoTable.finalY + 15;
        doc.setFontSize(14).setFont("helvetica", "bold").text("Feedback", 14, feedbackY);
        doc.setFontSize(10).setFont("helvetica", "normal");
        const feedbackLines = doc.splitTextToSize(feedback, 180);
        doc.text(feedbackLines, 14, feedbackY + 8);

        doc.save(`Prosody_Report_${selectedStudent.firstName}_${selectedStudent.lastName}_${new Date(selectedAnalysis.timestamp).toISOString().split('T')[0]}.pdf`);
      };

      const ProgressRing = ({ score, size = 'w-24 h-24', stroke = 8, fontSize = 'text-2xl' }) => {
        const radius = 40;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (score / 100) * circumference;
        let colorClass = 'text-success';
        if (score < 80) colorClass = 'text-primary';
        if (score < 60) colorClass = 'text-warning';
        if (score < 40) colorClass = 'text-danger';

        return (
          <div className={`relative flex items-center justify-center ${size}`}>
            <svg className="progress-ring w-full h-full" viewBox="0 0 100 100">
              <circle className="text-gray-200" strokeWidth={stroke} stroke="currentColor" fill="transparent" r={radius} cx="50" cy="50" />
              <circle className={`progress-ring__circle ${colorClass}`} strokeWidth={stroke} strokeDasharray={circumference} strokeDashoffset={offset} stroke="currentColor" fill="transparent" r={radius} cx="50" cy="50" />
            </svg>
            <span className={`absolute font-bold ${fontSize}`}>{score}</span>
          </div>
        );
      };

      return (
        <div className="bg-white rounded-lg shadow-md p-6">
          <h3 className="text-xl font-bold text-gray-800 mb-4">Prosody Results</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <select value={selectedStudentId} onChange={e => { setSelectedStudentId(e.target.value); setSelectedAnalysisId(''); }} className="block w-full rounded-md border-gray-300">
              <option value="">Select a student</option>
              {students.map(s => <option key={s.id} value={s.id}>{s.firstName} {s.lastName}</option>)}
            </select>
            <select value={selectedAnalysisId} onChange={e => setSelectedAnalysisId(e.target.value)} className="block w-full rounded-md border-gray-300" disabled={!selectedStudentId || studentProsodyData.length === 0}>
              <option value="">Select a result</option>
              {studentProsodyData.map(item => (
                <option key={item.id} value={item.id}>
                  {getPassageTitle(item.passageId)} - {new Date(item.timestamp).toLocaleString()}
                </option>
              ))}
            </select>
          </div>

          {selectedAnalysis ? (
            <div className="border-2 border-dashed rounded-lg p-6">
              <div className="flex justify-between items-start mb-6">
                <div>
                  <h4 className="text-xl font-bold text-gray-800">{getPassageTitle(selectedAnalysis.passageId)}</h4>
                  <p className="text-sm text-gray-500">Result from {new Date(selectedAnalysis.timestamp).toLocaleString()}</p>
                </div>
                <button onClick={handleDownloadReport} className="flex items-center gap-2 px-4 py-2 text-white bg-primary rounded-md hover:bg-blue-600">
                  <DownloadIcon className="w-5 h-5" /> Download Report
                </button>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-5 gap-6 items-center">
                <div className="md:col-span-2 flex justify-center">
                  <ProgressRing score={selectedAnalysis.result.overallScore} size="w-32 h-32" stroke="10" fontSize="text-3xl" />
                </div>
                <div className="md:col-span-3 space-y-4">
                  <div className="prosody-score-card flex justify-between items-center bg-blue-50 p-3 rounded-lg">
                    <span className="font-semibold">Phrasing</span><span className="font-bold text-blue-600">{selectedAnalysis.result.scores.phrasing}/100</span>
                  </div>
                  <div className="prosody-score-card flex justify-between items-center bg-green-50 p-3 rounded-lg">
                    <span className="font-semibold">Intonation</span><span className="font-bold text-green-600">{selectedAnalysis.result.scores.intonation}/100</span>
                  </div>
                  <div className="prosody-score-card flex justify-between items-center bg-yellow-50 p-3 rounded-lg">
                    <span className="font-semibold">Stress</span><span className="font-bold text-yellow-600">{selectedAnalysis.result.scores.stress}/100</span>
                  </div>
                  <div className="prosody-score-card flex justify-between items-center bg-red-50 p-3 rounded-lg">
                    <span className="font-semibold">Rate ({selectedAnalysis.result.wpm} WPM)</span><span className="font-bold text-red-600">{selectedAnalysis.result.scores.rate}/100</span>
                  </div>
                </div>
              </div>
              <div className="mt-6 text-center bg-gray-100 p-4 rounded-lg">
                <p className="font-semibold">Feedback:</p>
                <p className="text-gray-700">{selectedAnalysis.result.feedback}</p>
              </div>
            </div>
          ) : (
            <div className="text-center py-12 border-2 border-dashed rounded-lg">
              <p className="text-gray-500">
                {selectedStudentId ? 'Select a prosody result to view details.' : 'Select a student to view their prosody results.'}
              </p>
            </div>
          )}
        </div>
      );
    };

    // NEW: Comprehension Quiz Report Component for Results & Reports tab
    const ComprehensionQuizReport = ({ students, teacherName }) => {
      const [selectedStudentId, setSelectedStudentId] = useState('');
      const [selectedResultId, setSelectedResultId] = useState('');
      const { results, getResultsByStudent, deleteResult } = useComprehensionResults();

      const studentResults = selectedStudentId ? getResultsByStudent(parseInt(selectedStudentId, 10)) : [];
      const selectedResult = studentResults.find(r => r.id === parseInt(selectedResultId, 10));
      const selectedStudent = students.find(s => s.id === parseInt(selectedStudentId, 10));

      const handleDownloadReport = () => {
        if (!selectedResult || !selectedStudent) return;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(20).setFont("helvetica", "bold").text("EchoText Comprehension Quiz Report", 105, 22, { align: 'center' });
        doc.setFontSize(12).setFont("helvetica", "normal");
        doc.text(`Student:`, 14, 40).setFont("helvetica", "bold").text(`${selectedStudent.firstName} ${selectedStudent.lastName}`, 34, 40);
        doc.setFont("helvetica", "normal").text(`Grade:`, 14, 47).setFont("helvetica", "bold").text(`${selectedStudent.gradeLevel === 'Kinder' ? 'Kindergarten' : `Grade ${selectedStudent.gradeLevel}`}`, 30, 47);
        doc.setFont("helvetica", "normal").text(`Date:`, 150, 40).setFont("helvetica", "bold").text(new Date(selectedResult.timestamp).toLocaleDateString(), 162, 40);
        doc.setFont("helvetica", "normal").text(`Evaluated by:`, 14, 54).setFont("helvetica", "bold").text(`${teacherName || 'Teacher'}`, 42, 54);
        doc.setLineWidth(0.5).line(14, 60, 196, 60);

        const totalPoints = selectedResult.quizData.reduce((sum, q) => sum + q.points, 0);
        let earnedPoints = 0;
        selectedResult.quizData.forEach(q => {
          const studentAnswer = selectedResult.answers[q.id];
          if (studentAnswer && q.correctAnswer.toLowerCase() === studentAnswer.toLowerCase()) {
            earnedPoints += q.points;
          }
        });

        doc.setFontSize(14).setFont("helvetica", "bold").text("Quiz Summary", 14, 75);
        doc.autoTable({
          startY: 80,
          head: [['Metric', 'Value']],
          body: [
            ['Total Score', `${selectedResult.score}%`],
            ['Points Earned', `${earnedPoints}/${totalPoints}`],
            ['Number of Questions', selectedResult.quizData.length.toString()],
            ['Date Completed', new Date(selectedResult.timestamp).toLocaleDateString()]
          ],
          theme: 'striped',
          headStyles: { fillColor: [44, 62, 80] }
        });

        const detailedResults = selectedResult.quizData.map((q, index) => {
          const studentAnswer = selectedResult.answers[q.id] || 'No answer';
          const isCorrect = q.correctAnswer.toLowerCase() === studentAnswer.toLowerCase();
          return [
            index + 1,
            q.question,
            studentAnswer,
            q.correctAnswer,
            isCorrect ? 'Correct' : 'Incorrect',
            `${isCorrect ? q.points : 0}/${q.points}`
          ];
        });

        doc.setFontSize(14).setFont("helvetica", "bold").text("Detailed Question Results", 14, doc.lastAutoTable.finalY + 15);
        doc.autoTable({
          startY: doc.lastAutoTable.finalY + 25,
          head: [['#', 'Question', 'Student Answer', 'Correct Answer', 'Result', 'Points']],
          body: detailedResults,
          theme: 'grid',
          headStyles: { fillColor: [44, 62, 80] },
          styles: { fontSize: 8 },
          columnStyles: { 0: { cellWidth: 10 }, 1: { cellWidth: 45 }, 2: { cellWidth: 30 }, 3: { cellWidth: 30 }, 4: { cellWidth: 20 }, 5: { cellWidth: 20 } }
        });

        doc.save(`Comprehension_Report_${selectedStudent.firstName}_${selectedStudent.lastName}_${new Date(selectedResult.timestamp).toISOString().split('T')[0]}.pdf`);
      };

      return (
        <div className="bg-white rounded-lg shadow-md p-6">
          <h3 className="text-xl font-bold text-gray-800 mb-4">Comprehension Quiz Reports</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <select value={selectedStudentId} onChange={e => { setSelectedStudentId(e.target.value); setSelectedResultId(''); }} className="block w-full rounded-md border-gray-300">
              <option value="">Select a student</option>
              {students.map(s => <option key={s.id} value={s.id}>{s.firstName} {s.lastName}</option>)}
            </select>
            <select value={selectedResultId} onChange={e => setSelectedResultId(e.target.value)} className="block w-full rounded-md border-gray-300" disabled={!selectedStudentId || studentResults.length === 0}>
              <option value="">Select a quiz result</option>
              {studentResults.map(r => (
                <option key={r.id} value={r.id}>
                  Quiz from {new Date(r.timestamp).toLocaleString()} - {r.score}%
                </option>
              ))}
            </select>
          </div>

          {selectedResult ? (
            <div className="border rounded-lg p-6 bg-gray-50">
              <div className="flex justify-between items-start mb-4">
                <div>
                  <h4 className="text-xl font-bold text-gray-800">Quiz Result Details</h4>
                  <p className="text-sm text-gray-500">Completed on: {new Date(selectedResult.timestamp).toLocaleString()}</p>
                </div>
                <button onClick={handleDownloadReport} className="flex items-center gap-2 px-4 py-2 text-white bg-primary rounded-md hover:bg-blue-600">
                  <DownloadIcon className="w-5 h-5" /> Download Report
                </button>
              </div>
              <div className="mb-4 text-center p-4 bg-blue-100 rounded-lg">
                <p className="text-lg font-medium text-blue-800">Overall Score</p>
                <p className="text-4xl font-bold text-primary">{selectedResult.score}%</p>
              </div>
              <div className="space-y-4 max-h-96 overflow-y-auto">
                {selectedResult.quizData.map((q, index) => {
                  const studentAnswer = selectedResult.answers[q.id] || 'No answer';
                  const isCorrect = q.correctAnswer.toLowerCase() === studentAnswer.toLowerCase();
                  return (
                    <div key={q.id} className={`p-4 rounded-lg border-l-4 ${isCorrect ? 'border-success bg-green-50' : 'border-danger bg-red-50'}`}>
                      <p className="font-semibold">{index + 1}. {q.question}</p>
                      <p className="text-sm mt-2">Student's Answer: <span className="font-medium">{studentAnswer}</span></p>
                      {!isCorrect && <p className="text-sm">Correct Answer: <span className="font-medium">{q.correctAnswer}</span></p>}
                    </div>
                  );
                })}
              </div>
            </div>
          ) : (
            <div className="text-center py-12 border-2 border-dashed rounded-lg">
              <p className="text-gray-500">
                {selectedStudentId ? 'Select a quiz result to view details.' : 'Select a student to view their quiz history.'}
              </p>
            </div>
          )}
        </div>
      );
    };

    // UPDATED: Results component with Progress Report Settings, Miscue Analysis Report, and Class Summary
    const Results = ({ students, assessments, teacherName }) => {
      const [selectedStudentId, setSelectedStudentId] = useState(''); // Used by Progress Report
      const [activeTab, setActiveTab] = useState('progress'); // 'progress', 'miscue', 'prosody', 'comprehension'
      const [settings, updateSettings] = useProgressReportSettings();
      const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
      const [isClassSummaryModalOpen, setIsClassSummaryModalOpen] = useState(false); // NEW: Class Summary Modal state

      const getPhilIriLevel = (wordRecognition, comprehension) => {
        if (wordRecognition === undefined || comprehension === undefined) {
          return { level: 'Not Assessed', badgeClass: 'bg-gray-400' };
        }
        if (wordRecognition >= 97 && comprehension >= 80) return { level: 'Independent', badgeClass: 'bg-success' };
        if (wordRecognition >= 90 && comprehension >= 59) return { level: 'Instructional', badgeClass: 'bg-primary' };
        if (wordRecognition < 1 || comprehension < 1) return { level: 'Non-Reader', badgeClass: 'bg-danger' };
        if (wordRecognition < 90 || comprehension < 59) return { level: 'Frustration', badgeClass: 'bg-warning' };
        return { level: 'Not Assessed', badgeClass: 'bg-gray-400' };
      };

      const reportData = useMemo(() => {
        if (!selectedStudentId) return null;
        const studentId = parseInt(selectedStudentId, 10);
        const student = students.find(s => s.id === studentId);
        if (!student) return null;

        const studentAssessments = assessments[studentId] || [];
        const totalPeriods = settings.totalWeeks;

        // Get data for all periods based on settings
        const periodData = Array.from({ length: totalPeriods }, (_, i) => {
          const period = i + 1;
          return studentAssessments.find(a => a.week === period);
        });

        // Get first and last assessment for progress calculation
        const firstAssessment = studentAssessments.find(a => a.week === 1);
        const lastAssessment = studentAssessments.find(a => a.week === totalPeriods) ||
          studentAssessments[studentAssessments.length - 1];

        const createRowData = (key, name, unit = '%') => {
          const val1 = firstAssessment?.[key];
          const valLast = lastAssessment?.[key];
          const progress = (typeof val1 === 'number' && typeof valLast === 'number') ? `${valLast - val1}${unit}` : '-';

          // Create data for all periods
          const periodValues = periodData.map(assessment => {
            const value = assessment?.[key];
            return typeof value === 'number' ? `${value}${unit}` : '-';
          });

          return {
            name,
            periodValues,
            progress
          };
        };

        const tableRows = [
          createRowData('wordRecognition', 'Word Recognition'),
          createRowData('readingSpeed', 'Reading Speed (WPM)', ' WPM'),
          createRowData('comprehension', 'Comprehension')
        ];
        const finalLevel = getPhilIriLevel(lastAssessment?.wordRecognition, lastAssessment?.comprehension);

        return { student, tableRows, finalLevel, totalPeriods };
      }, [selectedStudentId, students, assessments, settings]);

      const handleDownloadProgressReport = () => {
        if (!reportData) return;

        // FIXED: Use the global jsPDF instance
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(20).setFont("helvetica", "bold").text("EchoText Progress Report", 105, 22, { align: 'center' });
        doc.setFontSize(12).setFont("helvetica", "normal");
        doc.text(`Student:`, 14, 40).setFont("helvetica", "bold").text(`${reportData.student.firstName} ${reportData.student.lastName}`, 34, 40);
        doc.setFont("helvetica", "normal").text(`Grade:`, 14, 47).setFont("helvetica", "bold").text(`${reportData.student.gradeLevel === 'Kinder' ? 'Kindergarten' : `Grade ${reportData.student.gradeLevel}`}`, 30, 47);
        doc.setFont("helvetica", "normal").text(`Date:`, 150, 40).setFont("helvetica", "bold").text(new Date().toLocaleDateString(), 162, 40);
        doc.setFont("helvetica", "normal").text(`Evaluated by:`, 14, 54).setFont("helvetica", "bold").text(`${teacherName || 'Teacher'}`, 42, 54);
        doc.setLineWidth(0.5).line(14, 60, 196, 60);

        // Report period information
        doc.setFontSize(11).text(`Report Period: ${settings.totalWeeks} ${settings.reportPeriod}`, 14, 68);
        doc.setFontSize(11).text(`PHIL-IRI Level: ${reportData.finalLevel.level}`, 150, 68);

        // Create table data
        const tableData = [
          ['Assessment Area', ...Array.from({ length: reportData.totalPeriods }, (_, i) =>
            `${settings.reportPeriod === 'weeks' ? 'Week' : 'Day'} ${i + 1}`), 'Progress']
        ];

        reportData.tableRows.forEach(row => {
          tableData.push([row.name, ...row.periodValues, row.progress]);
        });

        doc.autoTable({
          startY: 80,
          head: [tableData[0]],
          body: tableData.slice(1),
          theme: 'grid',
          headStyles: { fillColor: [44, 62, 80] },
          styles: { fontSize: 9 },
          columnStyles: {
            0: { cellWidth: 45 },
            ...Array.from({ length: reportData.totalPeriods + 1 }, (_, i) => ({ cellWidth: 25 }))
          }
        });

        doc.save(`Progress_Report_${reportData.student.firstName}_${reportData.student.lastName}.pdf`);
      };

      return (
        <div>
          <h2 className="text-2xl font-bold text-gray-800 mb-4">Results & Reports</h2>

          <div className="bg-white rounded-lg shadow-md mb-6">
            <div className="border-b">
              <div className="flex">
                <button
                  className={`flex-1 px-4 py-3 text-center font-medium ${activeTab === 'progress'
                    ? 'text-primary border-b-2 border-primary'
                    : 'text-gray-500 hover:text-gray-700'
                    }`}
                  onClick={() => setActiveTab('progress')}
                >
                  Progress Report
                </button>
                <button
                  className={`flex-1 px-4 py-3 text-center font-medium ${activeTab === 'miscue'
                    ? 'text-primary border-b-2 border-primary'
                    : 'text-gray-500 hover:text-gray-700'
                    }`}
                  onClick={() => setActiveTab('miscue')}
                >
                  Miscue Analysis
                </button>
                <button
                  className={`flex-1 px-4 py-3 text-center font-medium ${activeTab === 'prosody' ? 'text-primary border-b-2 border-primary' : 'text-gray-500 hover:text-gray-700'}`}
                  onClick={() => setActiveTab('prosody')}
                >
                  Prosody Results
                </button>
                <button
                  className={`flex-1 px-4 py-3 text-center font-medium ${activeTab === 'comprehension'
                    ? 'text-primary border-b-2 border-primary'
                    : 'text-gray-500 hover:text-gray-700'
                    }`}
                  onClick={() => setActiveTab('comprehension')}
                >
                  Comprehension Quiz
                </button>
              </div>
            </div>

            <div className="p-6">
              {activeTab === 'progress' && (
                <div>
                  <div className="flex flex-wrap justify-between items-center gap-4 mb-6">
                    <select
                      value={selectedStudentId}
                      onChange={e => setSelectedStudentId(e.target.value)}
                      className="block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm"
                    >
                      <option value="">Select a student</option>
                      {students.map(s => <option key={s.id} value={s.id}>{s.firstName} {s.lastName}</option>)}
                    </select>
                    <div className="flex gap-2">
                      <button onClick={() => setIsSettingsModalOpen(true)} className="px-4 py-2 text-sm text-white bg-secondary rounded-md hover:bg-gray-600">Report Settings</button>
                      <button onClick={() => setIsClassSummaryModalOpen(true)} className="px-4 py-2 text-sm text-white bg-primary rounded-md hover:bg-blue-600">Class Summary</button>
                    </div>
                  </div>
                  {reportData ? (
                    <div className="border rounded-lg p-6 bg-gray-50">
                      <div className="flex justify-between items-start mb-4">
                        <div>
                          <h3 className="text-xl font-bold text-gray-800">{reportData.student.firstName} {reportData.student.lastName}</h3>
                          <p className="text-sm text-gray-500">Final PHIL-IRI Level: <span className={`px-2 py-1 text-xs font-semibold text-white rounded-full ${reportData.finalLevel.badgeClass}`}>{reportData.finalLevel.level}</span></p>
                        </div>
                        <button onClick={handleDownloadProgressReport} className="flex items-center gap-2 px-4 py-2 text-white bg-primary rounded-md hover:bg-blue-600">
                          <DownloadIcon className="w-5 h-5" /> Download Report
                        </button>
                      </div>
                      <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200 border">
                          <thead className="bg-gray-100"><tr>
                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase border">Assessment Area</th>
                            {Array.from({ length: reportData.totalPeriods }, (_, i) => <th key={i} className="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase border">{settings.reportPeriod === 'weeks' ? 'W' : 'D'}{i + 1}</th>)}
                            <th className="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase border">Progress</th>
                          </tr></thead>
                          <tbody className="bg-white divide-y divide-gray-200">
                            {reportData.tableRows.map(row => (
                              <tr key={row.name}>
                                <td className="px-4 py-2 font-medium border">{row.name}</td>
                                {row.periodValues.map((val, i) => <td key={i} className="px-4 py-2 text-center border">{val}</td>)}
                                <td className="px-4 py-2 text-center font-medium border">{row.progress}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  ) : <div className="text-center py-12 border-2 border-dashed rounded-lg"><p className="text-gray-500">Select a student to view their progress report.</p></div>}
                </div>
              )}
              {activeTab === 'miscue' && <MiscueAnalysisReport students={students} passages={{}} teacherName={teacherName} />}
              {activeTab === 'prosody' && <ProsodyReport students={students} passages={{}} teacherName={teacherName} />}
              {activeTab === 'comprehension' && <ComprehensionQuizReport students={students} teacherName={teacherName} />}
            </div>
          </div>

          <ProgressReportSettingsModal
            isOpen={isSettingsModalOpen}
            onClose={() => setIsSettingsModalOpen(false)}
            settings={settings}
            updateSettings={updateSettings}
          />

          {/* NEW: Class Summary Modal */}
          <ClassSummaryModal
            isOpen={isClassSummaryModalOpen}
            onClose={() => setIsClassSummaryModalOpen(false)}
            students={students}
            assessments={assessments}
            teacherName={teacherName}
          />
        </div>
      );
    };

    // From components/Guidelines.tsx
    const Guidelines = () => {
      const GuidelineBadge = ({ label, color }) => (
        <span className={`px-3 py-1 text-sm font-bold text-white rounded-full ${color}`}>{label}</span>
      );
      return (
        <div>
          <h2 className="text-2xl font-bold text-gray-800 mb-4">PHIL IRI Guidelines</h2>
          <div className="bg-white rounded-lg shadow-md mb-6">
            <div className="px-6 py-4 border-b"><h5 className="text-lg font-semibold mb-0">Reading Level Classification</h5></div>
            <div className="p-4">
              <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50"><tr>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Level</th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Word Recognition</th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Comprehension</th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                  </tr></thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    <tr>
                      <td className="px-4 py-4"><GuidelineBadge label="Independent" color="bg-success" /></td>
                      <td className="px-4 py-4 text-sm">97-100%</td>
                      <td className="px-4 py-4 text-sm">80-100%</td>
                      <td className="px-4 py-4 text-sm">Student reads fluently with minimal errors and demonstrates excellent comprehension.</td>
                    </tr>
                    <tr>
                      <td className="px-4 py-4"><GuidelineBadge label="Instructional" color="bg-primary" /></td>
                      <td className="px-4 py-4 text-sm">90-96%</td>
                      <td className="px-4 py-4 text-sm">59-79%</td>
                      <td className="px-4 py-4 text-sm">Student reads with some difficulty and demonstrates satisfactory comprehension with support.</td>
                    </tr>
                    <tr>
                      <td className="px-4 py-4"><GuidelineBadge label="Frustration" color="bg-warning" /></td>
                      <td className="px-4 py-4 text-sm">89% and below</td>
                      <td className="px-4 py-4 text-sm">58% and below</td>
                      <td className="px-4 py-4 text-sm">Student struggles with reading and has poor comprehension even with support.</td>
                    </tr>
                    <tr>
                      <td className="px-4 py-4"><GuidelineBadge label="Non-Reader" color="bg-danger" /></td>
                      <td className="px-4 py-4 text-sm">0</td>
                      <td className="px-4 py-4 text-sm">0</td>
                      <td className="px-4 py-4 text-sm">Student cannot recognize most words and has very limited comprehension.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div className="bg-white rounded-lg shadow-md">
            <div className="px-6 py-4 border-b"><h5 className="text-lg font-semibold mb-0">Miscue Analysis Guidelines</h5></div>
            <div className="p-6">
              <h5 className="font-semibold mb-2 text-gray-800">Types of Miscues:</h5>
              <ul className="list-disc list-inside space-y-1 text-gray-700 mb-4">
                <li><strong>Substitution:</strong> Replacing a word with another word (e.g., "house" for "home")</li>
                <li><strong>Omission:</strong> Leaving out a word</li>
                <li><strong>Insertion:</strong> Adding a word that is not in the text</li>
                <li><strong>Repetition:</strong> Repeating a word or phrase</li>
                <li><strong>Reversal:</strong> Inverting the order of words or letters</li>
              </ul>
              <h5 className="font-semibold mb-2 text-gray-800">Scoring Guidelines:</h5>
              <p className="text-gray-700">Record each miscue made by the student during oral reading. Analyze whether the miscue changes the meaning of the text. Use the analysis to identify patterns in reading difficulties and plan appropriate interventions.</p>
            </div>
          </div>
        </div>
      );
    };

    // UPDATED: From App.tsx - Added fixed header and sidebar
    const MainApp = () => {
      // NEW: Add storage controls to the header
      const headerRightContent = (
        <div className="absolute right-4 top-4 z-50">
          <StorageControls />
        </div>
      );
      const [activeModule, setActiveModule] = useState(Module.Dashboard);
      const [students, setStudents] = useLocalStorage('echoText-students', sampleStudents);
      const [attendance, setAttendance] = useLocalStorage('echoText-attendance', sampleAttendance);

      const [assessments, setAssessments] = useLocalStorage('echoText-assessments', sampleAssessments);
      const [passages, setPassages] = useLocalStorage('echoText-passages', samplePassages);
      const [teacherName, setTeacherName] = useTeacherName();
      const [showTeacherNameModal, setShowTeacherNameModal] = useState(false);

      // NEW: Use authentication hook
      const { isLoggedIn, currentUser, login, createAccount, logout } = useAuth();

      const handleDeleteStudent = (studentId) => {
        if (window.confirm('Are you sure you want to delete this student? This will also remove all their data.')) {
          setStudents(prev => prev.filter(s => s.id !== studentId));
          setAssessments(prev => {
            const newAssessments = { ...prev };
            delete newAssessments[studentId];
            return newAssessments;
          });
          setAttendance(prev => {
            const newAttendance = { ...prev };
            Object.keys(newAttendance).forEach(week => {
              const weekNum = Number(week);
              if (newAttendance[weekNum]?.[studentId]) {
                delete newAttendance[weekNum][studentId];
              }
            });
            return newAttendance;
          });
        }
      };

      const handleSaveAssessment = (studentId, newAssessment) => {
        setAssessments(prev => {
          const studentAssessments = prev[studentId] || [];
          const existingAssessmentIndex = studentAssessments.findIndex(a => a.week === newAssessment.week);

          let updatedAssessments;
          if (existingAssessmentIndex > -1) {
            updatedAssessments = studentAssessments.map((a, index) => index === existingAssessmentIndex ? newAssessment : a);
          } else {
            updatedAssessments = [...studentAssessments, newAssessment].sort((a, b) => a.week - b.week);
          }

          return {
            ...prev,
            [studentId]: updatedAssessments
          };
        });
      };

      const renderModule = () => {
        switch (activeModule) {
          case Module.Dashboard:
            return <Dashboard students={students} assessments={assessments} attendance={attendance} />;
          case Module.StudentManagement:
            return <StudentManagement students={students} setStudents={setStudents} onDeleteStudent={handleDeleteStudent} />;
          case Module.Attendance:
            return <AttendanceComponent students={students} attendance={attendance} setAttendance={setAttendance} />;
          case Module.ReadingAssessment:
            return <ReadingAssessment students={students} passages={passages} setPassages={setPassages} onSaveAssessment={handleSaveAssessment} teacherName={teacherName} />;
          case Module.Comprehension:
            return <ComprehensionQuiz students={students} teacherName={teacherName} />;
          case Module.Results:
            return <Results students={students} assessments={assessments} teacherName={teacherName} />;
          case Module.Guidelines:
            return <Guidelines />;
          case Module.Vocabulary: // NEW: Added Vocabulary module
            return <VocabularyPractice />;
          case Module.Prosody: // NEW: Added Prosody module
            return <ProsodyPractice students={students} passages={passages} />;
          case Module.ReadingDrill: // NEW: Added Reading Drill module
            return <ReadingDrill />;
          default:
            return <div className="p-6 bg-white rounded-lg shadow-md"><h2 className="text-2xl font-bold text-gray-800">Under Construction</h2><p>This module is under construction.</p></div>;
        }
      };

      // Show teacher name modal on first load if teacher name is not set
      useEffect(() => {
        if (isLoggedIn && !teacherName) {
          setShowTeacherNameModal(true);
        }
      }, [isLoggedIn, teacherName]);

      // Show login page if not logged in
      if (!isLoggedIn) {
        return (
          <LoginPage
            onLogin={login}
            onCreateAccount={createAccount}
          />
        );
      }

      return (
        <div className="min-h-screen flex flex-col relative">
          {headerRightContent}
          <header className="fixed-header login-gradient text-white shadow-md w-full">
            <div className="container mx-auto px-4">
              <div className="flex justify-between items-center py-3">
                <div className="flex items-center gap-3">
                  <BookReaderIcon className="w-8 h-8" />
                  <h1 className="text-xl font-bold">EchoText: Where TEXT is ECHOED as Voice</h1>
                </div>
                <div className="flex items-center gap-2 text-sm">
                  <UserIcon className="w-5 h-5" />
                  <span>Welcome, {currentUser?.username || 'Teacher'}</span>
                  {/* UPDATED: Set Teacher Name Button with Gradient */}
                  <button
                    onClick={() => setShowTeacherNameModal(true)}
                    className="ml-2 px-3 py-1 text-sm teacher-name-gradient rounded-md transition-all duration-300"
                  >
                    {teacherName || 'Set Name'}
                  </button>
                  <button
                    onClick={logout}
                    className="ml-2 px-3 py-1 text-sm bg-danger text-white rounded-md hover:bg-red-600 transition-all duration-300"
                  >
                    Logout
                  </button>
                </div>
              </div>
            </div>
          </header>
          <div className="flex flex-1" style={{ height: 'calc(100vh - 60px)' }}>
            <Sidebar activeModule={activeModule} setActiveModule={setActiveModule} />
            <main className="main-content p-6 bg-gray-100 overflow-y-auto">
              {renderModule()}
            </main>
          </div>
          <TeacherNameModal
            isOpen={showTeacherNameModal}
            onClose={() => setShowTeacherNameModal(false)}
            teacherName={teacherName}
            setTeacherName={setTeacherName}
          />
        </div>
      );
    };

    const App = () => (
      <StorageProvider>
        <MainApp />
      </StorageProvider>
    );

    // From index.tsx
    const rootElement = document.getElementById('root');
    if (!rootElement) {
      throw new Error("Could not find root element to mount to");
    }

    const root = ReactDOM.createRoot(rootElement);
    root.render(
      <StrictMode>
        <App />
      </StrictMode>
    );
  </script>
</body>

</html>
